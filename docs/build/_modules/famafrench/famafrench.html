

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>famafrench.famafrench &mdash; famafrench 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> famafrench
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../whatsnew/whatsnew.html">What's New?!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/gettingstarted.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/gettingstarted.html#creating-an-instance-of-the-famafrench-class">Creating an Instance of the <code class="docutils literal notranslate"><span class="pre">FamaFrench</span></code> Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications/applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wrdsconnection/wrdsconnection.html">Connecting to the WRDS cloud server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../wrdscloudquery/wrdscloudquery.html">WRDS Query Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../portfolios/factorregressions.html">Estimating Market Betas and Rolling Residual Variances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../portfolios/portfoliosorting.html">Constructing Portfolios and Return-Based Factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kflibrary/kflibrary.html">Comparing to Ken French's Online Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics-diagnostics/statistics.html">Summary Statistics and Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils/utils.html">Auxiliary Functions and Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">famafrench</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>famafrench.famafrench</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for famafrench.famafrench</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main module.</span>

<span class="sd">Descriptions</span>
<span class="sd">____________</span>
<span class="sd">Error</span>
<span class="sd">    General error validation object class</span>
<span class="sd">FamaFrench</span>
<span class="sd">    Object parent class w/ methods and attributes needed for constructing Fama-French-style</span>
<span class="sd">    portfolio returns, anomaly-based factors, and portfolio anomaly characteristics.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Christian Jauregui &lt;chris.jauregui@berkeley.edu&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;FamaFrench&quot;</span><span class="p">]</span>

<span class="c1"># Standard Imports</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">sub</span><span class="p">,</span> <span class="nb">compile</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>  <span class="c1"># warn/error if taking np.log() if non-positive number.</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="s1">&#39;raise&#39;</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">use_inf_as_na</span> <span class="o">=</span> <span class="kc">True</span>
<span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="nn">web</span>
<span class="kn">from</span> <span class="nn">pandas_datareader._utils</span> <span class="kn">import</span> <span class="n">RemoteDataError</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>

<span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">pandas_market_calendars</span> <span class="k">as</span> <span class="nn">mcal</span>
<span class="n">nyse_cal</span> <span class="o">=</span> <span class="n">mcal</span><span class="o">.</span><span class="n">get_calendar</span><span class="p">(</span><span class="s1">&#39;NYSE&#39;</span><span class="p">)</span>

<span class="c1"># Reloads the .env file in your home directory.</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="n">load_dotenv</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">famafrench</span> <span class="kn">import</span> <span class="n">wrdsconnect</span> <span class="k">as</span> <span class="n">wrds</span>
<span class="n">reload</span><span class="p">(</span><span class="n">wrds</span><span class="p">)</span>

<span class="c1"># import &#39;utils&#39; module w/ auxilary functions</span>
<span class="kn">from</span> <span class="nn">famafrench</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="c1"># Establish remote connection to wrds-cloud using user-defined class adjusted from the &#39;WRDS-Py&#39; library</span>
<span class="k">if</span> <span class="s1">&#39;wrdsConn&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;wrds-cloud connection already open!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">wrdsConn</span> <span class="o">=</span> <span class="n">wrds</span><span class="o">.</span><span class="n">wrdsConnection</span><span class="p">()</span>


<span class="c1"># Declare &#39;Error&quot; object child class for error validation</span>
<span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    General-purpose error validation class.</span>
<span class="s2">    </span>
<span class="s2">    Note</span>
<span class="s2">    ____</span>
<span class="s2">    This class is not documented in the main (online) documentation since it is sparingly used </span>
<span class="s2">    and because it is an auxiliary class.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span>


<span class="c1"># Declare &#39;FamaFrench&#39; object parent class</span>
<div class="viewcode-block" id="FamaFrench"><a class="viewcode-back" href="../../gettingstarted/generated/famafrench.FamaFrench.html#famafrench.FamaFrench">[docs]</a><span class="k">class</span> <span class="nc">FamaFrench</span><span class="p">:</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Class providing tools for constructing and replicating datasets from </span>
<span class="s2">    `Ken French&#39;s online library &lt;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html&gt;`_ </span>
<span class="s2">    via queries to CRSP, Compustat Fundamentals, and other sources accessed through </span>
<span class="s2">    `wrds-cloud &lt;https://wrds-www.wharton.upenn.edu/&gt;`_.   </span>
<span class="s2">        </span>
<span class="s2">    Attributes</span>
<span class="s2">    -----------    </span>
<span class="s2">    runQuery: bool</span>
<span class="s2">        Flag for choosing whether to query datafiles from `wrds-cloud &lt;https://wrds-www.wharton.upenn.edu/&gt;`_ or import locally-pickled files. </span>
<span class="s2">    freqType: str </span>
<span class="s2">        Observation frequency of the portfolios. Possible choices are    </span>
<span class="s2">            </span>
<span class="s2">            * ``D`` : daily</span>
<span class="s2">            * ``W`` : weekly</span>
<span class="s2">            * ``M`` : monthly</span>
<span class="s2">            * ``Q`` : quarterly (3-months)</span>
<span class="s2">            * ``A`` : annual</span>
<span class="s2">    sortCharacsId: list, str</span>
<span class="s2">        Names of the anomaly characteristics used for portfolio sorting. The list will contain one, two, or three elements. </span>
<span class="s2">        The order of the elements matters and should be consistent w/ the orders presented in </span>
<span class="s2">        `Ken French&#39;s online library &lt;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html&gt;`_. </span>
<span class="s2">        Possible choices are:</span>
<span class="s2">            </span>
<span class="s2">            * ``ME`` : Size</span>
<span class="s2">            * ``BE`` : Book equity</span>
<span class="s2">            * ``BM`` : Book-to-Market equity</span>
<span class="s2">            * ``OP`` : Operating Profitability</span>
<span class="s2">            * ``INV`` : Investment</span>
<span class="s2">            * ``EP`` : Earnings/Price</span>
<span class="s2">            * ``CFP`` : Cashflow/Price</span>
<span class="s2">            * ``DP`` : Dividend Yield (i.e. Dividends/Price)</span>
<span class="s2">            * ``PRIOR_2_12`` : Prior (2-12) Returns</span>
<span class="s2">            * ``PRIOR_1_1`` : Prior (1-1) Returns</span>
<span class="s2">            * ``PRIOR_60_13`` : Prior (13-60) Returns</span>
<span class="s2">            * ``AC`` : Accruals</span>
<span class="s2">            * ``BETA`` : Market Beta (estimated using the Scholes-Williams (1977) methodology)</span>
<span class="s2">            * ``VAR`` : Variance (Daily and calculated using last 60 days (w/ 20 minimum)</span>
<span class="s2">            * ``RESVAR`` : Fama-French Three-factor model Residual Variance  (Daily and calculated using last 60 days (w/ 20 minimum)</span>
<span class="s2">            * ``NI`` : Net Share Issues  </span>
<span class="s2">    factorsId: None or list, str</span>
<span class="s2">        Names of the anomaly/risk-based factors following Fama and French (1992, 1993, 2008, 2015, 2017). </span>
<span class="s2">        Possible choices are:</span>
<span class="s2">        </span>
<span class="s2">            * ``MKT-RF`` : Market premium</span>
<span class="s2">            * ``SMB`` : Small Minus Big</span>
<span class="s2">            * ``HML`` : High Minus Low</span>
<span class="s2">            * ``RMW`` : Robust Minus Weak</span>
<span class="s2">            * ``RMWc`` : Cash-based Robust Minus Weak (**Todo**)</span>
<span class="s2">            * ``CMA`` : Conservative Minus Aggressive</span>
<span class="s2">            * ``MOM`` : Momentum - based on Prior (2-12) returns</span>
<span class="s2">            * ``ST_Rev`` : Short-Term Reversal - based on Prior (1-1) returns</span>
<span class="s2">            * ``LT_Rev`` : Long-Term Reversal - based on Prior (13-60) returns</span>
<span class="s2">    mainCharacsId: None or list, str,  default None</span>
<span class="s2">         Names of the anomaly characteristics computed as averages for each portfolio bucket and constructed using the list ``sortCharacsId``.</span>
<span class="s2">         If *None*, ``mainCharacsI`` is set to the list ``sortCharacsId``.</span>
<span class="s2">    runEstimation: bool, default False</span>
<span class="s2">        Flag for choosing whether to run any estimation procedures for the first time/re-estimate procedures </span>
<span class="s2">        by querying `wrds-cloud &lt;https://wrds-www.wharton.upenn.edu/&gt;`_ datafiles</span>
<span class="s2">        `or` import locally-pickled files storing existing estimates.   </span>
<span class="s2">    pickled_directory :  str, default `</span><span class="se">\&#39;</span><span class="s2">./famafrench/pickled_db/</span><span class="se">\&#39;</span><span class="s2">`</span>
<span class="s2">        Local directory extention where pickled datasets will be saved to. </span>
<span class="s2">    runFactorReg : bool, default True</span>
<span class="s2">        Flag for initializing the estimation of market beta&#39;s and/or rolling residual variances required </span>
<span class="s2">        for sorting portfolios on ``BETA`` and/or ``RESVAR``. </span>
<span class="s2">        This boolean is set internally - no need for user to specify it externally. </span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># Constructor for the &#39;FamaFrench&#39; object parent class</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runQuery</span><span class="p">,</span> <span class="n">freqType</span><span class="p">,</span> <span class="n">sortCharacsId</span><span class="p">,</span> <span class="n">factorsId</span><span class="p">,</span> <span class="n">mainCharacsId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runEstimation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pickled_directory</span><span class="o">=</span><span class="s1">&#39;./famafrench/pickled_db/&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for the &#39;FamaFrench&#39; object parent class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span> <span class="o">=</span> <span class="n">freqType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span> <span class="o">=</span> <span class="n">sortCharacsId</span>
        <span class="k">if</span> <span class="n">mainCharacsId</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span> <span class="o">=</span> <span class="n">mainCharacsId</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span> <span class="o">=</span> <span class="n">factorsId</span>

        <span class="c1"># NOTE: The following is required if &#39;BETA&#39;, &#39;RESVAR&#39; are in the list &#39;sortCharacsId&#39;:</span>
        <span class="c1"># Initialize Boolean attribute needed to iteratively estimate market betas and/or residual variances:</span>
        <span class="c1"># NOTE: Need to set to &#39;True&#39; when running an object&#39;s methods more than ONCE!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># NOTE: A &quot;temporary&quot; list of the factor variables is created for special cases in which all</span>
        <span class="c1"># the Fama-French 3 or 5 factors are needed in estimation or output results.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">factorsId</span><span class="p">)</span>

        <span class="c1"># NOTE: The following boolean attributes are needed if the user wants to query directly from wrds-cloud</span>
        <span class="c1"># instead of using locally saved files to pickle or if the user wants to re-estimate factor regressions,</span>
        <span class="c1"># when applicable.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="o">=</span> <span class="n">runQuery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runEstimation</span> <span class="o">=</span> <span class="n">runEstimation</span>

        <span class="c1"># Pickled datasets are saved in a local directory w/ the given name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">=</span> <span class="n">pickled_directory</span>


<div class="viewcode-block" id="FamaFrench.queryComp"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.queryComp.html#famafrench.FamaFrench.queryComp">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">queryComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query Compustat Fundamentals Annual files from `wrds-cloud`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        dt_start: datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end: datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfcomp: pandas.DataFrame</span>
<span class="sd">            Dataset containing Compustat data cleaned from `wrds-cloud` queries.</span>
<span class="sd">        dfcomp_list: list, str</span>
<span class="sd">            Names of the anomaly portfolio characteristics computed from Compustat Fundamentals Annuals.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        Following `Fama and French &lt;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html&gt;`_:</span>

<span class="sd">            *  `Book Equity` is calculated as follows: `book value of stockholders’ equity`</span>
<span class="sd">               + `balance sheet deferred taxes and investment tax credit (if available)`</span>
<span class="sd">               - `the book value of preferred stock`.</span>
<span class="sd">               Depending on availability, use the redemption, liquidation, or par value</span>
<span class="sd">               (in that order) to estimate the `book value of preferred stock` **ps**.</span>

<span class="sd">            *  `Stockholders’ equity` is the value reported by Moody’s or Compustat, if it is available.</span>
<span class="sd">               If not, measure `book value of stockholders’ equity` as the book value of common equity</span>
<span class="sd">               plus the par value of preferred stock, or the book value of assets minus total liabilities (in that order).</span>

<span class="sd">            * We must flag for number of years in Compustat (less than two years are likely backfilled data)</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        List of Compustat Fundamentals Annual (XpressFeed) variables:</span>

<span class="sd">            - **gvkey**    : Unique permanent identifier assigned by Compustat at the company-level</span>
<span class="sd">            - **datadate** : Reporting date for data record</span>
<span class="sd">            - **indfmt**   : Item used to identify whether a company reports in a &quot;Financial Services&quot; or &quot;Industrial&quot; format</span>
<span class="sd">            - **datafmt**  : Item indicating how the company&#39;s data is collected and presented</span>
<span class="sd">            - **popsrc**   : Item indicating whether source of the data is domestic or international</span>
<span class="sd">            - **consol**   : Item used to identify whether a company&#39;s financials represent consolidate or nonconsolidated information</span>
<span class="sd">            - **at**       : Total Assets</span>
<span class="sd">            - **lt**       : Total Liabilities</span>
<span class="sd">            - **ceq**      : Total Common/Ordinary Equity = [Common/Ordinary Stock (Capital) + Capital Surplus/Share Premium Reserve + Retained Earnings - Total Treasury Stock (All Capital)] (= **cstk** + **caps** + **re** - **tstk**)</span>
<span class="sd">            - **seq**      : Parent&#39;s Stockholders Equity (= **ceq** + **pstk**)</span>
<span class="sd">            - **pstkrv**   : Redemption Value of Preferred Stock</span>
<span class="sd">            - **pstkl**    : Liquidating Value of Preferred Stock</span>
<span class="sd">            - **pstk**     : Total Preferred/Preference Stock (Capital) = [Redeemable Preferred/Preference Stock + Nonredeemable Preferred/Preference Stock] (= **pstkr** + **pstkn**)</span>
<span class="sd">            - **txdb**     : Deferred Taxes (Balance Sheet)</span>
<span class="sd">            - **itcb**     : Investment Tax Credit (Balance Sheet)</span>
<span class="sd">            - **txditc**   : Deferred Taxes and Investment Tax Credit (= **txdb** + **itcb**)</span>
<span class="sd">            - **revt**     : Total Revenue</span>
<span class="sd">            - **cogs**     : Cost of Goods Sold</span>
<span class="sd">            - **xint**     : Total Interest and Related Expense</span>
<span class="sd">            - **xsga**     : Selling, General and Administrative Expense</span>
<span class="sd">            - **mib**      : Non-controlling/Minority Interest (Balance Sheet)</span>
<span class="sd">            - **ib**       : Income Before Extraordinary Items</span>
<span class="sd">            - **txdi**     : Deferred Income Taxes</span>
<span class="sd">            - **dp**       : Depreciation and Amortization</span>
<span class="sd">            - **chso**     : Common Shares Outstanding</span>
<span class="sd">            - **adjex_f**  : Fiscal-Year, Cumulative Adjustment Factor by Ex-Date</span>
<span class="sd">            - **act**      : Total Current Assets</span>
<span class="sd">            - **lct**      : Total Current Liabilities</span>
<span class="sd">            - **che**      : Cash and Short-Term Investments</span>
<span class="sd">            - **dlc**      : Total Debt in Current Liabilities</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        Depending on a user&#39;s WRDS subscription, data variables will be queried from the most frequently updated</span>
<span class="sd">        Compustat datafiles. Compustat offers daily, monthly, and annually updated files for annual observations.</span>
<span class="sd">        The **default** datafiles are updated monthly. See `wrds-cloud` SAS Library Names below:</span>

<span class="sd">            - ``compd`` : dataset `Compustat - NA, Bank, Global - Daily Update`</span>
<span class="sd">            - ``compm`` : dataset `Compustat - NA - Monthly Update`</span>
<span class="sd">            - ``compa`` : dataset `Compustat - NA - Annual Update`</span>
<span class="sd">            - ``comp`` : **default** dataset `Compustat - NA, Bank, Global, Execucomp - Monthly Update`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">),</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_comp_sqlQuery</span><span class="p">(</span><span class="n">wrds_update</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create SQL query string for Compustat Fundamentals Annuals datafiles.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            wrds_update : str</span>
<span class="sd">            start_date : datetime.date</span>
<span class="sd">            end_date : datetime.date</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            comp_sqlQuery : str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
                <span class="n">compdb</span> <span class="o">=</span> <span class="s1">&#39;compd.funda&#39;</span>
            <span class="k">elif</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
                <span class="n">compdb</span> <span class="o">=</span> <span class="s1">&#39;compm.funda&#39;</span>
            <span class="k">elif</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">compdb</span> <span class="o">=</span> <span class="s1">&#39;comp.funda&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compdb</span> <span class="o">=</span> <span class="s1">&#39;compa.funda&#39;</span>
            <span class="n">comp_sql</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;compDb&#39;</span><span class="p">:</span> <span class="n">compdb</span><span class="p">,</span>
                        <span class="s1">&#39;compIndFmt&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">INDL</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;compDataFmt&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">STD</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;compStartDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">start_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;compEndDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">end_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">}</span>

            <span class="n">comp_sqlQuery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                             SELECT gvkey, EXTRACT(YEAR FROM datadate) AS year, datadate, fyear, </span>
<span class="s2">                             at, lt, ceq, seq, pstkrv, pstkl, pstk, txdb, itcb, txditc, </span>
<span class="s2">                             revt, cogs, xint, xsga, mib, ib, txdi, dp AS depr, csho, adjex_f, act, lct, che, dlc</span>
<span class="s2">                                FROM </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                                WHERE indfmt = </span><span class="si">{1}</span><span class="s2"></span>
<span class="s2">                                AND datafmt = </span><span class="si">{2}</span><span class="s2"></span>
<span class="s2">                                AND popsrc =&#39;D&#39;</span>
<span class="s2">                                AND consol =&#39;C&#39;</span>
<span class="s2">                                AND datadate BETWEEN </span><span class="si">{3}</span><span class="s2"> AND </span><span class="si">{4}</span><span class="s2"></span>
<span class="s2">                            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_sql</span><span class="p">[</span><span class="s1">&#39;compDb&#39;</span><span class="p">],</span>
                                       <span class="n">comp_sql</span><span class="p">[</span><span class="s1">&#39;compIndFmt&#39;</span><span class="p">],</span>
                                       <span class="n">comp_sql</span><span class="p">[</span><span class="s1">&#39;compDataFmt&#39;</span><span class="p">],</span>
                                       <span class="n">comp_sql</span><span class="p">[</span><span class="s1">&#39;compStartDate&#39;</span><span class="p">],</span>
                                       <span class="n">comp_sql</span><span class="p">[</span><span class="s1">&#39;compEndDate&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">comp_sqlQuery</span>

        <span class="c1"># Load local file if it exists (and dates can be found), else query from wrds-cloud.</span>
        <span class="n">comp_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="s1">&#39;annual/comp_annual.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">comp_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">comp_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">year_min</span><span class="p">,</span> <span class="n">year_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">year_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">year</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Compustat (annual) dataset currently NOT saved locally w/ required dates. Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                <span class="c1"># Query missing observations BEFORE &#39;year_min&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">dt_start</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_min</span><span class="p">:</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">date_min</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcomp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfcomp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dfcomp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                            <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                                <span class="n">dfcomp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>

                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">year</span><span class="p">)]</span>
                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">comp_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcomp_pre</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcomp_pre</span>
                    <span class="k">del</span> <span class="n">lst</span>
                <span class="c1"># Query missing observations AFTER &#39;year_max&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">year_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
                    <span class="n">startdate</span> <span class="o">=</span> <span class="n">date_max</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcomp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfcomp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">dfcomp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                            <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                                <span class="n">dfcomp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>

                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[(</span><span class="n">dt_start</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])]</span>
                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcomp_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
                        <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">comp_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcomp_post</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcomp_post</span>
                    <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Compustat (annual) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[(</span><span class="n">dt_start</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">year</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Compustat (annual) dataset currently NOT saved locally. Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_comp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">comp_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Replace any Python objects &#39;None&#39; to np.nan</span>
        <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Get datetime objects...</span>
        <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">])</span>

        <span class="n">dfcomp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;BE&#39;</span><span class="p">,</span> <span class="s1">&#39;BM&#39;</span><span class="p">,</span> <span class="s1">&#39;OP&#39;</span><span class="p">,</span> <span class="s1">&#39;AC&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))</span> \
                <span class="ow">or</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;HML&#39;</span><span class="p">,</span> <span class="s1">&#39;RMW&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">))):</span>
            <span class="c1"># Create &quot;preferred stock&quot; - &#39;ps&#39; - according to Fama and French (1993);</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;pstkrv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;pstkl&#39;</span><span class="p">],</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;pstkrv&#39;</span><span class="p">])</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;pstk&#39;</span><span class="p">],</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">])</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">])</span>

            <span class="c1"># Create &quot;deferred taxes and investment tax credit&quot; - &#39;dtaxes_ic&#39;:</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;dtaxes_ic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;txditc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;txdb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;itcb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;txditc&#39;</span><span class="p">])</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;dtaxes_ic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;dtaxes_ic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;dtaxes_ic&#39;</span><span class="p">])</span>

            <span class="c1"># Create &quot;book equity&quot; - &#39;be&#39; - following Fama and French (1993):</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;bseq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ceq&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;pstk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">])</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;bseq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;bseq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;lt&#39;</span><span class="p">],</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;bseq&#39;</span><span class="p">])</span>

            <span class="c1"># NOTE: Because of changes in the treatment of deferred taxes described in FASB 109,</span>
            <span class="c1">#       files produced by Ken French after August 2016 no longer add</span>
            <span class="c1">#       Deferred Taxes and Investment Tax Credit to &#39;be&#39; for fiscal years ending in 1993 or later.</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;fyear&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1993</span><span class="p">),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;bseq&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;dtaxes_ic&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">],</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;bseq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">])</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;be&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;OP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span> <span class="s1">&#39;CMA&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">)))):</span>
            <span class="c1"># Create &quot;operating profitability&quot; - &#39;op&#39; - following Fama and French (2015):</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="c1"># NOTE: &#39;op&#39; uses annual revenues minus costs of goods &#39;cogs&#39;, interest expense &#39;xint&#39;, as well as</span>
            <span class="c1">#        selling, and general, and administrative expenses &#39;xsga&#39; at the end of fiscal year {t-1}</span>
            <span class="c1">#        divided by (book equity &#39;be&#39; at the end of fiscal year {t-1}</span>
            <span class="c1">#        plus minority interest &#39;mib&#39; at the end of fiscal year {t-1})</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;xint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;cogs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;xint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;xsga&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;mib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">]),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># NOTE: Compustat data yields gross outliers in &#39;op&#39; w/ ratios as large as &#39;1,000&#39;.</span>
            <span class="c1">#       To be consistent w/ summary statistics for characteristics provided by Ken French&#39;s online library,</span>
            <span class="c1">#       values for &#39;op&#39; outside the 99th percentile are set to missing.</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">)),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;op&#39;</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;revt&#39;</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;INV&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span> <span class="s1">&#39;CMA&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">)))):</span>
            <span class="c1"># Create &quot;asset growth (i.e. investment)&quot; - &#39;inv&#39; following Fama and French (2015):</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfcomp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])[</span><span class="s1">&#39;at&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="c1"># NOTE: Compustat data yields gross outliers in &#39;inv&#39; w/ percentages as low as &#39;-100%&#39; and as large as &#39;10,000%&#39;.</span>
            <span class="c1">#       These outliers are pervasive on the left tail of the distribution.</span>
            <span class="c1">#       To be consistent w/ summary statistics for characteristics provided by Ken French&#39;s online library,</span>
            <span class="c1">#       values for &#39;inv&#39; outside [15th, 99th] percentiles are winsorized.</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">],</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.15</span><span class="p">))</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">)),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">],</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">))</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;inv&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;EP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ib&#39;</span><span class="p">)</span>  <span class="c1"># &#39;ib&#39; is income before taxes or &quot;earnings&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;CFP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Create &quot;cash flow&quot; - &#39;cf&#39; - following Fama and French (2015):</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;txdi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;depr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cf&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;AC&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Create &quot;accruals&quot; - &#39;ac&#39; - following Fama and French (2015):</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;csho_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;adjex_f&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;adjex_f&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;owcap_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;act&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;che&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;lct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;dlc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="o">/</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;csho_adj&#39;</span><span class="p">]</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;d_owcap_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;owcap_adj&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])[</span><span class="s1">&#39;owcap_adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;d_owcap_adj&#39;</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;csho_adj&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;NI&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Create &quot;net income shares&quot; - &#39;ni&#39; - following Fama and French (2015):</span>
            <span class="c1"># SOURCE: http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni_csho_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;adjex_f&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;csho&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;adjex_f&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni_csho_adj&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfcomp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])[</span><span class="s1">&#39;ni_csho_adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni_csho_adj&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])[</span><span class="s1">&#39;ni_csho_adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="c1"># NOTE: Compustat data yields outliers in &#39;ni&#39; w/ ratios as large as &#39;20&#39;.</span>
            <span class="c1">#       To be consistent w/ summary statistics for characteristics provided by Ken French&#39;s online library,</span>
            <span class="c1">#       values for &#39;ni&#39; outside the 99.9th percentile are set to missing.</span>
            <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.999</span><span class="p">)),</span> <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dfcomp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ni&#39;</span><span class="p">)</span>

        <span class="c1"># Obtain the number of years in Compustat:</span>
        <span class="n">dfcomp</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>

        <span class="c1"># Sub-select required &#39;dfcomp&#39; columns:</span>
        <span class="n">dfcomp</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dfcomp</span><span class="p">,</span> <span class="n">dfcomp_list</span></div>


<div class="viewcode-block" id="FamaFrench.queryCrsp"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.queryCrsp.html#famafrench.FamaFrench.queryCrsp">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">queryCrsp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query CRSP Stock/Security files from `wrds-cloud`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfcrsp : pandas.DataFrame</span>
<span class="sd">            Cleaned CRSP data queried from `wrds-cloud` w/ observations at frequency ``freq`` over sample period from ``dt_start`` to ``dt_end``.</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        List of queried CRSP variables:</span>

<span class="sd">            - **permno**   : Unique permanent identifier assigned by CRSP at the security-level</span>
<span class="sd">            - **permco**   : Unique permanent identifier assigned by CRSP at the company-level</span>
<span class="sd">            - **date**     : Trading day</span>
<span class="sd">            - **shrcd**    : 2-digit code describing the type of shares traded</span>
<span class="sd">            - **exchcd**   : Code indicating the exchange on which security is listed</span>
<span class="sd">            - **ret**      : Holding period return w dividends</span>
<span class="sd">            - **retx**     : Holding period return w/out dividends</span>
<span class="sd">            - **shrout**   : Number of publicly held shares (thousands)</span>
<span class="sd">            - **prc**      : Closing price or negative bid/ask average for a trading day</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        Depending on a user&#39;s WRDS subscription, data variables will be queried from the most frequently updated</span>
<span class="sd">        CRSP datafiles. CRSP offers monthly, quarterly, and annually updated files for both daily and monthly observations.</span>
<span class="sd">        The **default** datafiles are updated annually. See `wrds-cloud` SAS Library Names below:</span>

<span class="sd">            - ``crspm`` : dataset `CRSP Monthly Update`</span>
<span class="sd">            - ``crspq`` : dataset `CRSP Quarterly Update`</span>
<span class="sd">            - ``crspa`` : **default** dataset `CRSP Annual Update`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Since monthly observations have a date ending on the last day of each month, then for any &#39;dt_start&#39; that doesn&#39;t</span>
        <span class="c1"># coincide w/ the last day of any month, we adjust it so it does and the query pulls the monthly observation of interest.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dt_start</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dt_end</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">),</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_crsp_sqlQuery</span><span class="p">(</span><span class="n">wrds_update</span><span class="p">,</span> <span class="n">freqTypeFullstr</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create SQL query string for CRSP stock datafiles.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            wrds_update : str</span>
<span class="sd">            freqTypeFullstr : str</span>
<span class="sd">            start_date : datetime.date</span>
<span class="sd">            end_date : datetime.date</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            crsp_sqlQuery : str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspm.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFullstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;sf&#39;</span>
                <span class="n">crspnames</span> <span class="o">=</span> <span class="s1">&#39;crspm.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFullstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;senames&#39;</span>
            <span class="k">elif</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;quarterly&#39;</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspq.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFullstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;sf&#39;</span>
                <span class="n">crspnames</span> <span class="o">=</span> <span class="s1">&#39;crspq.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFullstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;senames&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspa.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFullstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;sf&#39;</span>
                <span class="n">crspnames</span> <span class="o">=</span> <span class="s1">&#39;crspa.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFullstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;senames&#39;</span>
            <span class="n">crsp_sql</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;crspDb&#39;</span><span class="p">:</span> <span class="n">crspdb</span><span class="p">,</span>
                        <span class="s1">&#39;crspNames&#39;</span><span class="p">:</span> <span class="n">crspnames</span><span class="p">,</span>
                        <span class="s1">&#39;crspStartDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">start_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;crspEndDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">end_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">}</span>

            <span class="n">crsp_sqlQuery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            SELECT CAST(a.permno AS INT), CAST(a.permco AS INT), a.date, CAST(b.shrcd AS INT), </span>
<span class="s2">                            CAST(b.exchcd AS INT), a.ret, a.retx, a.shrout, a.prc</span>
<span class="s2">                                FROM </span><span class="si">{0}</span><span class="s2"> AS a</span>
<span class="s2">                                LEFT JOIN </span><span class="si">{1}</span><span class="s2"> AS b</span>
<span class="s2">                                ON a.permno = b.permno</span>
<span class="s2">                                AND b.namedt &lt;= a.date</span>
<span class="s2">                                AND a.date &lt;= b.nameendt</span>
<span class="s2">                                WHERE a.date BETWEEN </span><span class="si">{2}</span><span class="s2"> AND </span><span class="si">{3}</span><span class="s2"></span>
<span class="s2">                                AND b.exchcd BETWEEN 1 AND 3</span>
<span class="s2">                            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crsp_sql</span><span class="p">[</span><span class="s1">&#39;crspDb&#39;</span><span class="p">],</span>
                                       <span class="n">crsp_sql</span><span class="p">[</span><span class="s1">&#39;crspNames&#39;</span><span class="p">],</span>
                                       <span class="n">crsp_sql</span><span class="p">[</span><span class="s1">&#39;crspStartDate&#39;</span><span class="p">],</span>
                                       <span class="n">crsp_sql</span><span class="p">[</span><span class="s1">&#39;crspEndDate&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">crsp_sqlQuery</span>

        <span class="c1"># Load local file if it exists (and dates can be found), else query from wrds-cloud.</span>
        <span class="n">crsp_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/crsp_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">crsp_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. &#39;</span>
                                                 <span class="s1">&#39;Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">date_min</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcrsp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfcrsp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span>
                                <span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                            <span class="n">dfcrsp_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcrsp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsp</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsp_pre</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcrsp_pre</span>
                    <span class="k">del</span> <span class="n">lst</span>
                <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                    <span class="n">startdate</span> <span class="o">=</span> <span class="n">date_max</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcrsp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfcrsp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                            <span class="n">dfcrsp_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])]</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcrsp_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsp</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsp_post</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcrsp_post</span>
                    <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsp_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsp</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Get datetime objects...</span>
        <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">})</span>

        <span class="c1"># Convert trading dates to end-of-month, if &#39;freq&#39; does not pertain to daily or weekly frequency.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">dfcrsp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;shrcd&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="n">dfcrsp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;shrcd&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dfcrsp</span></div>



<div class="viewcode-block" id="FamaFrench.queryCrspdlret"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.queryCrspdlret.html#famafrench.FamaFrench.queryCrspdlret">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">queryCrspdlret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query CRSP&#39;s Stock Event - Delisting files on `wrds-cloud`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfcrsp_full : pandas.DataFrame</span>
<span class="sd">            Dataset constructed by merging CRSP stock/security dataset w/</span>
<span class="sd">            CRSP delisted returns information.</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        List of queried CRSP Delisting variables:</span>

<span class="sd">            - **permno**   : Unique permanent identifier assigned by CRSP at the security-level</span>
<span class="sd">            - **dlret**    : Return (w/ dividends) of the security after being delisted</span>
<span class="sd">            - **dlretx**   : Return (w/out dividends) of the security after being delisted</span>
<span class="sd">            - **dlstdt**   : 3-digit integer code indicating whether security is still trading or the specific reason why it was delisted.</span>
<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        Depending on a user&#39;s WRDS subscription, delisted data variables will be queried from the most frequently updated</span>
<span class="sd">        CRSP datafiles. CRSP offers monthly, quarterly, and annually updated files for daily observations.</span>
<span class="sd">        The **default** datafiles are updated annually. See `wrds-cloud` SAS Library Names below:</span>

<span class="sd">            - ``crspm`` : dataset `CRSP Monthly Update`</span>
<span class="sd">            - ``crspq`` : dataset `CRSP Quarterly Update`</span>
<span class="sd">            - ``crspa`` : **default** dataset `CRSP Annual Update`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfcrsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryCrsp</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>

        <span class="k">def</span> <span class="nf">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="n">wrds_update</span><span class="p">,</span> <span class="n">freqType</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create SQL query string for CRSP delisted datafiles.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            wrds_update : str</span>
<span class="sd">            freqType : str</span>
<span class="sd">            crspdlret_sqlQuery: str</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            crspdlret_sqlQuery : str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">freqType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>

            <span class="k">if</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspm.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;sedelist&#39;</span>
            <span class="k">elif</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;quarterly&#39;</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspq.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;sedelist&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspa.&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;sedelist&#39;</span>
            <span class="n">crspdlret_sqlQuery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                SELECT CAST(permno AS INT), dlret, dlretx, dlstdt </span>
<span class="s2">                                    FROM </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crspdb</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">crspdlret_sqlQuery</span>

        <span class="c1"># Load local file if it exists (and dates can be found), else query from wrds-cloud.</span>
        <span class="n">crspdlret_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/crspdelist_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">crspdlret_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crspdlret_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP delisted returns (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. &#39;</span>
                                                                  <span class="s1">&#39;Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>
                <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crspdlret_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrspdlret</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP delisted returns (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">dfcrspdlret</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP delisted returns (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally. Querying from wrds-cloud...&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                    <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crspdlret_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">))</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crspdlret_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrspdlret</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Get datetime objects...</span>
        <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">])</span>

        <span class="c1"># Convert trading dates to end-of-period, if &#39;freq&#39; does not pertain to daily or weekly frequency.</span>
        <span class="n">dfcrspdlret</span> <span class="o">=</span> <span class="n">dfcrspdlret</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcrspdlret</span><span class="p">[</span><span class="s1">&#39;dlstdt&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Merge CRSP stock returns w/ CRSP delisted returns.</span>
        <span class="n">dfcrsp_full</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcrspdlret</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;DP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="n">dfcrsp_full</span><span class="p">[[</span><span class="s1">&#39;dlret&#39;</span><span class="p">,</span> <span class="s1">&#39;dlretx&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;retx&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="p">[[</span><span class="s1">&#39;dlret&#39;</span><span class="p">,</span> <span class="s1">&#39;dlretx&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">,</span> <span class="s1">&#39;retx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Returns (w/ and w/out dividends) adjusted for delisting.</span>
            <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">),</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;dlret&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;retx&#39;</span><span class="p">),</span> <span class="s1">&#39;retadjx&#39;</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;retx&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;dlretx&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dfcrsp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dlret&#39;</span><span class="p">,</span> <span class="s1">&#39;dlretx&#39;</span><span class="p">,</span> <span class="s1">&#39;dlstdt&#39;</span><span class="p">,</span> <span class="s1">&#39;shrout&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfcrsp_full</span><span class="p">[[</span><span class="s1">&#39;dlret&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="p">[[</span><span class="s1">&#39;dlret&#39;</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Returns (w/ dividends) adjusted for delisting.</span>
            <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;ret&#39;</span><span class="p">),</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;dlret&#39;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dfcrsp_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dlret&#39;</span><span class="p">,</span> <span class="s1">&#39;dlstdt&#39;</span><span class="p">,</span> <span class="s1">&#39;shrout&#39;</span><span class="p">]</span>

        <span class="c1"># Calculate market value of equity &#39;me&#39;.</span>
        <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">*</span> <span class="n">dfcrsp_full</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span>
        <span class="n">dfcrsp_full</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dfcrsp_cols</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permco&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dfcrsp_full</span></div>



<div class="viewcode-block" id="FamaFrench.queryrf1m"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.queryrf1m.html#famafrench.FamaFrench.queryrf1m">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">queryrf1m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the risk-free interest rate (ie 1-month Treasury Bill rate) from `wrds-cloud`.</span>
<span class="sd">        The risk-free interest rate is compounded to higher frequencies when needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start: datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end: datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        rf1m : pandas.DataFrame</span>
<span class="sd">            Cleaned dataset w/ time-series of the risk-free interest rate (ie 1-month Treasury Bill rate)</span>
<span class="sd">            used in the construction of the Market Premium.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
            <span class="n">freqTypeFulldir</span><span class="p">,</span> <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;daily&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
            <span class="n">freqTypeFulldir</span><span class="p">,</span> <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;weekly&#39;</span><span class="p">,</span> <span class="s1">&#39;daily&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="n">freqTypeFulldir</span><span class="p">,</span> <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
            <span class="n">freqTypeFulldir</span><span class="p">,</span> <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">freqTypeFulldir</span><span class="p">,</span> <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Since monthly observations have a date starting on the 1st of each month, then for any &#39;dt_start&#39; that doesn&#39;t</span>
        <span class="c1"># coincide w/ the 1st of any month, we adjust it so it does and the query pulls the monthly observation of interest.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">dt_start</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">MonthBegin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">MonthBegin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">),</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_rf1m_sqlQuery</span><span class="p">(</span><span class="n">freqType</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create SQL query string for the risk-free interest rate (ie 1-month Treasury Bill rate)</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            freqType : str</span>
<span class="sd">            start_date : datetime.date</span>
<span class="sd">            end_date : datetime.date</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            rf1m_sqlQuery : str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">freqType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>

            <span class="c1"># SQL script text depends on frequency</span>
            <span class="k">if</span> <span class="n">freqType</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;EXTRACT(DAY FROM LEAD(date) OVER (ORDER BY date)) - EXTRACT(DAY FROM date) AS diff&#39;</span>
                <span class="n">freq_sql</span> <span class="o">=</span> <span class="s1">&#39;rf AS cumrf&#39;</span>
            <span class="k">elif</span> <span class="n">freqType</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;EXTRACT(WEEK FROM LEAD(date) OVER (ORDER BY date)) - EXTRACT(WEEK FROM date) AS diff&#39;</span>
                <span class="n">freq_sql</span> <span class="o">=</span> <span class="s1">&#39;EXP(SUM(LN(1 + rf)) OVER (PARTITION BY EXTRACT(YEAR FROM date), EXTRACT(WEEK FROM date))) - 1 AS cumrf&#39;</span>
            <span class="k">elif</span> <span class="n">freqType</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;EXTRACT(MONTH FROM LEAD(date) OVER (ORDER BY date)) - EXTRACT(MONTH FROM date) AS diff&#39;</span>
                <span class="n">freq_sql</span> <span class="o">=</span> <span class="s1">&#39;rf AS cumrf&#39;</span>
            <span class="k">elif</span> <span class="n">freqType</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;EXTRACT(QUARTER FROM LEAD(date) OVER (ORDER BY date)) - EXTRACT(QUARTER FROM date) AS diff&#39;</span>
                <span class="n">freq_sql</span> <span class="o">=</span> <span class="s1">&#39;EXP(SUM(LN(1 + rf)) OVER (PARTITION BY EXTRACT(YEAR FROM date), EXTRACT(QUARTER FROM date))) - 1 AS cumrf&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;EXTRACT(YEAR FROM LEAD(date) OVER (ORDER BY date)) - EXTRACT(YEAR FROM date) AS diff&#39;</span>
                <span class="n">freq_sql</span> <span class="o">=</span> <span class="s1">&#39;EXP(SUM(LN(1 + rf)) OVER (PARTITION BY EXTRACT(YEAR FROM date))) - 1 AS cumrf&#39;</span>

            <span class="n">rf1m_sql</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rf1mDiff&#39;</span><span class="p">:</span> <span class="n">diff_sql</span><span class="p">,</span>
                        <span class="s1">&#39;rf1mFreq&#39;</span><span class="p">:</span> <span class="n">freq_sql</span><span class="p">,</span>
                        <span class="s1">&#39;rf1mDb&#39;</span><span class="p">:</span> <span class="s1">&#39;factors_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span><span class="p">,</span>
                        <span class="s1">&#39;rf1mDbStartDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">start_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;rf1mDbEndDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">end_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">}</span>

            <span class="n">rf1m_sqlQuery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            SELECT date_crsp, cumrf</span>
<span class="s2">                                FROM                 </span>
<span class="s2">                                (SELECT date AS date_crsp, </span><span class="si">{0}</span><span class="s2">, rf, </span><span class="si">{1}</span><span class="s2">                </span>
<span class="s2">                                    FROM </span><span class="si">{2}</span><span class="s2"> </span>
<span class="s2">                                    WHERE date BETWEEN </span><span class="si">{3}</span><span class="s2"> AND </span><span class="si">{4}</span><span class="s2"></span>
<span class="s2">                                ) as crsp_cumrf</span>
<span class="s2">                                WHERE diff!=0 OR diff is NULL</span>
<span class="s2">                            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rf1m_sql</span><span class="p">[</span><span class="s1">&#39;rf1mDiff&#39;</span><span class="p">],</span>
                                       <span class="n">rf1m_sql</span><span class="p">[</span><span class="s1">&#39;rf1mFreq&#39;</span><span class="p">],</span>
                                       <span class="n">rf1m_sql</span><span class="p">[</span><span class="s1">&#39;rf1mDb&#39;</span><span class="p">],</span>
                                       <span class="n">rf1m_sql</span><span class="p">[</span><span class="s1">&#39;rf1mDbStartDate&#39;</span><span class="p">],</span>
                                       <span class="n">rf1m_sql</span><span class="p">[</span><span class="s1">&#39;rf1mDbEndDate&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">rf1m_sqlQuery</span>

        <span class="c1"># Load local file if it exists (and dates can be found), else query from wrds-cloud.</span>
        <span class="n">rf1m_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFulldir</span> <span class="o">+</span> <span class="s1">&#39;/rf1m_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFulldir</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">rf1m_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rf1m_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">rf1m</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Historical risk-free interest rate (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFulldir</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. &#39;</span>
                                                                               <span class="s1">&#39;Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">date_min</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="n">rf1m_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_rf1m_sqlQuery</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>

                    <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="p">[(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                    <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf1m</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rf1m_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">rf1m</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">rf1m_pre</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">rf1m_pre</span>
                    <span class="k">del</span> <span class="n">lst</span>
                <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                    <span class="n">startdate</span> <span class="o">=</span> <span class="n">date_max</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="n">rf1m_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_rf1m_sqlQuery</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>

                    <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])]</span>
                    <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf1m_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rf1m_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">rf1m</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">rf1m_post</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">rf1m_post</span>
                    <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Historical risk-free interest rate (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFulldir</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Historical risk-free interest rate (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFulldir</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally. Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="n">rf1m</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_rf1m_sqlQuery</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rf1m_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">rf1m</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Convert trading dates to end-of-period if &#39;freq&#39; does not pertain to daily or weekly frequency.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rf1m</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rf1m</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rf1m</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rf1m</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cumrf&#39;</span><span class="p">:</span> <span class="s1">&#39;rf&#39;</span><span class="p">})[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;rf&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
            <span class="n">rf1m</span> <span class="o">=</span> <span class="n">rf1m</span><span class="p">[(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
            <span class="c1"># NOTE: Ken French&#39;s weekly datasets provide incorrect dates for some weeks prior to 1953.</span>
            <span class="c1">#       Specifically, some weeks end on a Saturday, instead of the correct trading weekday.</span>
            <span class="c1">#       An adjustment is made to correct for the error, assuming the only mistake is in the</span>
            <span class="c1">#       the weekly dates provided by Ken French and not how the daily returns are cumulated</span>
            <span class="c1">#       for the aforementioned weeks.</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

            <span class="c1"># NYSE trading day holiday calendar</span>
            <span class="n">nyse_holidays</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nyse_cal</span><span class="o">.</span><span class="n">holidays</span><span class="p">()</span><span class="o">.</span><span class="n">holidays</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">])</span>
            <span class="n">nyse_holidays</span> <span class="o">=</span> <span class="n">nyse_holidays</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">nyse_holidays</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">&gt;=</span> <span class="n">nyse_holidays</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)][</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nyse_holidays</span><span class="p">),</span> <span class="p">(</span><span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="n">rf1m</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf1m</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">rf1m</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rf1m</span></div>



<div class="viewcode-block" id="FamaFrench.getCrspDailyRollVar"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.getCrspDailyRollVar.html#famafrench.FamaFrench.getCrspDailyRollVar">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getCrspDailyRollVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate rolling `daily` variance of stock returns for all CRSP stocks queried from `wrds-cloud`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        roll_window : int</span>
<span class="sd">            Fixed size of the rolling (moving) window.</span>
<span class="sd">            This is the number of observations used for calculating the realized `daily` variance.</span>
<span class="sd">            Similar to parameter ``window`` in `pandas` method :meth:`pandas.DataFrame.rolling`.</span>
<span class="sd">        min_periods : int</span>
<span class="sd">            Minimum number of observations in each window necessary to have an estimated value.</span>
<span class="sd">            Similar to parameter ``min_periods`` in `pandas` method :meth:`pandas.DataFrame.rolling`.</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfcrsprollvar : pandas.DataFrame</span>
<span class="sd">            Dataset w/ panel of rolling `daily` variances calculated using ``roll_window`` days of lagged returns (w/ minimum of ``min_periods`` days).</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        For a short description of how Fama and French construct portfolios formed on the variance of daily returns, see</span>
<span class="sd">        `Detail for Portfolios Formed Monthly on Variance &lt;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_VAR.html&gt;`_.</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        Depending on a user&#39;s WRDS subscription, data variables will be queried from the most frequently updated</span>
<span class="sd">        CRSP datafiles. CRSP offers monthly, quarterly, and annually updated files for daily observations.</span>
<span class="sd">        The **default** datafiles are updated annually. See `wrds-cloud` SAS Library Names below:</span>

<span class="sd">            - ``crspm`` : dataset `CRSP Monthly Update`</span>
<span class="sd">            - ``crspq`` : dataset `CRSP Quarterly Update`</span>
<span class="sd">            - ``crspa`` : **default** dataset `CRSP Annual Update`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Need to query AT A MINIMUM (minus) -&#39;roll_window&#39; days before &#39;dt_start&#39; so we have a non-missing observation for &#39;dt_start&#39;:</span>
        <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">-</span> <span class="n">Day</span><span class="p">(</span><span class="n">roll_window</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">),</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="n">wrds_update</span><span class="p">,</span> <span class="n">freqType</span><span class="p">,</span> <span class="n">roll_win</span><span class="p">,</span> <span class="n">min_per</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create SQL query string for calculating rolling daily variances from CRSP stock datafiles.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ___________            </span>
<span class="sd">            wrds_update : str</span>
<span class="sd">            freqType : str</span>
<span class="sd">            roll_win : int</span>
<span class="sd">            min_per : int</span>
<span class="sd">            start_date : datetime.date</span>
<span class="sd">            end_date : datetime.date</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            crsprollvar_sqlQuery : str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">freqType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">diff_filter</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff_sql</span> <span class="o">=</span> <span class="s1">&#39;EXTRACT(MONTH FROM LEAD(a.date) OVER (PARTITION BY a.permno ORDER BY a.date)) - EXTRACT(MONTH FROM a.date) AS mdiff,&#39;</span>
                <span class="n">diff_filter</span> <span class="o">=</span> <span class="s1">&#39;AND (mdiff!=0 OR mdiff is NULL)&#39;</span>

            <span class="k">if</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspm.dsf&#39;</span>
                <span class="n">crspnames</span> <span class="o">=</span> <span class="s1">&#39;crspm.dsenames&#39;</span>
            <span class="k">elif</span> <span class="n">wrds_update</span> <span class="o">==</span> <span class="s1">&#39;quarterly&#39;</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspq.dsf&#39;</span>
                <span class="n">crspnames</span> <span class="o">=</span> <span class="s1">&#39;crspq.dsenames&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">crspdb</span> <span class="o">=</span> <span class="s1">&#39;crspa.dsf&#39;</span>
                <span class="n">crspnames</span> <span class="o">=</span> <span class="s1">&#39;crspa.dsenames&#39;</span>
            <span class="n">crsprollvar_sql</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">roll_win</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;min_periods&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_per</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;crspDb&#39;</span><span class="p">:</span> <span class="n">crspdb</span><span class="p">,</span>
                               <span class="s1">&#39;crspNames&#39;</span><span class="p">:</span> <span class="n">crspnames</span><span class="p">,</span>
                               <span class="s1">&#39;crspStartDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">start_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;crspEndDate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">end_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;crspDiff&#39;</span><span class="p">:</span> <span class="n">diff_sql</span><span class="p">,</span>
                               <span class="s1">&#39;crspDiffFilter&#39;</span><span class="p">:</span> <span class="n">diff_filter</span><span class="p">}</span>

            <span class="c1"># Calculate the rolling daily variance (by permno) within SQL query.</span>
            <span class="n">crsprollvar_sqlQuery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                SELECT permno, date, ret_rollvar</span>
<span class="s2">                                    FROM</span>
<span class="s2">                                    (SELECT CAST(a.permno AS INT), a.date, </span><span class="si">{0}</span><span class="s2"></span>
<span class="s2">                                    ROW_NUMBER() OVER (PARTITION BY a.permno ORDER BY a.date) AS obs_count, a.ret,                      </span>
<span class="s2">                                    VARIANCE(a.ret) OVER (PARTITION BY a.permno ORDER BY a.date </span>
<span class="s2">                                    ROWS BETWEEN </span><span class="si">{1}</span><span class="s2"> PRECEDING AND CURRENT ROW) AS ret_rollvar</span>
<span class="s2">                                    FROM </span><span class="si">{2}</span><span class="s2"> AS a</span>
<span class="s2">                                    LEFT JOIN </span><span class="si">{3}</span><span class="s2"> AS b</span>
<span class="s2">                                    ON a.permno = b.permno</span>
<span class="s2">                                    AND b.namedt &lt;= a.date</span>
<span class="s2">                                    AND a.date &lt;= b.nameendt</span>
<span class="s2">                                    WHERE a.date BETWEEN </span><span class="si">{4}</span><span class="s2"> AND </span><span class="si">{5}</span><span class="s2"></span>
<span class="s2">                                    AND b.exchcd BETWEEN 1 AND 3</span>
<span class="s2">                                    AND b.shrcd BETWEEN 10 AND 11</span>
<span class="s2">                                    ORDER BY a.permno ASC, a.date ASC</span>
<span class="s2">                                    ) AS retrollVar</span>
<span class="s2">                                    WHERE obs_count &gt;= </span><span class="si">{6}</span><span class="s2"> </span><span class="si">{7}</span><span class="s2"></span>
<span class="s2">                                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;crspDiff&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;window&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;crspDb&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;crspNames&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;crspStartDate&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;crspEndDate&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;min_periods&#39;</span><span class="p">],</span>
                                           <span class="n">crsprollvar_sql</span><span class="p">[</span><span class="s1">&#39;crspDiffFilter&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">crsprollvar_sqlQuery</span>

        <span class="c1"># Load local file if it exists (and dates can be found), else query from wrds-cloud.</span>
        <span class="n">crsprollvar_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/crsprollvar_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">crsprollvar_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsprollvar_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;VAR period&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">date_min</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP rolling daily variance dataset currently NOT saved locally w/ required dates. &#39;</span>
                       <span class="s1">&#39;Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                    <span class="c1"># Force an overlap of &#39;roll_window&#39; days so observations WITHIN &#39;roll_window&#39; days of &#39;date_min&#39; are not</span>
                    <span class="c1"># constructed using less than &#39;roll_window&#39; days as a result of an artificially truncated sample.</span>
                    <span class="n">date_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_min</span> <span class="o">+</span> <span class="n">Day</span><span class="p">(</span><span class="n">roll_window</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">date_min</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcrsprollvar_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfcrsprollvar_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span>
                                                                                                   <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                            <span class="n">dfcrsprollvar_pre</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="n">dfcrsprollvar_pre</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="p">[(</span><span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                    <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsprollvar_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsprollvar_pre</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcrsprollvar_pre</span>
                    <span class="k">del</span> <span class="n">lst</span>
                <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                    <span class="c1"># Force an overlap of &#39;roll_window&#39; days so observations WITHIN &#39;roll_window&#39; days of &#39;date_max&#39; are not</span>
                    <span class="c1"># constructed using less than &#39;roll_window&#39; days as a result of an artificially truncated sample.</span>
                    <span class="n">date_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">-</span> <span class="n">Day</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">roll_window</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">startdate</span> <span class="o">=</span> <span class="n">date_max</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="n">enddate</span> <span class="o">=</span> <span class="n">dt_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dfcrsprollvar_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfcrsprollvar_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span>
                                                                  <span class="n">enddate</span><span class="p">))</span>
                        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                            <span class="n">dfcrsprollvar_post</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                    <span class="n">dfcrsprollvar_post</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])]</span>
                    <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcrsprollvar_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsprollvar_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsprollvar_post</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcrsprollvar_post</span>
                    <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP rolling daily variance dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP rolling daily variance dataset currently NOT saved locally. Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;quarterly&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                    <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">get_crsprollvar_sqlQuery</span><span class="p">(</span><span class="s1">&#39;annual&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">))</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsprollvar_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ret_rollvar&#39;</span><span class="p">:</span> <span class="s1">&#39;var&#39;</span><span class="p">})</span>
            <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get end-of-month datetimes if &#39;freq&#39; pertains to monthly, quarterly, or annual portfolios.</span>
            <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ret_rollvar&#39;</span><span class="p">:</span> <span class="s1">&#39;var&#39;</span><span class="p">})</span>
            <span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfcrsprollvar</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">dfcrsprollvar</span> <span class="o">=</span> <span class="n">dfcrsprollvar</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">dfcrsprollvar</span></div>



<div class="viewcode-block" id="FamaFrench.aggregateME"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.aggregateME.html#famafrench.FamaFrench.aggregateME">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">aggregateME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate market value of equity **me** for cases in which the same firm (ie single **permco** identifer) has</span>
<span class="sd">        two or more securities (ie multiple **permno** identifiers) for a given **date**.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfcrsp2 : pandas.DataFrame</span>
<span class="sd">            Dataset containing single **permno** (by date) w/ the largest market value of equity **me**.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        For the purpose of constructing firm-level **me** it&#39;s crucial to aggregate **me** for each (**permco**, **date**) identifier pair.</span>
<span class="sd">        This **me** is assigned to the **permno** w/ the largest **me**.</span>
<span class="sd">        The approach followed here is similar to the one implemented in SAS found through `WRDS Research Applications</span>
<span class="sd">        &lt;https://wrds-www.wharton.upenn.edu/pages/support/applications/risk-factors-and-industry-benchmarks/fama-french-factors/&gt;`_.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfcrsp_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryCrspdlret</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>

        <span class="c1"># Sum of market value of equity - &#39;me&#39; - across different &#39;permno&#39; belonging to same &#39;permco&#39; for a given &#39;date&#39;.</span>
        <span class="n">dfcrsp_aggme</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permco&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Largest market value of equity - &#39;me&#39; - within a &#39;permco&#39; for a given &#39;date&#39;.</span>
        <span class="n">dfcrsp_maxme</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permco&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Join by (&#39;date&#39;, &#39;permco&#39;, &#39;me&#39;) to find the permno w/ &#39;me&#39;==&#39;maxme&#39;, then drop &#39;me&#39; columns.</span>
        <span class="n">dfcrsp1</span> <span class="o">=</span> <span class="n">dfcrsp_full</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcrsp_maxme</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permco&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">])</span>

        <span class="c1"># Join w/ &#39;dfcrsp_aggme&#39; to get the correct market value of equity value.</span>
        <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcrsp_aggme</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permco&#39;</span><span class="p">])</span>

        <span class="c1"># Sort by &#39;permno&#39; and &#39;date&#39;; drop duplicates.</span>
        <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># Return cleaned &#39;dfcrsp2&#39; pandas.DataFrame.</span>
        <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;shrcd&#39;</span><span class="p">),</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dfcrsp2</span></div>



<div class="viewcode-block" id="FamaFrench.getMEDec"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.getMEDec.html#famafrench.FamaFrench.getMEDec">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getMEDec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct market value of equity **me** for Decemeber of every year.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        me_dec : pandas.DataFrame</span>
<span class="sd">            Dataset w/ December market value of equity **me** for all **permno** identifiers in CRSP.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        Following Fama and French (1992, 1993), portfolios for July of year `t` to June of year `t+1` include all NYSE, AMEX, and</span>
<span class="sd">        NASDAQ stocks for which we have market value of equity **me** for December of year `t-1` and June of year `t`.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        Following the Fama and French methodology, **me** from December of year `t-1` is used to construct ``BM`` breakpoints,</span>
<span class="sd">        which are then used to form portfolios from July of year `t` to June of year `t+1`.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        The approach followed here is similar to the one implemented in SAS found through `WRDS Research Applications</span>
<span class="sd">        &lt;https://wrds-www.wharton.upenn.edu/pages/support/applications/risk-factors-and-industry-benchmarks/fama-french-factors/&gt;`_.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfaggme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregateME</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
        <span class="n">me_dec</span> <span class="o">=</span> <span class="n">dfaggme</span><span class="p">[(</span><span class="n">dfaggme</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)]</span>
        <span class="c1"># If frequency is daily or weekly, then December &#39;me&#39; corresponds to the last observed &#39;me&#39; in December.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">me_dec_eom</span> <span class="o">=</span> <span class="n">me_dec</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eom&#39;</span><span class="p">})</span>
            <span class="n">me_dec</span> <span class="o">=</span> <span class="n">me_dec</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">me_dec_eom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span>
            <span class="n">me_dec</span> <span class="o">=</span> <span class="n">me_dec</span><span class="p">[</span><span class="n">me_dec</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">me_dec</span><span class="p">[</span><span class="s1">&#39;date_eom&#39;</span><span class="p">]]</span>
            <span class="n">me_dec</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">me_dec</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">me_dec_eom</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">me_dec_eom</span>
            <span class="k">del</span> <span class="n">lst</span>
        <span class="n">me_dec</span> <span class="o">=</span> <span class="n">me_dec</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;me&#39;</span><span class="p">:</span> <span class="s1">&#39;me_dec&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">me_dec</span></div>



<div class="viewcode-block" id="FamaFrench.getFactorRegResults"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getFactorRegResults.html#famafrench.FamaFrench.getFactorRegResults">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getFactorRegResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ffmodel</span><span class="p">,</span> <span class="n">boolRVar</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="p">,</span> <span class="n">roll_window</span><span class="p">,</span> <span class="n">min_per</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate factor-based quantities of risk (specifically, market betas) as well as residuals using rolling regressions.</span>
<span class="sd">        Rolling regressions require a fixed rolling window w/ a minimum number of observations within each window.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        ffmodel : str</span>
<span class="sd">            Possible choices include:</span>

<span class="sd">                * ``capm`` : Market (CAPM) model</span>

<span class="sd">                    :math:`R_{t}^{i} - R_{t}^{f} = \\alpha _{i} + \\beta^{Mkt}_{i}\\left(R_{t}^{M}-R_{t}^{f}\\right) +\\varepsilon _{t}^{i}`</span>

<span class="sd">                * ``ff3`` : Fama-French 3 factor model</span>

<span class="sd">                    :math:`R_{t}^{i} - R_{t}^{f} = \\alpha _{i} + \\beta^{Mkt}_{i}\\left(R_{t}^{M}-R_{t}^{f}\\right) + \\beta^{SMB}_{i}R_{t}^{SMB} + \\beta^{HML}_{i}R_{t}^{HML} + \\varepsilon _{t}^{i}`</span>
<span class="sd">        boolRvar: bool</span>
<span class="sd">            Flag for choosing whether to calculate the variance of residuals (``boolRvar = True``)</span>
<span class="sd">            or the market betas estimated from a specified factor model ``ffmode`` (``boolRvar = False``).</span>
<span class="sd">        scholeswilliams: bool</span>
<span class="sd">            Flag for choosing whether to implement the Dimson (1979) methodology - based on Scholes-Williams (1977) -</span>
<span class="sd">            for estimating betas in the presence of infrequent trading. The methodology used here as well as in Fama-French (1993)</span>
<span class="sd">            estimates betas by summing coefficient estimates pertaining to lagged and coincident market return variables</span>
<span class="sd">            adjusted for auto-correlation of the market return variables:</span>

<span class="sd">            .. math::</span>

<span class="sd">                \widehat{\\beta^{Mkt}}_{t, Dimson} = \\frac{\\left(\widehat{\\beta^{Mkt}}_{t} + \widehat{\\beta^{Mkt}}_{t-1}\\right)}{\\left(1 + 2\widehat{\\rho}\\right)}</span>

<span class="sd">            * :math:`\widehat{\\beta^{Mkt}}_{t}` : OLS beta with the contemporaneous return of the market portfolio</span>
<span class="sd">            * :math:`\widehat{\\beta^{Mkt}}_{t-1}` : OLS beta with the return on the market portfolio lagged one period</span>
<span class="sd">            * :math:`\widehat{\\rho}` : First order autocorrelation coefficient of the return on the market.</span>

<span class="sd">            Otherwise, factor market betas are estimated in the usual sense using coincident market return variables.</span>

<span class="sd">        roll_window: int</span>
<span class="sd">            Fixed size of the rolling (moving) window.</span>
<span class="sd">            This is the number of observations used for calculating the factor betas or the residual variances from factor models.</span>
<span class="sd">        min_per: int</span>
<span class="sd">             Minimum number of observations in each window necessary to have an estimated value.</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfresVar, dfbeta : pandas.DataFrame</span>
<span class="sd">            Dataset containing the panel of market betas OR residual variances estimated from rolling regressions.</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        This routine uses `Numba &lt;https://numba.pydata.org/numba-doc/dev/index.html&gt;`_, an opens-source `just-in-time (JIT)` compiler that translates a subset of Python and NumPy</span>
<span class="sd">        into fast machine code using the LLVM compiler written in C++.</span>
<span class="sd">        Using `Numba &lt;https://numba.pydata.org/numba-doc/dev/index.html&gt;`_ a gives us C++/Fortran-like speed when estimating the rolling regressions.</span>
<span class="sd">        More details in source code utilizing `Numba &lt;https://numba.pydata.org/numba-doc/dev/index.html&gt;`_.</span>

<span class="sd">        Todo</span>
<span class="sd">        ______</span>
<span class="sd">        Extend the Dimson (1979) methodology based on Scholes-Williams (1977) to other factor quantities of risk</span>
<span class="sd">        beyond the `market (CAPM)` beta (eg, `SMB` and `HML` quantities of risk)</span>

<span class="sd">        References</span>
<span class="sd">        __________</span>
<span class="sd">        *   Scholes, Myron and Williams, Joseph. (1977). `Estimating betas from nonsynchronous data`,</span>
<span class="sd">            Journal of Financial Economics, (5)3, pp.309-327</span>

<span class="sd">        *   Dimson, Elroy. (1979). `Risk measurement when shares are subject to infrequent trading`,</span>
<span class="sd">            Journal of Financial Economics, (7)2, pp.197-226</span>

<span class="sd">        *   Fama, Eugene F., and Kenneth R. French. (1992). `The Cross-section of Expected Stock Returns`,</span>
<span class="sd">            Journal of Finance, 47(2), pp.427-465</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Numba imports (+ supression of Numba warnings)</span>
        <span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">i8</span>
        <span class="kn">import</span> <span class="nn">warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="c1"># Load local file if it exists (and dates can be found), else query from wrds-cloud.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Need to query AT A MINIMUM (minus) -&#39;roll_window&#39; days before &#39;dt_start&#39; so we have a non-missing estimation for &#39;dt_start&#39;:</span>
        <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">-</span> <span class="n">Day</span><span class="p">(</span><span class="n">roll_window</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="n">crsp_ret_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/crspretFactorReg_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runEstimation</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">crsp_ret_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_ret_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfcrsp_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Factor Regressions: CRSP return (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset for factor regressions currently NOT saved locally w/ required dates. &#39;</span>
                                                                         <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                    Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                    <span class="n">dfcrsp_ret_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregateME</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">date_min</span><span class="p">)[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">]]</span>
                    <span class="n">dfcrsp_ret_pre</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="p">[(</span><span class="n">dfcrsp_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                    <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcrsp_ret</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_ret_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsp_ret</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsp_ret_pre</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcrsp_ret_pre</span>
                    <span class="k">del</span> <span class="n">lst</span>
                <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy</span>
                <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                    <span class="n">dfcrsp_ret_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregateME</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">]]</span>
                    <span class="n">dfcrsp_ret_post</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrsp_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)]</span>
                    <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfcrsp_ret_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_ret_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsp_ret</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsp_ret_post</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfcrsp_ret_post</span>
                    <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Factor Regressions: CRSP return (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset for factor regressions currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfcrsp_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span>
                <span class="s1">&#39;Factor Regressions: CRSP return (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset for factor regressions currently NOT saved locally w/ required dates. &#39;</span>
                                                                     <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                    Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregateME</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">]]</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">crsp_ret_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfcrsp_ret</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Clean up &#39;dfcrsp_ret&#39; and reshape so rows &lt;--&gt; &#39;date&#39;, columns &lt;--&gt; &#39;permno&#39;.</span>
        <span class="n">dfcrsp_ret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;retadj&#39;</span><span class="p">)</span>
        <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Load or query the Market premium or Fama-French 3 factors using the naming conventions for the</span>
        <span class="c1"># &#39;FamaFrench&#39; class, else we estimate for the first time or re-estimate from wrds-cloud</span>
        <span class="c1"># i.e. ([&#39;MKT-RF&#39;] or [&#39;MKT-RF&#39;, &#39;SMB&#39;, &#39;HML&#39;]) &amp; Risk-Free Rate (&#39;RF&#39;).</span>
        <span class="k">if</span> <span class="n">ffmodel</span> <span class="o">==</span> <span class="s1">&#39;capm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="n">nfactors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MKT-RF&#39;</span><span class="p">],</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ffmodel</span> <span class="o">==</span> <span class="s1">&#39;ff3&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="n">nfactors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MKT-RF&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;HML&#39;</span><span class="p">],</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">ffmodel</span><span class="se">\&#39;</span><span class="s1"> should be the Market model (i.e. CAPM) or the Fama-French 3 model:</span><span class="se">\n</span><span class="s1"> use </span><span class="se">\&#39;</span><span class="s1">capm</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">ff3</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="n">ff_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">ffmodel</span> <span class="o">+</span> <span class="s1">&#39;factors_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runEstimation</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">ff_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ff_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Factor Regressions: &#39;</span> <span class="o">+</span> <span class="n">ffmodel</span> <span class="o">+</span> <span class="s1">&#39;factors (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. &#39;</span>
                                                                                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                    Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                    <span class="c1"># Force an overlap of &#39;roll_window&#39; days so estimations WITHIN &#39;roll_window&#39; days of &#39;date_min&#39; are not</span>
                    <span class="c1"># constructed using less than &#39;roll_window&#39; days as a result of an artificially truncated sample.</span>
                    <span class="n">date_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_min</span> <span class="o">+</span> <span class="n">Day</span><span class="p">(</span><span class="n">roll_window</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">dfportSort_tableList_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">date_min</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">fffactor</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;dfportSort_tableList_&#39;</span> <span class="o">+</span> <span class="n">fffactor</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">][(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                        <span class="n">dfportSort_tableList_pre</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList_pre</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)])</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">((</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ff_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfportSort_tableList_pre</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfportSort_tableList_pre</span>
                    <span class="k">del</span> <span class="n">lst</span>
                <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy.</span>
                <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                    <span class="c1"># Force an overlap of &#39;roll_window&#39; days so estimations WITHIN &#39;roll_window&#39; days of &#39;date_max&#39; are not</span>
                    <span class="c1"># constructed using less than &#39;roll_window&#39; days as a result of an artificially truncated sample.</span>
                    <span class="n">date_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">-</span> <span class="n">Day</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">roll_window</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">dfportSort_tableList_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">fffactor</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;dfportSort_tableList_&#39;</span> <span class="o">+</span> <span class="n">fffactor</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">][(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                        <span class="n">dfportSort_tableList_post</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfportSort_tableList_post</span><span class="p">[</span><span class="n">fffactor</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)])</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">((</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                        <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
                    <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ff_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                    <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfportSort_tableList_post</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">dfportSort_tableList_post</span>
                    <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Factor Regressions: &#39;</span> <span class="o">+</span> <span class="n">ffmodel</span> <span class="o">+</span> <span class="s1">&#39;factors (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fffactor</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">][(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">fffactor</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span>
                <span class="s1">&#39;Factor Regressions: &#39;</span> <span class="o">+</span> <span class="n">ffmodel</span> <span class="o">+</span> <span class="s1">&#39;factors (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. &#39;</span>
                                                                                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                    Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ff_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">dfFactors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;mktport&#39;</span><span class="p">)]</span>
        <span class="n">dfFactors</span> <span class="o">=</span> <span class="n">dfFactors</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queryrf1m</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;mkt-rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span>

        <span class="c1"># Create the Fama-French &quot;size&quot; and &quot;value/growth&quot; factors in the traditional way:</span>
        <span class="k">if</span> <span class="n">ffmodel</span> <span class="o">==</span> <span class="s1">&#39;ff3&#39;</span><span class="p">:</span>
            <span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;smb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span>
                <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_bm30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_bm0-30&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                               <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me50-100_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm0-30&#39;</span><span class="p">))])</span>
            <span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;hml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span>
                <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm70-100&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                               <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_bm0-30&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm0-30&#39;</span><span class="p">))])</span>

        <span class="c1"># Calculate Excess returns.</span>
        <span class="n">dfxret</span> <span class="o">=</span> <span class="n">dfcrsp_ret</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">dfFactors</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="c1"># Merge w/ Factors &amp; Risk-Free Rate.</span>
        <span class="n">dfxretTable</span> <span class="o">=</span> <span class="n">dfxret</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">dfFactors</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">dfxretTable</span> <span class="o">=</span> <span class="n">dfxretTable</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>
        <span class="n">dfxretTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfxretTable</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="nd">@njit</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Tuple</span><span class="p">((</span><span class="n">f8</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">f8</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">f8</span><span class="p">[:,</span> <span class="p">:]))(</span><span class="n">f8</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">f8</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">f8</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">unicode_type</span><span class="p">,</span> <span class="n">i8</span><span class="p">,</span> <span class="n">i8</span><span class="p">,</span> <span class="n">i8</span><span class="p">),</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">rolling_ols_sw</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">l1X0</span><span class="p">,</span> <span class="n">boolsw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">addcon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">nfactors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Implement rolling OLS regressions for a specific CRSP permno using &#39;Numba&#39; as described below:</span>
<span class="sd">                *   We implement Numba&#39;s &quot;just-in-time&quot; (JIT) compiler w/ the &#39;nopython=True&#39; compilation mode</span>
<span class="sd">                    This mode produces much faster code, but is limited in that the native types of all values</span>
<span class="sd">                    in the function being called can be inferred (e.g. &quot;object types&quot; such as pandas.Series or</span>
<span class="sd">                    pandas.DataFrame can&#39;t be inferred, however, floats, int, numpy.ndarray&#39;s can be inferred).</span>
<span class="sd">                    To use the &#39;nopython=True&#39; model, we can use the decorator &#39;jit(nopython=True)&#39; or &#39;njit&#39;.</span>
<span class="sd">                *   Setting &#39;nogil=True&#39; disables the Python global interpreter lock (GIL).</span>
<span class="sd">                    This is useful for taking advantage of multi-core processors.</span>
<span class="sd">                *   Setting &#39;fastmath=True&#39; relaxes the numerical rigour, which allows operations to be vectorized, as</span>
<span class="sd">                    floating-point reassociation is permitted, albeit at the expense of potentially unsafe</span>
<span class="sd">                    floating-point operations. For our purposes, we do not lose significant precision.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            Y0 : numpy.array</span>
<span class="sd">                Dataset w/ panel of firm-level returns.</span>
<span class="sd">            X0 : numpy.array</span>
<span class="sd">                Dataset w/ panel of factors.</span>
<span class="sd">            l1X0 : numpy.array</span>
<span class="sd">                Dataset w/ panel of lagged factors.</span>
<span class="sd">            boolsw: bool, default True</span>
<span class="sd">                Flag for choosing whether to implement the Dimson (1979) methodology - based on Scholes-Williams (1977) - as noted earlier (`boolsw = True`).</span>
<span class="sd">                Otherwise, we implement the estimation using coincident market variables (`boolsw = False`).</span>
<span class="sd">            addcon: bool, default True</span>
<span class="sd">                Flag for choosing whether to add or not add a constant to OLS regressions.</span>
<span class="sd">            boolRVar: bool, default False</span>
<span class="sd">                Flag for choosing whether to calculate the variance of residuals (``boolRvar = True``)</span>
<span class="sd">                or the market betas estimated from a specified factor model ``ffmode`` (``boolRvar = False``).</span>
<span class="sd">            cov_type: str</span>
<span class="sd">                Type of covariance-variance sandwich matrix estimated for the OLS coefficients.</span>
<span class="sd">                Currently, must be one of &#39;nonrobust&#39; or &#39;HC0&#39; resembling :meth:`statsmodels.regression.linear_model.RegressionResults`.</span>
<span class="sd">            nfactors : int, default 1 [optional]</span>
<span class="sd">                 Number of factors. Need if `boolsw = True`.</span>
<span class="sd">            window : int, default 60</span>
<span class="sd">                Fixed size of the rolling (moving) window.</span>
<span class="sd">            min_periods: int, default 24</span>
<span class="sd">                 Minimum number of observations in each window necessary to have an estimated value.</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            params, se, residVar (depending on values of `cov_type` &amp; `boolRVar`) : numpy.array or tuple, numpy.array</span>
<span class="sd">                numpy.array objects to be subsequently converted to pandas.DataFrame objects outside of this routine.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">addcon</span><span class="p">:</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">X0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">boolsw</span><span class="p">:</span>
                    <span class="n">l1X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">l1X0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">l1X0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">N</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">Y0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nfactors</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">residVar</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">Y0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">params</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">se</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">residVar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">boolsw</span><span class="p">:</span>
                <span class="n">autocorr</span><span class="p">,</span> <span class="n">sw_adj</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nfactors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nfactors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">autocorr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">sw_adj</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">if</span> <span class="n">Y0</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Use &#39;prange(...)&#39; instead of &#39;range(...)&#39; w/ numba &#39;njit&#39;</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">min_periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">Y0</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">l1x</span> <span class="o">=</span> <span class="n">l1X</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">sw_adj</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># Beta coefficients</span>
                    <span class="k">if</span> <span class="n">boolsw</span><span class="p">:</span>
                        <span class="n">params_sw_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="p">)</span>
                        <span class="n">params_sw_l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">l1x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="p">)</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">params_sw_l1</span> <span class="o">+</span> <span class="n">params_sw_0</span>

                        <span class="k">if</span> <span class="n">nfactors</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># METHOD 1: Directly estimate acf(1) using formula:</span>
                            <span class="c1"># autocorr[r, 1:] = (np.cov(x[:, 2], l1x[:, 2])[0][1]) / (np.std(x[:, 2]) * np.std(l1x[:, 2]))</span>

                            <span class="c1"># METHOD 2: Directly estimate acf(1) using OLS regression for de-meaned process (i.e. can omit intercept)</span>
                            <span class="n">autocorr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">((</span><span class="n">l1x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">l1x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">l1x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TODO: Apply Dimson (1997) method based on Scholes-Williams (1977) to other quantities of risk beyond the CAPM beta.&#39;</span><span class="p">)</span>
                        <span class="c1"># Construct the Scholes-Williams (1977) inspired market beta estimates.</span>
                        <span class="n">sw_adj</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sw_adj</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">autocorr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">/</span> <span class="n">sw_adj</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Construct the traditional market beta estimates.</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="p">)</span>

                    <span class="k">if</span> <span class="n">boolRVar</span><span class="p">:</span>
                        <span class="c1"># Residuals (and their unbiased sample variance): for-loops are much faster in &#39;njit&#39; than &#39;np.dot&#39;</span>
                        <span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                <span class="nb">sum</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:][</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">yhat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span>
                        <span class="n">resid</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">yhat</span>
                        <span class="n">sse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sse</span> <span class="o">/</span> <span class="p">(</span><span class="n">resid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">K</span><span class="p">)</span>
                        <span class="n">residVar</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sigma2</span>

                        <span class="c1"># Standard Errors (SEs):</span>
                        <span class="k">if</span> <span class="n">cov_type</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cov_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nonrobust&#39;</span><span class="p">,</span> <span class="s1">&#39;HC0&#39;</span><span class="p">]:</span>
                                <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                        <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                            <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:][</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                <span class="n">xx_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s1">&#39;nonrobust&#39;</span><span class="p">:</span>
                                    <span class="n">Sinv</span> <span class="o">=</span> <span class="n">xx_inv</span> <span class="o">*</span> <span class="n">sigma2</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">Sinv</span> <span class="o">=</span> <span class="p">((((</span><span class="n">xx_inv</span> <span class="o">@</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">resid</span> <span class="o">@</span> <span class="n">resid</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span> <span class="o">@</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span> <span class="o">@</span> <span class="n">xx_inv</span><span class="p">)</span>
                                <span class="n">se_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Sinv</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                                <span class="n">se</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">se_r</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;covariance-variance sandwich matrix type should be </span><span class="se">\&#39;</span><span class="s1">nonrobust</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">HC0</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">residVar</span>

        <span class="c1"># Separate independent and dependent variables for rolling regressions:</span>
        <span class="c1"># NOTE: pandas.DataFrame &#39;dfmktBeta&#39; requires an ordering of elements in &#39;self.factorsIdtemp&#39; that includes</span>
        <span class="c1">#       the market premium &#39;MKT-RF&#39; as the first element in the list of strings, hence we set this ordering below.</span>
        <span class="k">if</span> <span class="n">ffmodel</span> <span class="o">==</span> <span class="s1">&#39;capm&#39;</span><span class="p">:</span>
            <span class="n">factorList</span><span class="p">,</span> <span class="n">nfactors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mkt-rf&#39;</span><span class="p">],</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ffmodel</span> <span class="o">==</span> <span class="s1">&#39;ff3&#39;</span><span class="p">:</span>
            <span class="n">factorList</span><span class="p">,</span> <span class="n">nfactors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mkt-rf&#39;</span><span class="p">,</span> <span class="s1">&#39;smb&#39;</span><span class="p">,</span> <span class="s1">&#39;hml&#39;</span><span class="p">],</span> <span class="mi">3</span>

        <span class="n">dfy0</span> <span class="o">=</span> <span class="n">dfxretTable</span><span class="p">[</span><span class="n">dfxretTable</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">dfFactors</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="n">dfx0</span> <span class="o">=</span> <span class="n">dfxretTable</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">factorList</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dfl1x0</span> <span class="o">=</span> <span class="n">dfx0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scholeswilliams</span><span class="p">:</span>
            <span class="n">dfl1x0</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">dfl1x0</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_rolling_ols</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">l1x0</span><span class="p">,</span> <span class="n">permno</span><span class="p">,</span> <span class="n">boolsw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">addcon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">nfactors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Implement rolling OLS regressions for a given CRSP permno using `Numba`-based routine &#39;rolling_ols_sw()&#39;</span>
<span class="sd">            Output is converted to pandas.DataFrame.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            NOTE: Same parameters described in &#39;rolling_ols_sw()&#39; w/ the exception of &#39;permno&#39;.</span>
<span class="sd">            permno : str</span>
<span class="sd">                CRSP stock identifier.</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            dfmktBeta, dfse_mktBeta, dfresidVar (depending on values of `cov_type` &amp; `boolRVar`)</span>
<span class="sd">                pandas.DataFrame, or tuple, pandas.DataFrame</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Drop any corresponding missing observations (i.e. missings in either regressand or regressors).</span>
            <span class="n">nan_idx</span> <span class="o">=</span> <span class="n">y0</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">x0</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">l1x0</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">l1X0</span> <span class="o">=</span> <span class="n">y0</span><span class="p">[</span><span class="o">~</span><span class="n">nan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="o">~</span><span class="n">nan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">l1x0</span><span class="p">[</span><span class="o">~</span><span class="n">nan_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">if</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">boolRVar</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">residVar</span> <span class="o">=</span> <span class="n">rolling_ols_sw</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">l1X0</span><span class="p">,</span> <span class="n">boolsw</span><span class="p">,</span> <span class="n">addcon</span><span class="p">,</span> <span class="n">boolRVar</span><span class="p">,</span> <span class="n">cov_type</span><span class="p">,</span> <span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                                                    <span class="n">min_periods</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">residVar</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dfresidVar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">residVar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">residVar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">permno</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">dfresidVar</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rolling_ols_sw</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">l1X0</span><span class="p">,</span> <span class="n">boolsw</span><span class="p">,</span> <span class="n">addcon</span><span class="p">,</span> <span class="n">boolRVar</span><span class="p">,</span> <span class="n">cov_type</span><span class="p">,</span> <span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dfmktBeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">permno</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">dfmktBeta</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">residVar</span> <span class="o">=</span> <span class="n">rolling_ols_sw</span><span class="p">(</span><span class="n">Y0</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">l1X0</span><span class="p">,</span> <span class="n">boolsw</span><span class="p">,</span> <span class="n">addcon</span><span class="p">,</span> <span class="n">boolRVar</span><span class="p">,</span> <span class="n">cov_type</span><span class="p">,</span> <span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                                                      <span class="n">min_periods</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dfmktBeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">params</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">permno</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                    <span class="n">dfse_mktBeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">se</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">se</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">permno</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                    <span class="n">dfresidVar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">residVar</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">residVar</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">permno</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">dfmktBeta</span><span class="p">,</span> <span class="n">dfse_mktBeta</span><span class="p">,</span> <span class="n">dfresidVar</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># First, compile the &#39;Numba&#39;-based function on a few observations</span>
        <span class="c1"># (use progress bar from &#39;tqdm&#39; Python package - this doesn&#39;t add much overhead):</span>
        <span class="k">if</span> <span class="n">boolRVar</span><span class="p">:</span>
            <span class="n">resVar</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_rolling_ols</span><span class="p">(</span><span class="n">dfy0</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">]],</span> <span class="n">dfx0</span><span class="p">,</span> <span class="n">dfl1x0</span><span class="p">,</span> <span class="n">permno</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">boolsw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">nfactors</span><span class="o">=</span><span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="n">min_per</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dfy0</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Compiling Rolling OLS routine&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_rolling_ols</span><span class="p">(</span><span class="n">dfy0</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">]],</span> <span class="n">dfx0</span><span class="p">,</span> <span class="n">dfl1x0</span><span class="p">,</span> <span class="n">permno</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">boolsw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">nfactors</span><span class="o">=</span><span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="n">min_per</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dfy0</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Compiling Rolling OLS routine&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># Second, run on the complete pandas.DataFrame following initial compilation</span>
        <span class="c1"># (again, use progress bar from &#39;tqdm&#39; - this doesn&#39;t add much overhead):</span>
        <span class="k">if</span> <span class="n">boolRVar</span><span class="p">:</span>
            <span class="n">resVar</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_rolling_ols</span><span class="p">(</span><span class="n">dfy0</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">]],</span> <span class="n">dfx0</span><span class="p">,</span> <span class="n">dfl1x0</span><span class="p">,</span> <span class="n">permno</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">boolsw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">nfactors</span><span class="o">=</span><span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="n">min_per</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dfy0</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Running Rolling OLS routine on all CRSP stocks&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_rolling_ols</span><span class="p">(</span><span class="n">dfy0</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">]],</span> <span class="n">dfx0</span><span class="p">,</span> <span class="n">dfl1x0</span><span class="p">,</span> <span class="n">permno</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">boolsw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">nfactors</span><span class="o">=</span><span class="n">nfactors</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">roll_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="n">min_per</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dfy0</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Running Rolling OLS routine on all CRSP stocks&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># Merge list of pandas.Series w/ rolling regressions estimated at &#39;permno&#39;-level and stored in columns.</span>
        <span class="c1"># NOTE: List of pandas.Series can be cleared as we concatenate into them into pandas.DataFrames to save memory,</span>
        <span class="c1">#       albeit the effect is negligible. (For example, use &#39;mktBeta=None&#39; after pd.concat(...)&#39;)</span>
        <span class="k">if</span> <span class="n">boolRVar</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;level_0&#39;</span><span class="p">:</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;level_1&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;beta&#39;</span><span class="p">})</span>
            <span class="n">dfbeta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">dfbeta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">.0&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dfbeta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfresVar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">resVar</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">dfresVar</span> <span class="o">=</span> <span class="n">dfresVar</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;level_0&#39;</span><span class="p">:</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;level_1&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;resvar&#39;</span><span class="p">})</span>
            <span class="n">dfresVar</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;permno&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfresVar</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">dfresVar</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfresVar</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">.0&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dfresVar</span></div>



<div class="viewcode-block" id="FamaFrench.getMEJune"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.getMEJune.html#famafrench.FamaFrench.getMEJune">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getMEJune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct market value of equity **me** for June of every year.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Return</span>
<span class="sd">        ______</span>
<span class="sd">        None</span>
<span class="sd">            The pandas.DataFrames ``dfcrsp_june`` and ``dfcrsp3`` are returned as class attributes used in</span>
<span class="sd">            class methods :meth:`famafrench.FamaFrench.mergeCCM` and :meth:`famafrench.FamaFrench.getNyseThresholdsAndRet`, respectively.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        Following Fama and French (1992, 1993), portfolios for July of year `t` to June of year `t+1` include all NYSE, AMEX, and</span>
<span class="sd">        NASDAQ stocks for which we have market value of equity **me** for December of year `t-1` and June of year `t`.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        Following the Fama and French methodology, **me** from June of year `t` is used to construct **ME** breakpoints,</span>
<span class="sd">        which are then used to form portfolios from July of year `t` to June of year `t+1`.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        The approach followed here is similar to the one implemented in SAS found through `WRDS Research Applications</span>
<span class="sd">        &lt;https://wrds-www.wharton.upenn.edu/pages/support/applications/risk-factors-and-industry-benchmarks/fama-french-factors/&gt;`_.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Query CRSP files w/ aggregated market value of equity - &#39;me&#39;.</span>
        <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregateME</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
        <span class="n">me_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMEDec</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>

        <span class="c1"># SPECIAL CASE: Check if &#39;dfcrsp2 was already created in an earlier instance, hence reference to it already exists</span>
        <span class="c1">#               This is specifically needed if &#39;BETA&#39; or &#39;RESVAR&#39; are anomaly characteristics used in the</span>
        <span class="c1">#               construction of portfolios.</span>
        <span class="k">if</span> <span class="s1">&#39;ffdate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;shrcd&#39;</span><span class="p">),</span> <span class="s1">&#39;ffdate&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">))</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;shrcd&#39;</span><span class="p">),</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;ffdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;shrcd&#39;</span><span class="p">),</span> <span class="s1">&#39;ffmonth&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;ffdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>

            <span class="c1"># Calculate &#39;cumretx&#39; for each &#39;permno&#39; from July of year {t} to June of year {t+1}.</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;retadj&#39;</span><span class="p">),</span> <span class="s1">&#39;1+retx&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;retx&#39;</span><span class="p">]))</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;retadj&#39;</span><span class="p">),</span> <span class="s1">&#39;cumretx&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])[</span><span class="s1">&#39;1+retx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumprod</span><span class="p">())</span>

            <span class="c1"># Get lag of &#39;cumretx&#39; and lag of &#39;me&#39;</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;cumretx&#39;</span><span class="p">),</span> <span class="s1">&#39;lcumretx&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;cumretx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">),</span> <span class="s1">&#39;lme&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># If first &#39;permno&#39; observation then use &#39;me&#39;/(1+retx) to replace the missing value.</span>
            <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span>
            <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;lme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;1+retx&#39;</span><span class="p">]),</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;lme&#39;</span><span class="p">])</span>

        <span class="n">cols_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;DP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># NOTE: &#39;dp&#39; used to form portfolios in June of year {t} is the total dividends paid</span>
            <span class="c1">#        from July of year {t-1} to June of year {t} per dollar of equity in June of of year {t}</span>
            <span class="c1">#        To get total dividends, we need to extract them from monthly returns, which can be done by taking the</span>
            <span class="c1">#        difference between cum-dividend (delisted-adjusted) returns (&#39;retadj&#39;)</span>
            <span class="c1">#        and ex-dividend (delisted-adjusted) returns (&#39;retadjx&#39;) in CRSP.</span>
            <span class="c1">#</span>
            <span class="c1">#        Per Fama and French (2008, 2015), for each &#39;permno&#39; we would need at least 7 monthly returns to compute the</span>
            <span class="c1">#        dividend yield &#39;dp&#39;. We will also need market value of equity &#39;me&#39; for June of year {t}.</span>
            <span class="c1"># NOTE: In a week: 5 trading days</span>
            <span class="c1">#       In a month: avg of 21 trading days</span>
            <span class="c1">#       In a quarter: avg of 63 trading days</span>
            <span class="c1">#       In a year: avg of 251/252 trading days</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">retCount_june_scale</span> <span class="o">=</span> <span class="mi">147</span>  <span class="c1"># = (7 months * 21 trading days/month)</span>
                <span class="n">retCount_tradefreq</span> <span class="o">=</span> <span class="mi">251</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
                <span class="n">retCount_june_scale</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># = (7 months = BASIS)</span>
                <span class="n">retCount_tradefreq</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;frequency is not a standard type.</span><span class="se">\n</span><span class="s1"> &#39;</span>
                                 <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Q</span><span class="se">\&#39;</span><span class="s1">,  or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># NOTE: The portfolios for July of year {t} to June of {t+1} include NYSE, AMEX, and NASDAQ stocks for which we have</span>
            <span class="c1">#       ME for June of year {t}, and at least 7 monthly returns (to compute the dividend yield) from July of {t-1} to June of {t}.</span>
            <span class="c1">#       This is automatically tracked w/ a non-missing value for &#39;cumdiv_p&#39;.</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;lme&#39;</span><span class="p">),</span> <span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;retadjx&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
            <span class="n">cumdiv_p</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">)[</span><span class="s1">&#39;div&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">min_periods</span><span class="o">=</span><span class="n">retCount_june_scale</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">retCount_tradefreq</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">)[[</span><span class="s1">&#39;div&#39;</span><span class="p">]]</span>
            <span class="n">cumdiv_p</span> <span class="o">=</span> <span class="n">cumdiv_p</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;div&#39;</span><span class="p">:</span> <span class="s1">&#39;cumdiv&#39;</span><span class="p">})</span>
            <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">cumdiv_p</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;cumdiv&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cumdiv_p&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;cumdiv&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
            <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcrsp2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;cumdiv&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;lcumdiv_p&#39;</span><span class="p">,</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;cumdiv_p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cumdiv&#39;</span><span class="p">])</span>

            <span class="c1"># Obtain &#39;lcumdiv_p&#39; for month==June (which corresponds to &#39;ffmonth&#39;==January).</span>
            <span class="n">dp_june</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="p">[(</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">dp_june_bom</span> <span class="o">=</span> <span class="n">dp_june</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_bom&#39;</span><span class="p">})</span>
                <span class="n">dp_june</span> <span class="o">=</span> <span class="n">dp_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dp_june_bom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
                <span class="n">dp_june</span> <span class="o">=</span> <span class="n">dp_june</span><span class="p">[(</span><span class="n">dp_june</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dp_june</span><span class="p">[</span><span class="s1">&#39;date_bom&#39;</span><span class="p">])]</span>

                <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dp_june_bom</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">dp_june_bom</span>
                <span class="k">del</span> <span class="n">lst</span>
            <span class="n">dp_june</span> <span class="o">=</span> <span class="n">dp_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;lcumdiv_p&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lcumdiv_p&#39;</span><span class="p">:</span> <span class="s1">&#39;cumdiv_p_june&#39;</span><span class="p">})</span>
            <span class="n">dp_june</span><span class="p">[</span><span class="s1">&#39;cumdiv_p_june&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">dp_june</span><span class="p">[</span><span class="s1">&#39;cumdiv_p_june&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dp_june</span><span class="p">[</span><span class="s1">&#39;cumdiv_p_june&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># List containing all anomaly characteristics w/ &#39;PRIOR&#39; in their name (+ the two parameters that are needed).</span>
        <span class="n">re_prior</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;PRIOR_&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;[0-9]+&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">)</span>
        <span class="n">prior_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re_prior</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">):</span>
            <span class="n">df_prior</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;1+retadj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Add &#39;PRIOR_2_12&#39; if &#39;MOM&#39; is in &#39;factorsId&#39; and not already in &#39;prior_list&#39;.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;MOM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;PRIOR_2_12&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">):</span>
                <span class="n">prior_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PRIOR_2_12&#39;</span><span class="p">)</span>
            <span class="c1"># Add &#39;PRIOR_1_1&#39; if &#39;ST_Rev&#39; is in &#39;factorsId&#39; and not already in &#39;prior_list&#39;.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ST_Rev&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;PRIOR_1_1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">):</span>
                <span class="n">prior_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PRIOR_1_1&#39;</span><span class="p">)</span>
            <span class="c1"># Add &#39;PRIOR_13_60&#39; if &#39;LT_Rev&#39; is in &#39;factorsId&#39; and not already in &#39;prior_list&#39;.</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LT_Rev&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;PRIOR_13_60&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">):</span>
                <span class="n">prior_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;PRIOR_13_60&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">:</span>
                <span class="c1"># Using the terminology in...</span>
                <span class="c1"># (1) Fama, Eugene F., and Kenneth R. French. (2008). &quot;Dissecting Anomalies&quot;,</span>
                <span class="c1">#     Journal of Finance, 48(4), pp.1653-1678;</span>
                <span class="c1"># (2) Fama, Eugene F., and Kenneth R. French. (2016). &quot;Dissecting Anomalies w/ a Five-Factor Model&quot;,</span>
                <span class="c1">#     The Review of Financial Studies, 29(1), pp.69-103</span>
                <span class="c1"># we consider a portfolio of stocks w/ returns for period {t-k} to {t-j}, w/ j&lt;=k.</span>
                <span class="c1"># Example 1 (MONTHLY): the portfolio of stocks formed on prior returns denoted &quot;prior (2-12)&quot;</span>
                <span class="c1">#                      is composed of the 11-month cumulative return from month {t-13} to month {t-2}</span>
                <span class="c1"># Example 2 (MONTHLY): the portfolio of stocks formed on prior returns denoted &quot;prior (1-1)&quot;</span>
                <span class="c1">#                      is composed of the 1-month cumulative return from month {t-2} to {t-1}</span>
                <span class="c1"># Example 3 (MONTHLY): the portfolio of stocks formed on prior returns denoted &quot;prior (13-60)&quot;</span>
                <span class="c1">#                      is composed of the 48-month cumulative return from month {t-61} to month {t-13}</span>
                <span class="c1"># NOTE: French&#39;s online library provides data ONLY at the &quot;monthly&quot; and &quot;daily&quot; frequency.</span>
                <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">j_per</span><span class="p">,</span> <span class="n">k_per</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">priormonthToDay</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">j_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_prior</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">j_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_prior</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j_per</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">k_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_prior</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">k_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_prior</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">))</span>

                <span class="c1"># If int(k_per) &gt; 1 we calculate prior (j-k) return (w/ dividends) by using pandas.rolling()</span>
                <span class="c1"># Else if int(k_per) == 1, we just lag returns accordingly:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_prior</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j_per</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_prior</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;1+retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j_per</span><span class="p">)))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">j_per</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">df_prior</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">df_prior</span> <span class="o">=</span> <span class="n">df_prior</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;1+retadj&#39;</span><span class="p">])</span>
            <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">df_prior</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Variance of daily returns estimated using 60 (w/ a minimum 20) days of lagged daily returns.</span>
            <span class="n">df_rollvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCrspDailyRollVar</span><span class="p">(</span><span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>

            <span class="c1"># Since portfolios for month {t} (day {t}) are formed at the end of month {t-1} (end of day {t-1}),</span>
            <span class="c1"># we lag the variance estimate by one month to make future merges easier.</span>
            <span class="n">df_rollvar</span><span class="p">[</span><span class="s1">&#39;lvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rollvar</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df_rollvar</span> <span class="o">=</span> <span class="n">df_rollvar</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lvar&#39;</span><span class="p">:</span> <span class="s1">&#39;var&#39;</span><span class="p">})</span>
            <span class="n">df_rollvar</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df_rollvar</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">df_rollvar</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># decimals --&gt; % in returns</span>

            <span class="c1"># Merge &#39;dfcrsp2&#39; w/ &#39;df_rollvar&#39;.</span>
            <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">df_rollvar</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;RESVAR&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span><span class="p">:</span>
            <span class="c1"># Variance of DAILY residuals from FF3-model estimated using 60 (w/ a minimum 20) days of lagged daily returns.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Load local file if it exists (and dates can be found), else we re-estimate.</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freqTypeFull</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span>

            <span class="n">resvar_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/crspff3resvar_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runEstimation</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">resvar_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resvar_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
                <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RESVAR period&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">date_min</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;FF3-model daily residuals dataset currently NOT saved locally w/ required dates. Estimating...&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                    <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy</span>
                    <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                        <span class="n">dfresvarff3_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFactorRegResults</span><span class="p">(</span><span class="n">ffmodel</span><span class="o">=</span><span class="s1">&#39;ff3&#39;</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                   <span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_per</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">date_min</span><span class="p">)</span>
                        <span class="n">dfresvarff3_pre</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[(</span><span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                        <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfresvarff3</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resvar_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfresvarff3</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                        <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfresvarff3_pre</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfresvarff3_pre</span>
                        <span class="k">del</span> <span class="n">lst</span>
                    <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy.</span>
                    <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                        <span class="n">dfresvarff3_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFactorRegResults</span><span class="p">(</span><span class="n">ffmodel</span><span class="o">=</span><span class="s1">&#39;ff3&#39;</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                    <span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_per</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
                        <span class="n">dfresvarff3_post</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)]</span>
                        <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfresvarff3_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resvar_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfresvarff3</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                        <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfresvarff3_post</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfresvarff3_post</span>
                        <span class="k">del</span> <span class="n">lst</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;FF3-model daily residuals dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                    <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;FF3-model daily residuals dataset currently NOT saved locally w/ required dates. Estimating...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
                <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFactorRegResults</span><span class="p">(</span><span class="n">ffmodel</span><span class="o">=</span><span class="s1">&#39;ff3&#39;</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                                                       <span class="n">min_per</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>

                <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resvar_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfresvarff3</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># If portfolio returns are NOT &#39;daily&#39;, then we need to get end-of-period values...</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
                    <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfresvarff3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;resvar&#39;</span><span class="p">),</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
                    <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfresvarff3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">),</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
                    <span class="n">dfresvarff3_eom</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eom&#39;</span><span class="p">})</span>
                    <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfresvarff3_eom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])</span>

                    <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date_eom&#39;</span><span class="p">]]</span>
                    <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">]]</span>

            <span class="c1"># Since portfolios for month {t} (or day {t}) are formed at the end of month {t-1} (or end of day {t-1}),</span>
            <span class="c1"># we lag the residual variance estimate by one month to make future merges easier.</span>
            <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;lresvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;resvar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfresvarff3</span> <span class="o">=</span> <span class="n">dfresvarff3</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;resvar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lresvar&#39;</span><span class="p">:</span> <span class="s1">&#39;resvar&#39;</span><span class="p">})</span>
            <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;resvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;resvar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">dfresvarff3</span><span class="p">[</span><span class="s1">&#39;resvar&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># decimals --&gt; % in returns</span>

            <span class="c1"># Merge &#39;dfcrsp2&#39; w/ &#39;dfresvarff3&#39;.</span>
            <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfresvarff3</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;BETA&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span><span class="p">:</span>
            <span class="c1"># (Market) beta&#39;s estimated using 60 (w/ a minimum 24) months of lagged monthly returns.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Load local file if it exists (and dates can be found), else re-estimate.</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">freqtmp</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freqTypeFull</span><span class="p">,</span> <span class="n">freqtmp</span> <span class="o">=</span> <span class="s1">&#39;monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span>

            <span class="n">beta_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;/beta_&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runEstimation</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">beta_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">beta_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
                <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Market beta (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                <span class="n">date_min</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BETA period&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">date_min</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">):</span>
                    <span class="n">cprint</span><span class="p">(</span>
                        <span class="s1">&#39;Market beta (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. Estimating...&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>

                    <span class="c1"># Query missing observations BEFORE &#39;date_min&#39; and append to locally saved copy.</span>
                    <span class="k">if</span> <span class="n">dt_start</span> <span class="o">&lt;</span> <span class="n">date_min</span><span class="p">:</span>
                        <span class="n">dfbeta_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFactorRegResults</span><span class="p">(</span><span class="n">ffmodel</span><span class="o">=</span><span class="s1">&#39;capm&#39;</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                              <span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_per</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqtmp</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">date_min</span><span class="p">)</span>
                        <span class="n">dfbeta_pre</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="p">[(</span><span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
                        <span class="n">dfbeta</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfbeta</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">beta_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfbeta</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                        <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfbeta_pre</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfbeta_pre</span>
                        <span class="k">del</span> <span class="n">lst</span>
                    <span class="c1"># Query missing observations AFTER &#39;date_max&#39; and append to locally saved copy.</span>
                    <span class="k">if</span> <span class="n">date_max</span> <span class="o">&lt;</span> <span class="n">dt_end</span><span class="p">:</span>
                        <span class="n">dfbeta_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFactorRegResults</span><span class="p">(</span><span class="n">ffmodel</span><span class="o">=</span><span class="s1">&#39;capm&#39;</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                               <span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_per</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqtmp</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">date_max</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
                        <span class="n">dfbeta_post</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)]</span>
                        <span class="n">dfbeta</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfbeta_post</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">beta_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfbeta</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                        <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfbeta_post</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfbeta_post</span>
                        <span class="k">del</span> <span class="n">lst</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Market beta (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently saved locally w/ required dates.&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_cyan&#39;</span><span class="p">)</span>
                    <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;Market beta (&#39;</span> <span class="o">+</span> <span class="n">freqTypeFull</span> <span class="o">+</span> <span class="s1">&#39;) dataset currently NOT saved locally w/ required dates. Estimating...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
                <span class="n">dfbeta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFactorRegResults</span><span class="p">(</span><span class="n">ffmodel</span><span class="o">=</span><span class="s1">&#39;capm&#39;</span><span class="p">,</span> <span class="n">boolRVar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scholeswilliams</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">roll_window</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">min_per</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqtmp</span><span class="p">,</span> <span class="n">dt_start</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
                <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">beta_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfbeta</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
                <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Since portfolios for month {t} are formed at the end of June {t}, we lag the estimated betas by one month to make future merges easier.</span>
            <span class="n">dfbeta</span><span class="p">[</span><span class="s1">&#39;lbeta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfbeta</span> <span class="o">=</span> <span class="n">dfbeta</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span>

            <span class="c1"># Merge &#39;dfcrsp2&#39; w/ &#39;dfbeta&#39;</span>
            <span class="n">dfcrsp2</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfbeta</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>

            <span class="c1"># Obtain &#39;lbeta&#39; &amp; &#39;lme&#39; for month==June (which corresponds to &#39;ffmonth&#39;==January).</span>
            <span class="n">me_june</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="p">[(</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)]</span>
            <span class="n">beta_june</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="p">[(</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">me_june_bom</span> <span class="o">=</span> <span class="n">me_june</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_bom&#39;</span><span class="p">})</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">me_june_bom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="p">[(</span><span class="n">me_june</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">me_june</span><span class="p">[</span><span class="s1">&#39;date_bom&#39;</span><span class="p">])]</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date_bom&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lme&#39;</span><span class="p">:</span> <span class="s1">&#39;me_june&#39;</span><span class="p">})</span>

                <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">me_june_bom</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">me_june_bom</span>
                <span class="k">del</span> <span class="n">lst</span>

                <span class="n">beta_june_bom</span> <span class="o">=</span> <span class="n">beta_june</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_bom&#39;</span><span class="p">})</span>
                <span class="n">beta_june</span> <span class="o">=</span> <span class="n">beta_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">beta_june_bom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
                <span class="n">beta_june</span> <span class="o">=</span> <span class="n">beta_june</span><span class="p">[(</span><span class="n">beta_june</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">beta_june</span><span class="p">[</span><span class="s1">&#39;date_bom&#39;</span><span class="p">])]</span>

                <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">beta_june_bom</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">beta_june_bom</span>
                <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lme&#39;</span><span class="p">:</span> <span class="s1">&#39;me_june&#39;</span><span class="p">})</span>

            <span class="n">beta_june</span> <span class="o">=</span> <span class="n">beta_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;lbeta&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lbeta&#39;</span><span class="p">:</span> <span class="s1">&#39;beta&#39;</span><span class="p">})</span>
            <span class="n">beta_june</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">beta_june</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">beta_june</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># Merge &#39;june&#39; results back together.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">me_june</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">beta_june</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
            <span class="n">cols_list</span> <span class="o">=</span> <span class="n">cols_list</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;lbeta&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Obtain &#39;lme&#39; for month==July (which corresponds to &#39;ffmonth&#39;==January).</span>
            <span class="n">me_june</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="p">[(</span><span class="n">dfcrsp2</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="n">me_june_bom</span> <span class="o">=</span> <span class="n">me_june</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_bom&#39;</span><span class="p">})</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">me_june_bom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="p">[(</span><span class="n">me_june</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">me_june</span><span class="p">[</span><span class="s1">&#39;date_bom&#39;</span><span class="p">])]</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date_bom&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lme&#39;</span><span class="p">:</span> <span class="s1">&#39;me_june&#39;</span><span class="p">})</span>

                <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">me_june_bom</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">me_june_bom</span>
                <span class="k">del</span> <span class="n">lst</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">me_june</span> <span class="o">=</span> <span class="n">me_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lme&#39;</span><span class="p">:</span> <span class="s1">&#39;me_june&#39;</span><span class="p">})</span>

            <span class="c1"># Merge &#39;june&#39; results back together.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span> <span class="o">=</span> <span class="n">dfcrsp2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">me_june</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>

        <span class="c1"># Given &#39;me&#39; in June of year of {t}, then portfolio weight from July of year {t} to June of year {t+1} is fixed,</span>
        <span class="c1"># using &#39;me_june&#39; as the portfolio allocation for each &#39;permno&#39;.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;port_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;date_bom&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;lme&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;me_june&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;lcumretx&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_bom&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;port_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;lme&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;me_june&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;lcumretx&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;DP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Get &quot;dividend yield&quot;:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dp_june</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>
            <span class="n">cols_list</span> <span class="o">=</span> <span class="n">cols_list</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;cumdiv_p&#39;</span><span class="p">,</span> <span class="s1">&#39;cumdiv_p_june&#39;</span><span class="p">]</span>

        <span class="n">me_dec</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">me_dec</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">me_dec</span> <span class="o">=</span> <span class="n">me_dec</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;me_dec&#39;</span><span class="p">]]</span>

        <span class="c1"># Get &#39;me&#39; (and &#39;beta&#39;, if applicable) as of June of year {t}, as well as &#39;me&#39; for December of year {t-1} (i.e. &#39;me_dec&#39;).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
            <span class="n">dfcrsp_june_eom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eom&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcrsp_june_eom</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="p">[</span><span class="s1">&#39;date_eom&#39;</span><span class="p">])]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_eom&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Delete pandas.DataFrame no longer needed in memory</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfcrsp_june_eom</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">dfcrsp_june_eom</span>
            <span class="k">del</span> <span class="n">lst</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">me_dec</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;port_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;me_june&#39;</span><span class="p">,</span> <span class="s1">&#39;me_dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># Get current month &#39;me&#39; as &#39;me_t&#39;:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;me&#39;</span><span class="p">:</span> <span class="s1">&#39;me_t&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="FamaFrench.mergeCCM"><a class="viewcode-back" href="../../wrdscloudquery/generated/famafrench.FamaFrench.mergeCCM.html#famafrench.FamaFrench.mergeCCM">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">lru_cached_method</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mergeCCM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the CRSP/Compustat (CCM) Merged Linking Table needed to merge CRSP securities to</span>
<span class="sd">        Compustat companies on (**permno**, **gvkey**) identifier pairs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        _______</span>
<span class="sd">        None</span>
<span class="sd">             The pandas.DataFrame ``dfccm_june`` is returned as a class attribute used in the</span>
<span class="sd">             class method :meth:`famafrench.FamaFrench.getNyseThresholdsAndRet`.</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        List of (CCM) Merged Linking Table variables:</span>

<span class="sd">            - **gvkey**     : Unique permanent identifier assigned by Compustat at the company-level</span>
<span class="sd">            - **lpermno**   : Historical CRSP `permno` Link to Compustat Record</span>
<span class="sd">            - **linktype**  : Link Type Code</span>
<span class="sd">            - **linkprim**  : Primary Link Marker</span>
<span class="sd">            - **linkdt**    : First Effective Date of Link</span>
<span class="sd">            - **linkenddt** : Last Effective Date of Link</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        The approach followed here is similar to the one implemented in SAS found through `WRDS Research Applications</span>
<span class="sd">        &lt;https://wrds-www.wharton.upenn.edu/pages/support/applications/risk-factors-and-industry-benchmarks/fama-french-factors/&gt;`_.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span> <span class="o">!=</span> <span class="s1">&#39;MKT-RF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getMEJune</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
        <span class="n">dfcomp</span><span class="p">,</span> <span class="n">dfcomp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryComp</span><span class="p">(</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>

        <span class="n">ccm_sqlQuery</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        SELECT gvkey, lpermno as permno, linktype, linkprim, linkdt, linkenddt</span>
<span class="s2">                            FROM crsp.ccmxpf_linktable</span>
<span class="s2">                            WHERE substr(linktype,1,1)=&#39;L&#39;</span>
<span class="s2">                            AND (linkprim =&#39;C&#39; or linkprim=&#39;P&#39;)</span>
<span class="s2">                       &quot;&quot;&quot;</span>

        <span class="c1"># Load local file if it exists, else query from wrds-cloud.</span>
        <span class="n">ccm_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickled_directory</span> <span class="o">+</span> <span class="s1">&#39;ccm.pickle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runQuery</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">ccm_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ccm_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">dfccm</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;CRSP-Compustat merged linktable currently NOT saved locally. Querying from wrds-cloud...&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;on_white&#39;</span><span class="p">)</span>
            <span class="n">dfccm</span> <span class="o">=</span> <span class="n">wrdsConn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">sqlquery</span><span class="o">=</span><span class="n">ccm_sqlQuery</span><span class="p">)</span>
            <span class="n">file_to_pickle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ccm_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dfccm</span><span class="p">,</span> <span class="n">file_to_pickle</span><span class="p">)</span>
            <span class="n">file_to_pickle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Get datetime objects...</span>
        <span class="n">dfccm</span><span class="p">[</span><span class="s1">&#39;linkdt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfccm</span><span class="p">[</span><span class="s1">&#39;linkdt&#39;</span><span class="p">])</span>
        <span class="n">dfccm</span><span class="p">[</span><span class="s1">&#39;linkenddt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfccm</span><span class="p">[</span><span class="s1">&#39;linkenddt&#39;</span><span class="p">])</span>

        <span class="c1"># If &#39;linkenddt&#39; is missing, then set to today&#39;s date, &#39;today&#39;.</span>
        <span class="n">dfccm</span><span class="p">[</span><span class="s1">&#39;linkenddt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfccm</span><span class="p">[</span><span class="s1">&#39;linkenddt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;today&#39;</span><span class="p">))</span>
        <span class="n">dfccm1</span> <span class="o">=</span> <span class="n">dfcomp</span><span class="p">[[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp_list</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfccm</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfcomp_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dfccm1</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfccm1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">),</span> <span class="s1">&#39;yearend&#39;</span><span class="p">,</span> <span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">dfccm1</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfccm1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;yearend&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfccm1</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfccm1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dfcomp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;yearend&#39;</span><span class="p">,</span> <span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;datadate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">dfccm1</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfccm1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dfcomp_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;yearend&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Set the CCM link date bounds.</span>
        <span class="n">dfccm2</span> <span class="o">=</span> <span class="n">dfccm1</span><span class="p">[(</span><span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;linkdt&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dfccm1</span><span class="p">[</span><span class="s1">&#39;linkenddt&#39;</span><span class="p">])]</span>
        <span class="n">dfccm2</span> <span class="o">=</span> <span class="n">dfccm2</span><span class="p">[[</span><span class="s1">&#39;gvkey&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;datadate&#39;</span><span class="p">,</span> <span class="s1">&#39;yearend&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcomp_list</span><span class="p">]</span>

        <span class="c1"># Link CRSP w/ Compustat.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span> <span class="o">!=</span> <span class="s1">&#39;MKT-RF&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp_june</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfccm2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span> <span class="o">=</span> <span class="n">dfccm2</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;BE&#39;</span><span class="p">,</span> <span class="s1">&#39;BM&#39;</span><span class="p">,</span> <span class="s1">&#39;OP&#39;</span><span class="p">,</span> <span class="s1">&#39;AC&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))</span> <span class="ow">or</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;HML&#39;</span><span class="p">,</span> <span class="s1">&#39;RMW&#39;</span><span class="p">,</span> <span class="s1">&#39;CMA&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">)))):</span>
            <span class="c1"># Original &#39;be&#39; is in USD thousands, need it in USD millions since &#39;me_dec&#39; is in USD millions</span>
            <span class="c1"># NOTE: &#39;bm&#39; uses book equity &#39;be&#39; at the end of fiscal year {t-1} (i.e. previous June of year {t-1} to current May of year {t})</span>
            <span class="c1">#        and the market value of equity &#39;me_dec&#39; at the end of December of year {t}.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec_nonzero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec_nonzero&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;me_dec_nonzero&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;EP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Original &#39;ib&#39; is in USD thousands, need it in USD millions since &#39;me_dec&#39; is in USD millions</span>
            <span class="c1"># NOTE: &#39;ep&#39; uses &quot;income before extraordinary items&quot; &#39;ib&#39; at the end of fiscal year {t-1}</span>
            <span class="c1">#       (i.e. previous June of year {t-1} to current May of year {t})</span>
            <span class="c1">#        and the market value of equity &#39;me_dec&#39; at the end of December of year {t}.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;CFP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Original &#39;cf&#39; is in USD thousands, need it in USD millions since &#39;me_dec&#39; is in USD millions</span>
            <span class="c1"># NOTE: &#39;cfp&#39; uses &quot;income before extraordinary items&quot; &#39;ib&#39; &amp; &quot;deferred taxes and investment tax credit&quot;</span>
            <span class="c1">#        at the end of fiscal year {t-1} (i.e. previous June of year {t-1} to current May of year {t})</span>
            <span class="c1">#        and the market value of equity &#39;me_dec&#39; at the end of December of year {t}.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;me_dec&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;cfp&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;DP&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Dividend yield a la Fama and French (see French&#39;s online documentation for construction details).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cumdiv_p_june&#39;</span><span class="p">:</span> <span class="s1">&#39;dp&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;AC&#39;</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
            <span class="c1"># Accruals a la Fama and French (see French&#39;s online documentation for construction details).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;d_owcap_adj&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;csho_adj&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># NOTE: Compustat data yields gross outliers in &#39;ac&#39; for June of each year {t} w/ ratios as low as &#39;-200&#39; and as large as &#39;200&#39;.</span>
            <span class="c1">#       To be consistent w/ summary statistics for characteristics provided by Ken French&#39;s online library,</span>
            <span class="c1">#       values for &#39;ac&#39; less than &#39;-200&#39; and values for &#39;ac&#39; larger than &#39;200&#39; are set to missing.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="o">-</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="FamaFrench.getNyseThresholdsAndRet"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getNyseThresholdsAndRet.html#famafrench.FamaFrench.getNyseThresholdsAndRet">[docs]</a>    <span class="k">def</span> <span class="nf">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idList</span><span class="p">,</span> <span class="n">factorsBool</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select NYSE stocks used in the construction of breakpoints (ie thresholds) for portfolio sorting.</span>
<span class="sd">        Selection occurs at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        idList : list, str</span>
<span class="sd">            List of factors or list of anomaly portfolio characteristics whose</span>
<span class="sd">            naming convention is consistent w/ earlier described conventions.</span>
<span class="sd">        factorsBool : bool</span>
<span class="sd">            Flag for choosing whether to construct Fama-French factors or not.</span>
<span class="sd">            If `False`, then ``dim`` (w/ or w/out a value for ``retType``) must be passed as additional argument(s),</span>
<span class="sd">            otherwise these additional arguments are not passed.</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        dim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``idList``.</span>
<span class="sd">            For example, if ``idList = [&#39;ME&#39;, &#39;BM&#39;]`` and ``dim = [5, 5]``, then the portfolio sorting strategy</span>
<span class="sd">            is characterized by a bivariate quintile sort on both `size` and `book-to-market`.</span>
<span class="sd">        retType : str, [optional]</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfportSort_tableList : pandas.DataFrame, or dict, pandas.DataFrame</span>
<span class="sd">            Dataset(s) providing one of the following:</span>

<span class="sd">                1. Time-series of Fama-French-style factors.</span>
<span class="sd">                2. Panel data consisting of portfolios sorted on specific anomaly characteristics w/ the corresponding:</span>

<span class="sd">                    * portfolio returns</span>
<span class="sd">                    * number of firms in each portfolio</span>

<span class="sd">            Observation frequency is given by ``freq``. Sample period is from ``dt_start`` to ``dt_end``.</span>
<span class="sd">            Rows index time periods, columns index the factors or portfolios.</span>

<span class="sd">        dfportSort_characs : pandas.DataFrame, or dict, pandas.DataFrame</span>
<span class="sd">            Dataset providing `average` anomaly characteristics for each portfolio</span>
<span class="sd">            sorted on a specific set anomaly characteristics. The anomaly characteristics used to sort portfolios</span>
<span class="sd">            `NEED NOT` coincide w/ the  `average` anomaly characteristics calculated for each portfolio.</span>
<span class="sd">            Observation frequency is given by ``freq``. Sample period is from ``dt_start`` to ``dt_end``.</span>
<span class="sd">            Rows index time periods, columns index the portfolios.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">factorsBool</span><span class="p">:</span>
            <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;vw&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;vw&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">retType</span><span class="se">\&#39;</span><span class="s1"> is not a string w/ weighting scheme for portfolio returns.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(args) exceeds 2!&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">univariateSort</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="n">dim_sort</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct NYSE breakpoints based on univariate portfolio sorts.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            df : pandas.DataFrame</span>
<span class="sd">                Dataset w/ NYSE stock returns and characteristics.</span>
<span class="sd">            id1 : str</span>
<span class="sd">                Anomaly characteristic used to sort portfolios.</span>
<span class="sd">            dim_sort : list w/ int</span>
<span class="sd">                Num of portfolios constructed on anomaly characteristic `id1`.</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            df_breaks : pandas.DataFrame</span>
<span class="sd">                Dataset w/ univariate NYSE breakpoints.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df_breaks</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;30%&#39;</span><span class="p">,</span> <span class="s1">&#39;70%&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;30%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">,</span> <span class="s1">&#39;70%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">df_breaks</span>
            <span class="k">elif</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">df_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;20%&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="s1">&#39;60%&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">]</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df_breaks</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;20%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;60%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">df_breaks</span>
            <span class="k">elif</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span>
                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">df_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;10%&#39;</span><span class="p">,</span> <span class="s1">&#39;20%&#39;</span><span class="p">,</span> <span class="s1">&#39;30%&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">,</span> <span class="s1">&#39;60%&#39;</span><span class="p">,</span> <span class="s1">&#39;70%&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">,</span> <span class="s1">&#39;90%&#39;</span><span class="p">]</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df_breaks</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;10%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_10&#39;</span><span class="p">,</span> <span class="s1">&#39;20%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">,</span> <span class="s1">&#39;30%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;40%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">,</span> <span class="s1">&#39;60%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;70%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">,</span> <span class="s1">&#39;90%&#39;</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_90&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">df_breaks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">bivariateSort</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="n">dim_sort</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct NYSE breakpoints based on bivariate portfolio sorts.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            df : pandas.DataFrame</span>
<span class="sd">                Dataset w/ NYSE stock returns and characteristics.</span>
<span class="sd">            id1 : str</span>
<span class="sd">                First anomaly characteristic used to sort portfolios.</span>
<span class="sd">            id2 : str</span>
<span class="sd">                Second anomaly characteristic used to sort portfolios.</span>
<span class="sd">            dim_sort : list, int</span>
<span class="sd">                Given characteristics `id1` and `id2`, `dim_sort` contains dimensions for sorting on both `id1` and `id2`.</span>
<span class="sd">                For example, if ``id1 = ME`` and ``id2 = BM`` w/ ``dim_sort = [5, 5]``, then our sorting strategy</span>
<span class="sd">                will consist of a bivariate, quintile sort on `size` and `book-to-market`.</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            df_breaks : pandas.DataFrame</span>
<span class="sd">                Dataset w/ bivariate NYSE breakpoints.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
                <span class="n">nyse_charac1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">id1</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">})</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">nyse_charac2</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;30%&#39;</span><span class="p">,</span> <span class="s1">&#39;70%&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;30%&#39;</span><span class="p">:</span> <span class="n">id2</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">,</span> <span class="s1">&#39;70%&#39;</span><span class="p">:</span> <span class="n">id2</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">})</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">nyse_charac1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">nyse_charac2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">df_breaks</span>

            <span class="k">elif</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
                <span class="k">def</span> <span class="nf">rename_nyse_charac</span><span class="p">(</span><span class="n">dftmp</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
                    <span class="n">df_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;20%&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="s1">&#39;60%&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">]</span>
                    <span class="n">dftmp</span> <span class="o">=</span> <span class="n">dftmp</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;20%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;60%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">dftmp</span>

                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
                <span class="n">nyse_charac1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac1</span> <span class="o">=</span> <span class="n">rename_nyse_charac</span><span class="p">(</span><span class="n">nyse_charac1</span><span class="p">,</span> <span class="n">id1</span><span class="p">)</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">rename_nyse_charac</span><span class="p">(</span><span class="n">nyse_charac2</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">nyse_charac1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">nyse_charac2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">df_breaks</span>

            <span class="k">elif</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
                <span class="k">def</span> <span class="nf">rename_nyse_charac</span><span class="p">(</span><span class="n">dftmp</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
                    <span class="n">df_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;10%&#39;</span><span class="p">,</span> <span class="s1">&#39;20%&#39;</span><span class="p">,</span> <span class="s1">&#39;30%&#39;</span><span class="p">,</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">,</span> <span class="s1">&#39;60%&#39;</span><span class="p">,</span> <span class="s1">&#39;70%&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">,</span> <span class="s1">&#39;90%&#39;</span><span class="p">]</span>
                    <span class="n">dftmp</span> <span class="o">=</span> <span class="n">dftmp</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;10%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_10&#39;</span><span class="p">,</span> <span class="s1">&#39;20%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">,</span> <span class="s1">&#39;30%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;40%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">,</span> <span class="s1">&#39;60%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;70%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">,</span> <span class="s1">&#39;80%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">,</span> <span class="s1">&#39;90%&#39;</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;_90&#39;</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">dftmp</span>

                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
                <span class="n">nyse_charac1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac1</span> <span class="o">=</span> <span class="n">rename_nyse_charac</span><span class="p">(</span><span class="n">nyse_charac1</span><span class="p">,</span> <span class="n">id1</span><span class="p">)</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">rename_nyse_charac</span><span class="p">(</span><span class="n">nyse_charac2</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">nyse_charac1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">nyse_charac2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">df_breaks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type.&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">trivariateSort</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="n">id3</span><span class="p">,</span> <span class="n">dim_sort</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct NYSE breakpoints based on trivariate portfolio sorts.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            df : pandas.DataFrame</span>
<span class="sd">                Dataset w/ NYSE stock returns and characteristics.</span>
<span class="sd">            id1 : str</span>
<span class="sd">                First anomaly characteristic used to sort portfolios.</span>
<span class="sd">            id2 : str</span>
<span class="sd">                Second anomaly characteristic used to sort portfolios.</span>
<span class="sd">            id3 : str</span>
<span class="sd">                Third anomaly characteristic used to sort portfolios.</span>
<span class="sd">            dim_sort : list, int</span>
<span class="sd">                Given characteristics `id1`, `id2`, and `id3`, `dim_sort` contains dimensions for sorting on `id1`, `id2`, and `id3`.</span>
<span class="sd">                For example, if ``id1 = ME``, ``id2 = BM``, and ``id3 = OP`` w/ ``dim_sort = [2, 4, 4,]``, then our sorting strategy</span>
<span class="sd">                will consist of a trivariate sort on `size`, `book-to-market`, and `operating profitability`  w/:</span>
<span class="sd">                 1. `size` split at the median,</span>
<span class="sd">                 2. `book-to-market` split into quartiles, and</span>
<span class="sd">                 3. `operating profitability` split into quartiles</span>


<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            df_breaks : pandas.DataFrame</span>
<span class="sd">                 Dataset w/ trivariate NYSE breakpoints.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">dim_sort</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="n">ptiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>
                <span class="n">nyse_charac1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id1</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">id1</span><span class="p">:</span> <span class="n">id1</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">})</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id2</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac2</span> <span class="o">=</span> <span class="n">nyse_charac2</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;25%&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;25%&#39;</span><span class="p">:</span> <span class="n">id2</span> <span class="o">+</span> <span class="s1">&#39;_25&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">:</span> <span class="n">id2</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">:</span> <span class="n">id2</span> <span class="o">+</span> <span class="s1">&#39;_75&#39;</span><span class="p">})</span>
                <span class="n">nyse_charac3</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">id3</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">ptiles</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">nyse_charac3</span> <span class="o">=</span> <span class="n">nyse_charac3</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;25%&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;25%&#39;</span><span class="p">:</span> <span class="n">id3</span> <span class="o">+</span> <span class="s1">&#39;_25&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">:</span> <span class="n">id3</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">:</span> <span class="n">id3</span> <span class="o">+</span> <span class="s1">&#39;_75&#39;</span><span class="p">})</span>

                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">nyse_charac1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">nyse_charac2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                <span class="n">df_breaks</span> <span class="o">=</span> <span class="n">df_breaks</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">nyse_charac3</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">df_breaks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type.&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">getPortfolioBins</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">idBool</span><span class="p">,</span> <span class="n">port_num</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Given NYSE breakpoints, stocks are allocated into the appropriate portfolio bins.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            df : pandas.DataFrame</span>
<span class="sd">                Dataset w/ firm variables used in the portfolio allocation process.</span>
<span class="sd">            id_col : str</span>
<span class="sd">                Column label for the anomaly portfolio characteristic used to allocate stocks into portfolios.</span>
<span class="sd">            idBool : str</span>
<span class="sd">                Column label for boolean variable determining whether a stock is included or not in a portfolio bin.</span>
<span class="sd">            port_num : int</span>
<span class="sd">                Num of portfolios constructed using anomaly portfolio characteristic `id_col`.</span>
<span class="sd">                `port_num` is one of the following: 2, 3, 4, 5, or 10.</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            df : pandas.DataFrame</span>
<span class="sd">                Updated `df` w/ additional columns containing portfolio bin identifiers.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">id_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;be&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">,</span> <span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;ni&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">]:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ubound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

            <span class="k">if</span> <span class="n">port_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">port_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">bcond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">])</span>
                    <span class="n">bcond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ubound&#39;</span><span class="p">])</span>
                    <span class="n">binconds</span> <span class="o">=</span> <span class="p">[</span><span class="n">bcond1</span><span class="p">,</span> <span class="n">bcond2</span><span class="p">]</span>
                    <span class="n">bvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;0-50&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;50-100&#39;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">port_num</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">bcond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">])</span>
                    <span class="n">bcond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">])</span>
                    <span class="n">bcond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ubound&#39;</span><span class="p">])</span>
                    <span class="n">binconds</span> <span class="o">=</span> <span class="p">[</span><span class="n">bcond1</span><span class="p">,</span> <span class="n">bcond2</span><span class="p">,</span> <span class="n">bcond3</span><span class="p">]</span>
                    <span class="n">bvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;30-70&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">port_num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">bcond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_25&#39;</span><span class="p">])</span>
                    <span class="n">bcond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_25&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">])</span>
                    <span class="n">bcond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_75&#39;</span><span class="p">])</span>
                    <span class="n">bcond4</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_75&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ubound&#39;</span><span class="p">])</span>
                    <span class="n">binconds</span> <span class="o">=</span> <span class="p">[</span><span class="n">bcond1</span><span class="p">,</span> <span class="n">bcond2</span><span class="p">,</span> <span class="n">bcond3</span><span class="p">,</span> <span class="n">bcond4</span><span class="p">]</span>
                    <span class="n">bvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;0-25&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;25-50&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;50-75&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;75-100&#39;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="n">port_num</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">bcond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">])</span>
                    <span class="n">bcond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">])</span>
                    <span class="n">bcond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">])</span>
                    <span class="n">bcond4</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">])</span>
                    <span class="n">bcond5</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ubound&#39;</span><span class="p">])</span>
                    <span class="n">binconds</span> <span class="o">=</span> <span class="p">[</span><span class="n">bcond1</span><span class="p">,</span> <span class="n">bcond2</span><span class="p">,</span> <span class="n">bcond3</span><span class="p">,</span> <span class="n">bcond4</span><span class="p">,</span> <span class="n">bcond5</span><span class="p">]</span>
                    <span class="n">bvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;0-20&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;20-40&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;40-60&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;60-80&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;80-100&#39;</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bcond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_10&#39;</span><span class="p">])</span>
                    <span class="n">bcond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_10&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">])</span>
                    <span class="n">bcond3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_20&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">])</span>
                    <span class="n">bcond4</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_30&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">])</span>
                    <span class="n">bcond5</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_40&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">])</span>
                    <span class="n">bcond6</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_50&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">])</span>
                    <span class="n">bcond7</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_60&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">])</span>
                    <span class="n">bcond8</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_70&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">])</span>
                    <span class="n">bcond9</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_80&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_90&#39;</span><span class="p">])</span>
                    <span class="n">bcond10</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">idBool</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_90&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ubound&#39;</span><span class="p">])</span>
                    <span class="n">binconds</span> <span class="o">=</span> <span class="p">[</span><span class="n">bcond1</span><span class="p">,</span> <span class="n">bcond2</span><span class="p">,</span> <span class="n">bcond3</span><span class="p">,</span> <span class="n">bcond4</span><span class="p">,</span> <span class="n">bcond5</span><span class="p">,</span> <span class="n">bcond6</span><span class="p">,</span> <span class="n">bcond7</span><span class="p">,</span> <span class="n">bcond8</span><span class="p">,</span> <span class="n">bcond9</span><span class="p">,</span> <span class="n">bcond10</span><span class="p">]</span>
                    <span class="n">bvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;0-10&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;10-20&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;20-30&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;30-40&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;40-50&#39;</span><span class="p">,</span>
                             <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;50-60&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;60-70&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;70-80&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;80-90&#39;</span><span class="p">,</span> <span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;90-100&#39;</span><span class="p">]</span>

                <span class="n">df</span><span class="p">[</span><span class="n">id_col</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">binconds</span><span class="p">,</span> <span class="n">bvals</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lbound&#39;</span><span class="p">,</span> <span class="s1">&#39;ubound&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">port_num</span><span class="se">\&#39;</span><span class="s1"> is not a standard type!&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_getNyseThresholds</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">dfcrsp</span><span class="p">,</span> <span class="n">fidList</span><span class="p">,</span> <span class="n">fBool</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">pDim</span><span class="p">,</span> <span class="o">*</span><span class="n">args_</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Construct dataset(s) w/ factors, portfolio returns, number of firms in portfolios,</span>
<span class="sd">            or average anomaly portfolio characteristics observed at a given frequency and over a given sample period</span>
<span class="sd">            for a given portfolio sorting strategy.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ___________</span>
<span class="sd">            df1 : pandas.DataFrame</span>
<span class="sd">                Dataset w/ anomaly characteristics (used in constructing portfolios at the end of each June)</span>
<span class="sd">                obtained from merged Compustat/CRSP datafiles.</span>
<span class="sd">            dfcrsp : pandas.DataFrame</span>
<span class="sd">                Dataset w/ firm variables observed at frequency `freq` (defined below).</span>
<span class="sd">            fidList : list, str</span>
<span class="sd">                Contains the factor or list of anomaly portfolio characteristics</span>
<span class="sd">                whose naming convention is consistent w/ earlier-described conventions.</span>
<span class="sd">            fBool : bool</span>
<span class="sd">                Flag for choosing whether to construct a Fama-French factor or not.</span>
<span class="sd">                If `True`, then `fidType` (defined below) must be passed as an additional argument and</span>
<span class="sd">                `pRetType` = `vw` is the default. Otherwise, `pRetType` must be passed as an additional argument.</span>
<span class="sd">            freq : str</span>
<span class="sd">                Observation frequency of the portfolios. Possible choices are:</span>
<span class="sd">                * ``D`` for daily</span>
<span class="sd">                * ``W`` for weekly</span>
<span class="sd">                * ``M&#39; for monthly</span>
<span class="sd">                * ``Q`` for quarterly (3-months)</span>
<span class="sd">                * ``A`` for annual</span>
<span class="sd">            pDim : list, int</span>
<span class="sd">                Dimensions for sorting on each element in the list ``idList``.</span>
<span class="sd">                For example, if ``idList = [&#39;ME&#39;, &#39;BM&#39;]`` and ``dim = [2, 3]``, then the portfolio sorting strategy</span>
<span class="sd">                is characterized by a bivariate quintile sort on both `size` and `book-to-market` in which</span>
<span class="sd">                `size` is split at the median, `book-to-market` is split into three buckets using 30th and 70th percentiles.</span>
<span class="sd">            fidType : str, [optional]</span>
<span class="sd">                Identifer marking which set of Fama-French factors (between traditional 3-factors and the more recent 5-factors)</span>
<span class="sd">                are to be constructed for the purposes of forming ``SMB``. Possible choices are:</span>
<span class="sd">                    * ``ff3`` : Fama-French 3 factors</span>
<span class="sd">                    * ``ff5`` : Fama-French 5 factors</span>
<span class="sd">            pRetType : str, [optional]</span>
<span class="sd">                Weighting-scheme for portfolios. Possible choices are:</span>
<span class="sd">                    * ``vw`` : value-weights</span>
<span class="sd">                    * ``ew`` : equal-weights</span>

<span class="sd">            Returns</span>
<span class="sd">            ________</span>
<span class="sd">            dfportSort_table : pandas.DataFrame or dict, pandas.DataFrames</span>
<span class="sd">                Dataset(s) w/ Fama-French factors, portfolio returns, number of firms in each portfolio,</span>
<span class="sd">                or average anomaly portfolio characteristics observed at frequency `freq` for a</span>
<span class="sd">                given portfolio sorting strategy.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                <span class="n">fidType</span> <span class="o">=</span> <span class="n">args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pRetType</span> <span class="o">=</span> <span class="s1">&#39;vw&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pRetType</span> <span class="o">=</span> <span class="n">args_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># List containing all anomaly characteristics w/ &#39;PRIOR&#39; in their name (+ the two additional parameters that are required).</span>
            <span class="n">re_prior</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;PRIOR_&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;[0-9]+&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">)</span>
            <span class="n">prior_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re_prior</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">fidList</span><span class="p">))</span>

            <span class="c1"># Common Boolean Condition #1, sBool1: (exchcd == 1) &amp; shrcd in (10,11)</span>
            <span class="c1"># Common Boolean Condition #2, sBool2:  (at least 2 years in &#39;comp&#39;), &amp; (positive &#39;me&#39;)</span>
            <span class="n">sBool1</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;shrcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]))</span>
            <span class="n">sBool2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;MKT-RF&#39;</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span>
                    <span class="c1"># MKT-RF (premium): Require</span>
                    <span class="c1">#                   (1) NYSE, AMEX, and Nasdaq stocks,</span>
                    <span class="c1">#                   (2) positive lagged &#39;me,</span>
                    <span class="c1">#                   (3) non-missing adjusted returns</span>
                    <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolMkt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;shrcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;lme&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;SMB&#39;</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">fidType</span> <span class="o">==</span> <span class="s1">&#39;ff3&#39;</span><span class="p">:</span>
                        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;HML&#39;</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">]</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;RMW&#39;</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;op&#39;</span><span class="p">]</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;CMA&#39;</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;inv&#39;</span><span class="p">]</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">fidList</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">]:</span>
                    <span class="c1"># NOTE: As a reference, see comments inside function &#39;getMEJune(...)&#39;:</span>
                    <span class="k">if</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;MOM&#39;</span><span class="p">:</span>
                        <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span>
                    <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">:</span>
                        <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="s1">&#39;13&#39;</span><span class="p">,</span> <span class="s1">&#39;60&#39;</span>
                    <span class="n">j_per</span><span class="p">,</span> <span class="n">k_per</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">priormonthToDay</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span><span class="p">)</span>
                    <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span>
                    <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;shrcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]))</span> <span class="o">&amp;</span> \
                                          <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">j_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">k_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown factor.&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Initialize boolean for &#39;df1&#39; w/ any generic column that has all rows set to &#39;True&#39;:</span>
                <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">])</span>
                <span class="n">ffcharac_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="s1">&#39;ME&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span>
                <span class="k">if</span> <span class="s1">&#39;BE&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;be&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;BM&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bm&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;OP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;op&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;INV&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;inv&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;EP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ep&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;CFP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cfp&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;DP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;dp&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;AC&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ac&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;d_owcap_adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;NI&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ni&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="n">sBool2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># NOTE: As a reference, see comments inside function &#39;getMEJune(...)&#39;:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">:</span>
                        <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">j_per</span><span class="p">,</span> <span class="n">k_per</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">priormonthToDay</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span><span class="p">)</span>
                        <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">)</span>

                        <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;shrcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]))</span> <span class="o">&amp;</span> \
                                              <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">j_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">k_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;BETA&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="s1">&#39;RESVAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;var&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vartype</span> <span class="o">=</span> <span class="s1">&#39;resvar&#39;</span>
                    <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vartype</span><span class="p">)</span>
                    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">sBool1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;shrcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;lme&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfcrsp</span><span class="p">[</span><span class="n">vartype</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">fBool</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;MKT-RF&#39;</span><span class="p">):</span>
                <span class="c1"># Construct value-weighted market return &#39;MKT&#39; which includes all CRSP firms incorporated in the US and listed</span>
                <span class="c1"># on the NYSE, AMEX, and Nasdaq firms that have CRSP share code 10 or 11 at beginning of period {t},</span>
                <span class="c1"># shares and price data at beginning of period {t}, and returns from period {t-1} to period {t}.</span>
                <span class="c1"># NOTE: The period here is at the same frequency of the portfolio sorts and/or factors, NOT the period</span>
                <span class="c1">#       used to construct NYSE breakpoints for characteristic-based portfolio sorts.</span>
                <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[</span><span class="n">dfcrsp</span><span class="p">[</span><span class="s1">&#39;sBoolMkt&#39;</span><span class="p">]][[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">]]</span>
                <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">grouped_vwAvg</span><span class="p">(</span><span class="n">dfcrsp</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;retadj&#39;</span><span class="p">:</span> <span class="s1">&#39;mktport&#39;</span><span class="p">})</span>

                <span class="c1"># Get the total firm count &#39;num_firms&#39;:</span>
                <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;num_firms&#39;</span><span class="p">})</span>

                <span class="c1"># Remove the following:</span>
                <span class="c1">#   (1) Days landing on Saturday/Sunday which are treated as trading days</span>
                <span class="c1">#   (2) Fridays that are holidays, but included as trading days</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                    <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="p">[(</span><span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
                    <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="p">[(</span><span class="n">dfportSort_nfirms</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>

                <span class="c1"># Having formed market portfolio a la Fama and French:</span>
                <span class="c1"># (1) portfolio returns are then compounded to the proper horizon:</span>
                <span class="c1">#     we use exp(sum(ln(1+r_{t}, ..., ln(1+r_{t+H})) - 1 where H corresponds to the horizon.</span>
                <span class="c1"># (2) number of firms per portfolio is averaged to the proper horizon</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
                    <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">})</span>
                    <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                        <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                              <span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">((</span><span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="o">-</span> <span class="mi">7</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                        <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                                 <span class="n">dfportSort_nfirms</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">((</span><span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="o">-</span> <span class="mi">7</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>

                        <span class="c1"># Filter for non-trading NYSE holidays:</span>
                        <span class="n">dfportSort_ret_eow</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eow&#39;</span><span class="p">})</span>
                        <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfportSort_ret_eow</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                        <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_eow&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfportSort_ret_eow</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfportSort_ret_eow</span>
                        <span class="k">del</span> <span class="n">lst</span>

                        <span class="n">dfportSort_nfirms_eow</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eow&#39;</span><span class="p">})</span>
                        <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfportSort_nfirms_eow</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                        <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_eow&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfportSort_nfirms_eow</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfportSort_nfirms_eow</span>
                        <span class="k">del</span> <span class="n">lst</span>

                    <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                        <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfportSort_nfirms</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfportSort_nfirms</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

                    <span class="c1"># Compound returns.</span>
                    <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mktport&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ln(1+mktport)&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;mktport&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;mktport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;ln(1+mktport)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ln(1+mktport)&#39;</span><span class="p">])</span>

                    <span class="c1"># Average # of firms within each portfolio.</span>
                    <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;num_firms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;num_firms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
                    <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span>

                <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Join &#39;dfportSort_nfirms&#39; w/ &#39;dfportSort_ret&#39; into one dataframe table w/ a multiindex.</span>
                <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()])</span>
                <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;NumFirms&#39;</span><span class="p">],</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()])</span>
                <span class="n">dfportSort_table</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">dfportSort_nfirms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dfportSort_table</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prior_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fBool</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fidList</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">])):</span>
                    <span class="c1"># Construct (1) six value-weighted portfolios formed on size and prior returns (2-12, 1-1, or 13-60), OR...</span>
                    <span class="c1">#           (2) ten value-weighted portfolios formed on prior returns (2-12, 1-1, or 13-60)</span>
                    <span class="c1"># Prior 2-12 returns are used for the momentum factor</span>
                    <span class="c1"># Prior 1-1 returns are used for the short-term reversal factor</span>
                    <span class="c1"># Prior 13-60 returns are used for the long-term reversal factor.</span>
                    <span class="c1"># NOTE: Factors are long winners and short losers, given portfolios sorted on prior (j-k) returns.</span>
                    <span class="c1"># NOTE: size (i.e. &#39;me&#39;) is formed each June of year {t}, while prior returns are formed every month {t}</span>
                    <span class="c1">#        or every day {t}</span>

                    <span class="c1"># Filter annual Compustat data for June of year {t} variables (&#39;me&#39; in df1 is market value of equity for June of year {t})</span>
                    <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                        <span class="n">cols0</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">crsplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">prior_list</span><span class="p">))</span>
                        <span class="n">cols0</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crsplist</span><span class="p">]</span>
                    <span class="n">dfcomp_me</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols0</span><span class="p">]</span>
                    <span class="n">dfcomp_me</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcomp_me</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">),</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="n">dfcomp_me</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
                    <span class="n">dfcomp_me</span> <span class="o">=</span> <span class="n">dfcomp_me</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                    <span class="n">dfcomp_me_nyse</span> <span class="o">=</span> <span class="n">dfcomp_me</span><span class="p">[</span><span class="n">dfcomp_me</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]]</span>
                    <span class="n">dfcomp_me_nyse</span> <span class="o">=</span> <span class="n">dfcomp_me_nyse</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">])</span>

                    <span class="n">crsplist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))))</span>
                    <span class="c1"># Filter monthly CRSP data for prior (j-k) return characteristics.</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cols_prior</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j_per</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cols_prior</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j_per</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span>

                    <span class="n">dfcrsp_prior</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;port_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;me_t&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols_prior</span> <span class="o">+</span> <span class="n">crsplist</span><span class="p">]</span>
                    <span class="n">dfcrsp_prior_nyse</span> <span class="o">=</span> <span class="n">dfcrsp_prior</span><span class="p">[</span><span class="n">dfcrsp_prior</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]]</span>
                    <span class="n">dfcrsp_prior_nyse</span> <span class="o">=</span> <span class="n">dfcrsp_prior_nyse</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">])</span>

                    <span class="c1"># NYSE breakpoints: Merge &#39;dfcomp_me_nyse&#39; w/ &#39;dfcrsp_prior_nyse&#39;:</span>
                    <span class="n">dfnyse</span> <span class="o">=</span> <span class="n">dfcrsp_prior_nyse</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcomp_me_nyse</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>

                    <span class="c1"># NYSE, AMEX, Nasdaq: Merge &#39;dfcomp_me&#39; w/ &#39;dfcrsp_prior&#39;:</span>
                    <span class="n">dfccm</span> <span class="o">=</span> <span class="n">dfcrsp_prior</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcomp_me</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                        <span class="c1"># Construct bivariate buckets corresponding to Fama and French factor portfolio sorts:</span>
                        <span class="c1"># &#39;me&#39; sorts constructed every year (June of year {t})</span>
                        <span class="c1"># &#39;prior (j-k) return&#39; sorts constructed every month {t} (or day {t}).</span>
                        <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">bivariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id2</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Construct univariate bucket corresponding to</span>
                            <span class="c1"># &#39;prior (j-k) return&#39; sorts constructed every month {t} (or day {t}).</span>
                            <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">univariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Construct bivariate buckets corresponding to Fama and French portfolio sorts:</span>
                            <span class="c1"># &#39;me&#39; sorts constructed every year (June of year {t})</span>
                            <span class="c1"># &#39;prior (j-k) return&#39; sorts constructed every month {t} (or day {t}).</span>
                            <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">bivariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id2</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(pDim) exceeds 2&#39;</span><span class="p">)</span>

                    <span class="c1"># NYSE, AMEX, Nasdaq: Merge &#39;dfnyse_breaks&#39; w/ &#39;dfccm&#39;</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">dfccm</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfnyse_breaks</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="s1">&#39;RESVAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
                    <span class="c1"># We construct either:</span>
                    <span class="c1"># (1) Porftolios formed on</span>
                    <span class="c1">#     i.  monthly variance of daily returns (&#39;ret_rollover&#39;), or</span>
                    <span class="c1">#     ii. monthly variance of daily residuals from FF3 model (&#39;resvar&#39;)</span>
                    <span class="c1"># OR...</span>
                    <span class="c1"># (2) Portfolios formed on</span>
                    <span class="c1">#     i.  monthly size (&#39;lme&#39;) and variance of daily returns (&#39;ret_rollover&#39;), or</span>
                    <span class="c1">#     ii. monthly size (&#39;lme&#39;) and variance of daily residuals from FF3 model (&#39;resvar&#39;)</span>
                    <span class="c1"># NOTE: Both are formed at the end of month {t-1}, hence we use &quot;lagged&quot; size (&#39;lme&#39;)</span>
                    <span class="c1"># Filter annual Compustat data for June of year {t} variables</span>
                    <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                        <span class="n">cols0</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">crsplist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))))</span>
                        <span class="n">cols0</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crsplist</span><span class="p">]</span>
                    <span class="n">dfcomp_me</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols0</span><span class="p">]</span>
                    <span class="n">dfcomp_me</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfcomp_me</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;permno&#39;</span><span class="p">),</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="n">dfcomp_me</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
                    <span class="n">dfcomp_me</span> <span class="o">=</span> <span class="n">dfcomp_me</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                    <span class="n">dfcomp_me_nyse</span> <span class="o">=</span> <span class="n">dfcomp_me</span><span class="p">[</span><span class="n">dfcomp_me</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]]</span>
                    <span class="n">dfcomp_me_nyse</span> <span class="o">=</span> <span class="n">dfcomp_me_nyse</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">])</span>

                    <span class="n">crsplist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))))</span>
                    <span class="n">dfcrsp_var</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;lme&#39;</span><span class="p">,</span> <span class="s1">&#39;me_t&#39;</span><span class="p">,</span> <span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">crsplist</span><span class="p">]</span>
                    <span class="n">dfcrsp_var</span> <span class="o">=</span> <span class="n">dfcrsp_var</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lme&#39;</span><span class="p">:</span> <span class="s1">&#39;me&#39;</span><span class="p">})</span>
                    <span class="n">dfcrsp_var_nyse</span> <span class="o">=</span> <span class="n">dfcrsp_var</span><span class="p">[</span><span class="n">dfcrsp_var</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">]]</span>
                    <span class="n">dfcrsp_var_nyse</span> <span class="o">=</span> <span class="n">dfcrsp_var_nyse</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBoolcrsp&#39;</span><span class="p">])</span>

                    <span class="c1"># NYSE breakpoints: Merge &#39;dfcomp_me_nyse&#39; w/ &#39;dfcrsp_var_nyse&#39;:</span>
                    <span class="n">dfnyse</span> <span class="o">=</span> <span class="n">dfcrsp_var_nyse</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcomp_me_nyse</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>

                    <span class="c1"># NYSE, AMEX, Nasdaq: Merge &#39;dfcomp_me&#39; w/ &#39;dfcrsp_prior&#39;:</span>
                    <span class="n">dfccm</span> <span class="o">=</span> <span class="n">dfcrsp_var</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfcomp_me</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Construct univariate bucket corresponding to</span>
                        <span class="c1"># &quot;daily variance&quot;/&quot;monthly residual variance&quot; sorts constructed every month {t}.</span>
                        <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">univariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Construct bivariate buckets corresponding to Fama and French portfolio sorts:</span>
                        <span class="c1"># &#39;me&#39; sorts constructed every month {t}</span>
                        <span class="c1"># &quot;daily variance&quot;/&quot;monthly residual variance&quot; sorts constructed every month {t}.</span>
                        <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">bivariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id2</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(pDim) exceeds 2&#39;</span><span class="p">)</span>

                    <span class="c1"># NYSE, AMEX, Nasdaq: Merge &#39;dfccm&#39; w/ &#39;dfnyse_breaks&#39;.</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">dfccm</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfnyse_breaks</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># NYSE breakpoints:</span>
                    <span class="n">dfnyse</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]]</span>
                    <span class="n">dfnyse</span> <span class="o">=</span> <span class="n">dfnyse</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                        <span class="c1"># Construct bivariate buckets corresponding to Fama French factor portfolio sorts.</span>
                        <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">bivariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id2</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Construct univariate buckets.</span>
                            <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">univariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Construct bivariate buckets.</span>
                            <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">bivariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id2</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="c1"># Construct trivariate buckets.</span>
                            <span class="n">dfnyse_breaks</span> <span class="o">=</span> <span class="n">trivariateSort</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dfnyse</span><span class="p">,</span> <span class="n">id1</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id2</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">id3</span><span class="o">=</span><span class="n">ffcharac_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dim_sort</span><span class="o">=</span><span class="n">pDim</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;len(pDim) exceeds 3!&#39;</span><span class="p">)</span>

                    <span class="c1"># NYSE, AMEX, Nasdaq: Merge &#39;dfnyse_breaks&#39; w/ &#39;df1&#39;.</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfnyse_breaks</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

                <span class="c1"># Re-define Boolean Condition for &#39;df2&#39; (includes NYSE, AMEX, and Nasdaq stocks).</span>
                <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;SMB&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fidType</span> <span class="o">==</span> <span class="s1">&#39;ff3&#39;</span><span class="p">:</span>
                            <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
                                           <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;HML&#39;</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;RMW&#39;</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span>
                            <span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">fidList</span> <span class="o">==</span> <span class="s1">&#39;CMA&#39;</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">fidList</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">]:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> \
                                       <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">j_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">k_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown factor.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Initialize boolean for &#39;df2&#39; w/ any generic column that has all rows set to &#39;True&#39;:</span>
                    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;exchcd&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;ME&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;BE&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;BM&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;bm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">if</span> <span class="s1">&#39;OP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;revt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;xp_allnan&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;INV&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">if</span> <span class="s1">&#39;EP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;ib&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;CFP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;cf&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;DP&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;dp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;AC&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;be&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;d_owcap_adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                    <span class="k">if</span> <span class="s1">&#39;NI&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">:</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;ni&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># NOTE: As a reference, see comments inside function getMEJune(...):</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">:</span>
                            <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">j_per</span><span class="p">,</span> <span class="n">k_per</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">priormonthToDay</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span><span class="p">)</span>

                            <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;prior_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k_month</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">j_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_per</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;l&#39;</span> <span class="o">+</span> <span class="n">k_per</span> <span class="o">+</span> <span class="s1">&#39;_retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;BETA&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>

                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="s1">&#39;RESVAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
                        <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="n">vartype</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>

                <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Get the portfolio bins on the basis of the NYSE thresholds</span>
                <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">ffcharac_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ffcharac</span><span class="p">)</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">getPortfolioBins</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">ffcharac</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">,</span> <span class="n">pDim</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                    <span class="n">cols0</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cols0</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prior_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">fBool</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fidList</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">])):</span>
                    <span class="c1"># Store portfolio assignments as of June of year {t} (for the period from July of year {t} to June of year {t+1}).</span>
                    <span class="n">df4</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;port_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;me_t&#39;</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">+</span> \
                              <span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span> <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols0</span><span class="p">]</span>

                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="s1">&#39;RESVAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
                    <span class="n">cols0</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols0</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">vartype</span><span class="p">]]</span>
                    <span class="n">df4</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;me_t&#39;</span><span class="p">,</span> <span class="n">vartype</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">+</span> \
                              <span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span> <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Store portfolio assignments as of June of year {t} (for the period from July of year {t} to June of year {t+1}).</span>
                    <span class="n">cols1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span> <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols0</span>
                    <span class="n">cols2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span> <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols0</span>

                    <span class="n">df3</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">cols1</span><span class="p">]</span>
                    <span class="n">df3</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">df3</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">cols1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="n">df3</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
                    <span class="n">dfcrsp</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">,</span> <span class="s1">&#39;shrcd&#39;</span><span class="p">,</span> <span class="s1">&#39;exchcd&#39;</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="s1">&#39;port_weight&#39;</span><span class="p">,</span> <span class="s1">&#39;me_t&#39;</span><span class="p">]]</span>

                    <span class="c1"># &#39;df4&#39; contains all observations in addition to those from June of year {t}</span>
                    <span class="n">df4</span> <span class="o">=</span> <span class="n">dfcrsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">df3</span><span class="p">[</span><span class="n">cols2</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ffyear&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;VAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="s1">&#39;RESVAR&#39;</span> <span class="ow">in</span> <span class="n">fidList</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
                    <span class="n">port_weight</span> <span class="o">=</span> <span class="s1">&#39;me&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">port_weight</span> <span class="o">=</span> <span class="s1">&#39;port_weight&#39;</span>

                <span class="c1"># Keep only records that meet the following criteria:</span>
                <span class="c1">#   (1) portfolio weights: &#39;port_weight&#39; (or &#39;me&#39;) &gt; 0</span>
                <span class="c1">#   (2) NYSE, AMEX, and NASDAQ firms: &#39;shrcd&#39; in [10, 11]</span>
                <span class="c1">#   (3) value of portfolio&#39;s formed on &#39;sortCharacsId&#39; are non-missing.</span>
                <span class="n">sBool</span> <span class="o">=</span> <span class="p">(</span><span class="n">df4</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df4</span><span class="p">[</span><span class="n">port_weight</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df4</span><span class="p">[</span><span class="s1">&#39;shrcd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">:</span>
                    <span class="n">sBool</span> <span class="o">=</span> <span class="n">sBool</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df4</span><span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df4</span><span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
                <span class="n">df5</span> <span class="o">=</span> <span class="n">df4</span><span class="p">[</span><span class="n">sBool</span><span class="p">]</span>
                <span class="n">df4</span><span class="p">,</span> <span class="n">df5</span> <span class="o">=</span> <span class="n">df4</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">]),</span> <span class="n">df5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sBool&#39;</span><span class="p">])</span>

                <span class="n">cols1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ffcharac</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span> <span class="k">for</span> <span class="n">ffcharac</span> <span class="ow">in</span> <span class="n">ffcharac_list</span><span class="p">]</span>
                <span class="n">cols_port</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ffcharac_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_port&#39;</span>

                <span class="k">if</span> <span class="n">pRetType</span> <span class="o">==</span> <span class="s1">&#39;vw&#39;</span><span class="p">:</span>
                    <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">grouped_vwAvg</span><span class="p">(</span><span class="n">df5</span><span class="p">,</span> <span class="s1">&#39;retadj&#39;</span><span class="p">,</span> <span class="n">port_weight</span><span class="p">,</span> <span class="n">cols1</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;retadj&#39;</span><span class="p">:</span> <span class="s1">&#39;vwret&#39;</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">pRetType</span> <span class="o">==</span> <span class="s1">&#39;ew&#39;</span><span class="p">:</span>
                    <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">df5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols1</span><span class="p">)[</span><span class="s1">&#39;retadj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;retadj&#39;</span><span class="p">:</span> <span class="s1">&#39;ewret&#39;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">pRetType</span><span class="se">\&#39;</span><span class="s1"> is not one of </span><span class="se">\&#39;</span><span class="s1">wv</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">ew</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="n">dfport_ret</span><span class="p">[</span><span class="n">cols_port</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;_port$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

                <span class="c1"># Average (value-weighted) anomaly characteristics within each portfolio.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fBool</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">def</span> <span class="nf">create_pivot_table</span><span class="p">(</span><span class="n">df0</span><span class="p">,</span> <span class="n">charac</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">groupby_cols</span><span class="p">,</span> <span class="n">portname</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        For each anomaly portfolio characteristic,</span>
<span class="sd">                        implement &#39;pd.pivot()&#39; method in order to spread &quot;rows&quot; into &quot;columns&quot;</span>
<span class="sd">                        This routine is executed in a dictionary comprehension.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="k">if</span> <span class="n">charac</span> <span class="o">==</span> <span class="s1">&#39;me&#39;</span><span class="p">:</span>
                            <span class="n">weightType</span> <span class="o">=</span> <span class="s1">&#39;ewavg&#39;</span>
                            <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">df0</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby_cols</span><span class="p">)[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">charac</span><span class="p">:</span> <span class="n">weightType</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">charac</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">weightType</span> <span class="o">=</span> <span class="s1">&#39;vwavg&#39;</span>
                            <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">grouped_vwAvg</span><span class="p">(</span><span class="n">df0</span><span class="p">,</span> <span class="n">charac</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">groupby_cols</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">charac</span><span class="p">:</span> <span class="n">weightType</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">charac</span><span class="p">})</span>
                        <span class="n">dfgroupwavg</span><span class="p">[</span><span class="n">portname</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;_port$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

                        <span class="c1"># Remove the following:</span>
                        <span class="c1">#   (1) Days landing on Saturday or Sunday which are treated as trading days,</span>
                        <span class="c1">#   (2) Fridays that are holidays, but included as trading days</span>
                        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                            <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="p">[(</span><span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
                        <span class="c1"># Having formed portfolios a la Fama and French, collapse monthly value-weighted (vw) or equal-weighted (ew)</span>
                        <span class="c1"># characteristics to lower frequency time-averages if freq in [&#39;W&#39;, &#39;Q&#39;, &#39;A&#39;].</span>
                        <span class="c1"># NOTE: For the following anomaly characteristics: &#39;BM&#39;, &#39;OP&#39;, &#39;INV&#39;, &#39;EP&#39;, &#39;CFP&#39;, &#39;DP&#39;, &#39;AC&#39;, &#39;BETA&#39;, &#39;NI&#39;,</span>
                        <span class="c1">#       annual (&#39;A&#39;) vw or ew-average characteristics are defined as vw or ew-average formation-period characteristics</span>
                        <span class="c1">#       for each portfolio as of the portfolio formation date in June of year {t}.</span>
                        <span class="c1">#       Example: For portfolio &quot;X&quot;, the vw or ew-average &#39;BM&#39; for 1998 is taken to</span>
                        <span class="c1">#                be the vw or ew-average &#39;BM&#39; as of June 1998.</span>
                        <span class="c1"># NOTE: For anomaly characteristics: &#39;PRIOR_1_1&#39;, &#39;PRIOR_2_12&#39;, &#39;PRIOR_13_60&#39;, annual (&#39;A&#39;) anomaly</span>
                        <span class="c1">#       characteristics are average vw or ew-average characteristics within each year {t}.</span>
                        <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
                            <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">})</span>
                            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                                <span class="c1"># Apply similar procedure when going from daily to weekly equal-weighted &#39;me&#39;, when applicable.</span>
                                <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                                   <span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">((</span><span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="o">-</span> <span class="mi">7</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>

                                <span class="c1"># Collapse days to end of week frequencies.</span>
                                <span class="n">dfgroupwavg_eow</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eow&#39;</span><span class="p">})</span>
                                <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfgroupwavg_eow</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                                <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_eow&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>

                                <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfgroupwavg_eow</span><span class="p">]</span>
                                <span class="k">del</span> <span class="n">dfgroupwavg_eow</span>
                                <span class="k">del</span> <span class="n">lst</span>

                            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                                <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

                            <span class="c1"># NOTE: Annual characteristics are constructed according a la Fama and French:</span>
                            <span class="c1">#       (i.e. using the portfolio formation month July within each year {t}).</span>
                            <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">]:</span>
                                <span class="c1"># Average value-weighted returns within each year {t}</span>
                                <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;prior&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">charac</span><span class="p">:</span>
                                    <span class="c1"># Keep portfolio-formation period vw or ew-average characteristics (July of each year {t}).</span>
                                    <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="p">[(</span><span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="p">[[</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">weightType</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">charac</span><span class="p">]]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Average value-weighted returns within each year {t}.</span>
                                    <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

                                    <span class="c1"># Since annual data should be for each full calendar year, we exclude data that may be incomplete in a final year.</span>
                                    <span class="n">dfgroupwavg</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="p">[</span><span class="n">dfgroupwavg</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">]</span>

                        <span class="n">dfgroupwavgTable</span> <span class="o">=</span> <span class="n">dfgroupwavg</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_port</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">weightType</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">charac</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                        <span class="n">dfgroupwavgTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfgroupwavgTable</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                        <span class="n">dfgroupwavgTable</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">charac</span> <span class="o">==</span> <span class="s1">&#39;me&#39;</span><span class="p">:</span>
                            <span class="n">dfgroupwavgTable</span> <span class="o">=</span> <span class="n">dfgroupwavgTable</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># USD millions --&gt; USD billions</span>
                        <span class="k">return</span> <span class="n">dfgroupwavgTable</span>

                    <span class="c1"># For each value-weighted average anomaly characteristic, &#39;pd.pivot()&#39; method is used to spread &quot;rows&quot; into &quot;columns&quot;</span>
                    <span class="n">dfportSort_characs</span> <span class="o">=</span> <span class="p">{</span><span class="n">charac</span><span class="p">:</span> <span class="n">create_pivot_table</span><span class="p">(</span><span class="n">df5</span><span class="p">,</span> <span class="n">charac</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="s1">&#39;me_t&#39;</span><span class="p">,</span> <span class="n">cols1</span><span class="p">,</span> <span class="n">cols_port</span><span class="p">)</span> <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))}</span>

                <span class="c1"># Get the total firm count &#39;num_firms&#39;:</span>
                <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">df5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;num_firms&#39;</span><span class="p">})</span>
                <span class="n">dfport_nfirms</span><span class="p">[</span><span class="n">cols_port</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;_port$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

                <span class="c1"># Remove the following:</span>
                <span class="c1">#   (1) Days landing on Saturday or Sunday which are treated as trading days,</span>
                <span class="c1">#   (2) Fridays that are holidays, but included as trading days</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                    <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="p">[(</span><span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
                    <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="p">[(</span><span class="n">dfport_nfirms</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>

                <span class="c1"># Having formed portfolios a la Fama and French:</span>
                <span class="c1">#   (1) portfolio returns are then compounded to the proper horizon:</span>
                <span class="c1">#       we use exp(sum(ln(1+r_{t}, ..., ln(1+r_{t+H})) - 1 where H corresponds to the horizon.</span>
                <span class="c1">#   (2) number of firms per portfolio is averaged to the proper horizon</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
                    <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">})</span>
                    <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;date_crsp&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                        <span class="n">dfport_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                          <span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">((</span><span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="o">-</span> <span class="mi">7</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>
                        <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                                             <span class="n">dfport_nfirms</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">((</span><span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="o">-</span> <span class="mi">7</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span>

                        <span class="c1"># Collapse days to end of week frequencies.</span>
                        <span class="n">dfport_ret_eow</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eow&#39;</span><span class="p">})</span>
                        <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfport_ret_eow</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                        <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_eow&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfport_ret_eow</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfport_ret_eow</span>
                        <span class="k">del</span> <span class="n">lst</span>

                        <span class="n">dfport_nfirms_eow</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">:</span> <span class="s1">&#39;date_eow&#39;</span><span class="p">})</span>
                        <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">dfport_nfirms_eow</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                        <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date_eow&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>

                        <span class="c1"># Delete pandas.DataFrame no longer needed in memory.</span>
                        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfport_nfirms_eow</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">dfport_nfirms_eow</span>
                        <span class="k">del</span> <span class="n">lst</span>

                    <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                        <span class="n">dfport_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfport_nfirms</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfport_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">dfport_nfirms</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">YearEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

                        <span class="c1"># Since annual data should be for each full calendar year, we exclude data that may be incomplete in a final year.</span>
                        <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="p">[</span><span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">]</span>
                        <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="p">[</span><span class="n">dfport_nfirms</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">dt_end</span><span class="p">]</span>

                    <span class="c1"># Compound returns.</span>
                    <span class="n">dfport_ret</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dfport_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;vwret&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ln(1+vwret)&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfport_ret</span><span class="p">[</span><span class="s1">&#39;vwret&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">dfport_ret</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;vwret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dfport_ret</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;ln(1+vwret)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">dfport_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ln(1+vwret)&#39;</span><span class="p">])</span>

                    <span class="c1"># Average # of firms within each portfolio.</span>
                    <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;num_firms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="s1">&#39;num_firms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
                    <span class="n">dfport_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">cols_port</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date_crsp&#39;</span><span class="p">])</span>

                <span class="c1"># Spread &quot;rows&quot; into &quot;columns&quot; using &#39;pd.pivot()&#39; method.</span>
                <span class="n">dfportSort_ret</span> <span class="o">=</span> <span class="n">dfport_ret</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_port</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;vwret&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">dfportSort_nfirms</span> <span class="o">=</span> <span class="n">dfport_nfirms</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_port</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;num_firms&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

                <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_nfirms</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Join &#39;dfportSort_nfirms&#39; w/ &#39;dfportSort_ret&#39; into one dataframe table w/ a multiindex.</span>
                <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;Returns&#39;</span><span class="p">],</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()])</span>
                <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s1">&#39;NumFirms&#39;</span><span class="p">],</span> <span class="n">dfportSort_nfirms</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()])</span>
                <span class="n">dfportSort_table</span> <span class="o">=</span> <span class="n">dfportSort_ret</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">dfportSort_nfirms</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">fBool</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">dfportSort_table</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">dfportSort_table</span><span class="p">,</span> <span class="n">dfportSort_characs</span>

        <span class="c1"># Market value of equity as of June of year {t}.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mergeCCM</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>

        <span class="c1"># TODO: Per Fama and French (see Ken French&#39;s online documentation):</span>
        <span class="c1"># ...&quot;In May 2015, we made two changes in the way we compute daily portfolio returns so the process is</span>
        <span class="c1">#     closer to the way we compute monthly portfolio returns. In daily files produced in May 2015 or thereafter,</span>
        <span class="c1">#     stocks are dropped from a portfolio immediately after their CRSP delist date;</span>
        <span class="c1">#     in files produced before May 2015, those stocks are held until the portfolio is reconstituted, at the end of June.</span>
        <span class="c1">#     Also, in daily files produced before May 2015 we exclude a stock from portfolios during any period in which it is</span>
        <span class="c1">#     missing prices for more than 10 consecutive trading days; in daily files produced in May 2015 and thereafter,</span>
        <span class="c1">#     we exclude a stock if there is no price for more than 200 consecutive trading days.&quot;</span>

        <span class="k">if</span> <span class="n">factorsBool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;RMW&#39;</span><span class="p">],</span> <span class="n">idList</span><span class="p">):</span>
                <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">fffactor</span><span class="p">:</span> <span class="n">_getNyseThresholds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">,</span> <span class="n">fffactor</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;ff5&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">fffactor</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idList</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Constructing Fama-French return factor(s)&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If both &#39;SMB&#39; &amp; &#39;HML&#39; are in &#39;idList&#39;, then we don&#39;t need to construct the same set of 6 (2x3) portfolios twice!</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">((</span><span class="n">f</span> <span class="ow">in</span> <span class="n">idList</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;HML&#39;</span><span class="p">]):</span>
                    <span class="n">idList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;HML&#39;</span><span class="p">)</span>
                    <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="p">{</span><span class="n">fffactor</span><span class="p">:</span> <span class="n">_getNyseThresholds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">,</span> <span class="n">fffactor</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;ff3&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">fffactor</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idList</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Constructing Fama-French return factor(s)&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>
                    <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span>
                    <span class="n">idList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;HML&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="p">{</span><span class="n">fffactor</span><span class="p">:</span> <span class="n">_getNyseThresholds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">,</span> <span class="n">fffactor</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;ff3&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">fffactor</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idList</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Constructing Fama-French return factor(s)&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)}</span>
            <span class="k">if</span> <span class="s1">&#39;MKT-RF&#39;</span> <span class="ow">in</span> <span class="n">idList</span><span class="p">:</span>
                <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;MKT-RF&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dfportSort_tableList</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">dfportSort_characs</span> <span class="o">=</span> <span class="n">_getNyseThresholds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfccm_june</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfcrsp3</span><span class="p">,</span> <span class="n">idList</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">dfportSort_characs</span></div>



<div class="viewcode-block" id="FamaFrench.getPortfolios"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getPortfolios.html#famafrench.FamaFrench.getPortfolios">[docs]</a>    <span class="k">def</span> <span class="nf">getPortfolios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portLevel</span><span class="p">,</span> <span class="n">factorsBool</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generalized routine used to construct datasets containing portfolio returns (which may include factor returns),</span>
<span class="sd">        number of firms in each portfolio, or `average` anomaly portfolio characteristics</span>
<span class="sd">        at a given frequency and for a given sample period.  See subroutines for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        portLevel : str</span>
<span class="sd">            Dataset type to construct. Possible choices are:</span>

<span class="sd">                * ``Returns``</span>
<span class="sd">                * ``NumFirms``</span>
<span class="sd">                * ``Characs``</span>
<span class="sd">        factorsBool : bool</span>
<span class="sd">            Flag for choosing whether to construct Fama-French factors or not.</span>
<span class="sd">            If `True`, then ``portLevel`` must be one of the following: ``Returns``, ``NumFirms``.</span>
<span class="sd">            Otherwise, it must be one of the following:</span>

<span class="sd">                * ``Returns``</span>
<span class="sd">                * ``NumFirms``</span>
<span class="sd">                * ``Characs``</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start: datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end: datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        dim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``idList``.</span>
<span class="sd">            For example, if ``idList = [&#39;ME&#39;, &#39;BM&#39;]`` and ``dim = [5, 5]``, then the portfolio sorting strategy</span>
<span class="sd">            is characterized by a bivariate quintile sort on both `size` and `book-to-market`.</span>
<span class="sd">        retType : str, [optional]</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        portTable : pandas.DataFrame, or dict, pandas.DataFrame</span>
<span class="sd">            Dataset(s) w/ portfolio returns (which may include factor returns), number of firms in each portfolio,</span>
<span class="sd">            or `average` anomaly portfolio characteristics observed at frequency ``freq``</span>
<span class="sd">            over sample period from ``dt_start`` to ``dt_end`` for a given portfolio sorting strategy.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">reorder_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols_list</span><span class="p">):</span>
            <span class="n">cati</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalIndex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">cols_list</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">cati</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">factorsBool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">portLevel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFactorReg</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;RMW&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;CMA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CMA&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;RMW&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;CMA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RMW&#39;</span><span class="p">)</span>
                <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
                <span class="n">portTable</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="s1">&#39;MKT-RF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">:</span>
                    <span class="n">mkt_portTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span>
                    <span class="n">portTable</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mkt_portTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">portLevel</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="s1">&#39;HML&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">):</span>
                    <span class="n">cols_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;me0-50_bm70-100&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALL LOBM&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;me0-50_bm30-70&#39;</span><span class="p">:</span> <span class="s1">&#39;ME1 BM2&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;me0-50_bm0-30&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALL HIBM&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;me50-100_bm70-100&#39;</span><span class="p">:</span> <span class="s1">&#39;BIG LOBM&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;me50-100_bm30-70&#39;</span><span class="p">:</span> <span class="s1">&#39;ME2 BM2&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;me50-100_bm0-30&#39;</span><span class="p">:</span> <span class="s1">&#39;BIG HIBM&#39;</span><span class="p">}</span>
                    <span class="n">cols_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SMALL HIBM&#39;</span><span class="p">,</span> <span class="s1">&#39;ME1 BM2&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL LOBM&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;BIG HIBM&#39;</span><span class="p">,</span> <span class="s1">&#39;ME2 BM2&#39;</span><span class="p">,</span> <span class="s1">&#39;BIG LOBM&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;SMB&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">:</span>
                        <span class="n">smb_portTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span>
                        <span class="n">smb_portTable</span> <span class="o">=</span> <span class="n">smb_portTable</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_dict</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">portTable</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reorder_columns</span><span class="p">(</span><span class="n">smb_portTable</span><span class="p">,</span> <span class="n">cols_order</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">portLevel</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;HML&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">:</span>
                        <span class="n">hml_portTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span>
                        <span class="n">hml_portTable</span> <span class="o">=</span> <span class="n">hml_portTable</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_dict</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">portTable</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reorder_columns</span><span class="p">(</span><span class="n">hml_portTable</span><span class="p">,</span> <span class="n">cols_order</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">portLevel</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span> <span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;RMW&#39;</span><span class="p">:</span>
                            <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;op&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;CMA&#39;</span><span class="p">:</span>
                            <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;inv&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;MOM&#39;</span><span class="p">:</span>
                            <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_2_12&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">:</span>
                            <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_1_1&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_13_60&#39;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">]:</span>
                            <span class="n">cols_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;me0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALL LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                         <span class="s1">&#39;me0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;30-70&#39;</span><span class="p">:</span> <span class="s1">&#39;ME1 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;me0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALL HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                         <span class="s1">&#39;me50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">:</span> <span class="s1">&#39;BIG LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                         <span class="s1">&#39;me50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;30-70&#39;</span><span class="p">:</span> <span class="s1">&#39;ME2 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;me50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">:</span> <span class="s1">&#39;BIG HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()}</span>
                            <span class="n">cols_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SMALL LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;ME1 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;SMALL HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                          <span class="s1">&#39;BIG LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;ME2 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;BIG HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                            <span class="n">fportTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;CMA&#39;</span><span class="p">]</span>
                            <span class="n">fportTable</span> <span class="o">=</span> <span class="n">fportTable</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_dict</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">portTable</span><span class="p">[</span><span class="s1">&#39;CMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reorder_columns</span><span class="p">(</span><span class="n">fportTable</span><span class="p">,</span> <span class="n">cols_order</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">portLevel</span><span class="p">]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cols_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;me0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALL HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                         <span class="s1">&#39;me0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;30-70&#39;</span><span class="p">:</span> <span class="s1">&#39;ME1 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;me0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">:</span> <span class="s1">&#39;SMALL LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                         <span class="s1">&#39;me50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">:</span> <span class="s1">&#39;BIG HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                         <span class="s1">&#39;me50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;30-70&#39;</span><span class="p">:</span> <span class="s1">&#39;ME2 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;me50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">:</span> <span class="s1">&#39;BIG LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()}</span>
                            <span class="n">cols_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SMALL HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;ME1 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;SMALL LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                          <span class="s1">&#39;BIG HI&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;ME2 &#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;BIG LO&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                            <span class="n">fportTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                            <span class="n">fportTable</span> <span class="o">=</span> <span class="n">fportTable</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_dict</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">portTable</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">reorder_columns</span><span class="p">(</span><span class="n">fportTable</span><span class="p">,</span> <span class="n">cols_order</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">portLevel</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">portTable</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">portLevel</span><span class="se">\&#39;</span><span class="s1"> is not one of </span><span class="se">\&#39;</span><span class="s1">Returns</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">NumFirms</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">portLevel</span> <span class="o">==</span> <span class="s1">&#39;Returns&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span><span class="p">)</span>
                    <span class="n">portTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">portTable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">retType</span><span class="se">\&#39;</span><span class="s1"> is not a string w/ weighting scheme for portfolio returns.&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">portLevel</span> <span class="o">==</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dfportSort_tableList</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
                    <span class="n">portTable</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">portTable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">portLevel</span> <span class="o">==</span> <span class="s1">&#39;Characs&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">dfportSort_characs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
                    <span class="n">portTable</span> <span class="o">=</span> <span class="n">dfportSort_characs</span>
                    <span class="k">return</span> <span class="n">portTable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">portLevel</span><span class="se">\&#39;</span><span class="s1"> is not one of </span><span class="se">\&#39;</span><span class="s1">Returns</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">NumFirms</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">Characs</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="FamaFrench.getPortfolioReturns"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getPortfolioReturns.html#famafrench.FamaFrench.getPortfolioReturns">[docs]</a>    <span class="k">def</span> <span class="nf">getPortfolioReturns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorsBool</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct dataset w/ portfolio returns (which may include factor returns)</span>
<span class="sd">        at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        factorsBool : bool</span>
<span class="sd">            Flag for choosing whether to construct Fama-French-style factor returns or not.</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        pDim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>
<span class="sd">        pRetType : str, [optional]</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        portRetTable: pandas.DataFrame</span>
<span class="sd">            Dataset w/ portfolio returns observed at frequency ``self.freqType``</span>
<span class="sd">            over sample period from ``dt_start`` to ``dt_end`` for a given portfolio sorting strategy.</span>
<span class="sd">        </span>
<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Portfolios require anomaly characteristics from the last fiscal year.</span>
<span class="sd">        To get non-missing observations starting on date ``dt_start``, we construct portfolios using a startdate that is two/three years prior to ``dt_start``.</span>
<span class="sd">        We then slice the resulting pandas.DataFrames starting w/ ``dt_start``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">factorsBool</span><span class="p">:</span>
            <span class="n">portRetTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolios</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">)</span>
            <span class="n">portRetTable</span> <span class="o">=</span> <span class="n">portRetTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">portRetTable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">pDim</span><span class="p">,</span> <span class="n">pRetType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Need # of elements in </span><span class="se">\&#39;</span><span class="s1">pDim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">portRetTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolios</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">pDim</span><span class="p">,</span> <span class="n">pRetType</span><span class="p">)</span>
                    <span class="n">portRetTable</span> <span class="o">=</span> <span class="n">portRetTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">portRetTable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">pDim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">pRetType</span><span class="se">\&#39;</span><span class="s1"> is not a string w/ weighting scheme for portfolio returns.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="FamaFrench.getNumFirms"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getNumFirms.html#famafrench.FamaFrench.getNumFirms">[docs]</a>    <span class="k">def</span> <span class="nf">getNumFirms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorsBool</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct dataset w/ number of firms in each portfolio at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        factorsBool : bool</span>
<span class="sd">            Flag for choosing whether to construct Fama-French-style factors or not.</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        pDim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        portNFirmsTable : pandas.DataFrame</span>
<span class="sd">             Dataset w/ number of firms in each portfolio observed at frequency ``self.freqType``</span>
<span class="sd">             over sample period from ``dt_start`` to ``dt_end`` for a given portfolio sorting strategy.</span>

<span class="sd">        Note</span>
<span class="sd">        ____</span>
<span class="sd">        If ``factorsBool = True``, then the number of firms for the following anomaly/risk-based factors is defined as follows:</span>

<span class="sd">            * ``MKT`` : total number of firms (each period) in the market portfolio.</span>
<span class="sd">            * ``SMB``, ``HML``, ``RMW``, ``RMWc``, ``CMA``, ``MOM``, ``ST_Rev``, ``LT_Rev`` : total number of firms (each period) in all portfolios used to construct the factors.</span>

<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Portfolios require anomaly characteristics from the last fiscal year.</span>
<span class="sd">        To get non-missing observations starting on date ``dt_start``, we construct portfolios using a startdate that is two/three years prior to ``dt_start``.</span>
<span class="sd">        We then slice the resulting pandas.DataFrames starting w/ ``dt_start``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">factorsBool</span><span class="p">:</span>
            <span class="n">portNFirmsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolios</span><span class="p">(</span><span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">)</span>
            <span class="n">portNFirmsTable</span> <span class="o">=</span> <span class="n">portNFirmsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">portNFirmsTable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">pDim</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Need # of elements in </span><span class="se">\&#39;</span><span class="s1">pDim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">portNFirmsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolios</span><span class="p">(</span><span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">pDim</span><span class="p">)</span>
                    <span class="n">portNFirmsTable</span> <span class="o">=</span> <span class="n">portNFirmsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">portNFirmsTable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">pDim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FamaFrench.getCharacs"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getCharacs.html#famafrench.FamaFrench.getCharacs">[docs]</a>    <span class="k">def</span> <span class="nf">getCharacs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factorsBool</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct `average` anomaly portfolio characteristics at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        factorsBool : bool</span>
<span class="sd">            Flag for choosing whether to construct Fama-French-style factors or not.</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        pDim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        portCharacsTable: pandas.DataFrame or dict, pandas.DataFrame</span>
<span class="sd">            Dataset w/ `average` portfolio characteristics observed at frequency ``self.freqType``</span>
<span class="sd">            over sample period from ``dt_start`` to ``dt_end`` for a given portfolio sorting strategy.</span>

<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Portfolios require anomaly characteristics from the last fiscal year.</span>
<span class="sd">        To get non-missing observations starting on date ``dt_start``, we construct portfolios using a startdate that is two/three years prior to ``dt_start``.</span>
<span class="sd">        We then slice the resulting pandas.DataFrames starting w/ ``dt_start``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">factorsBool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Value-weighted average characteristics can</span><span class="se">\&#39;</span><span class="s1">t be obtained when </span><span class="se">\&#39;</span><span class="s1">factorsBool</span><span class="se">\&#39;</span><span class="s1"> is True.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">pDim</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pDim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Need # of elements in </span><span class="se">\&#39;</span><span class="s1">pDim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">portCharacsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolios</span><span class="p">(</span><span class="s1">&#39;Characs&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">pDim</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                        <span class="n">portCharacsTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">portCharacsTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">portCharacsTable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">pDim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="FamaFrench.getFFfactors"><a class="viewcode-back" href="../../portfolios/generated/famafrench.FamaFrench.getFFfactors.html#famafrench.FamaFrench.getFFfactors">[docs]</a>    <span class="k">def</span> <span class="nf">getFFfactors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct dataset w/  Fama-French-style factors at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        ffFactorsTable: pandas.DataFrame</span>
<span class="sd">            Dataset with set of Fama-French-style factors observed at frequency ``self.freqType``</span>
<span class="sd">            over sample period from ``dt_start`` to ``dt_end``.</span>

<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Portfolios require anomaly characteristics from the last fiscal year.</span>
<span class="sd">        To get non-missing observations starting on date ``dt_start``, we construct portfolios using a startdate that is two/three years prior to ``dt_start``.</span>
<span class="sd">        We then slice the resulting pandas.DataFrames starting w/ ``dt_start``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;RMW&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;CMA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CMA&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;RMW&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;CMA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RMW&#39;</span><span class="p">)</span>
        <span class="n">dfportSort_tableList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNyseThresholdsAndRet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsIdtemp</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">)</span>
        <span class="n">ffFactorsTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;MKT-RF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
            <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;mktport&#39;</span><span class="p">)]</span>
            <span class="n">ffFactorsTable</span> <span class="o">=</span> <span class="n">ffFactorsTable</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queryrf1m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqType</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
            <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;mkt-rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;mkt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span>
            <span class="n">ffFactorsTable</span> <span class="o">=</span> <span class="n">ffFactorsTable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;RMW&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SMB&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">):</span>
            <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;smb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_bm30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_bm0-30&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                                    <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me50-100_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm0-30&#39;</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;SMB&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;SMB_bm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_bm30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_bm0-30&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                                           <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me50-100_bm70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_bm0-30&#39;</span><span class="p">))])</span>
                <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;SMB_op&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;RMW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_op70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_op30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_op0-30&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                                           <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;RMW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me50-100_op70-100&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_op30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_op0-30&#39;</span><span class="p">))])</span>
                <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;SMB_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;CMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me0-50_inv0-30&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_inv30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50_inv70-100&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                                            <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="s1">&#39;CMA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;me50-100_inv0-30&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_inv30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100_inv70-100&#39;</span><span class="p">))])</span>
                <span class="n">ffFactorsTable</span><span class="p">[</span><span class="s1">&#39;smb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">ffFactorsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;SMB_bm&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB_op&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB_inv&#39;</span><span class="p">]])</span>
                <span class="n">ffFactorsTable</span> <span class="o">=</span> <span class="n">ffFactorsTable</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SMB_bm&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB_op&#39;</span><span class="p">,</span> <span class="s1">&#39;SMB_inv&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span> <span class="s1">&#39;RMW&#39;</span><span class="p">,</span> <span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;MOM&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;HML&#39;</span><span class="p">:</span>
                    <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;bm&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;RMW&#39;</span><span class="p">:</span>
                    <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;op&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;CMA&#39;</span><span class="p">:</span>
                    <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;inv&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;MOM&#39;</span><span class="p">:</span>
                    <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_2_12&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">:</span>
                    <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_1_1&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_13_60&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">]:</span>
                    <span class="n">ffFactorsTable</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">,</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                                                <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">,</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">))])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ffFactorsTable</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">,</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">))])</span> <span class="o">-</span> \
                                                <span class="n">utils</span><span class="o">.</span><span class="n">portRetAvg</span><span class="p">(</span><span class="n">dfportSort_tableList</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-50_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">,</span> <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;50-100_&#39;</span> <span class="o">+</span> <span class="n">flist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">))])</span>

        <span class="n">ffFactorsTable</span> <span class="o">=</span> <span class="n">ffFactorsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">ffFactorsTable</span></div>



<div class="viewcode-block" id="FamaFrench.getFamaFrenchStats"><a class="viewcode-back" href="../../statistics-diagnostics/generated/famafrench.FamaFrench.getFamaFrenchStats.html#famafrench.FamaFrench.getFamaFrenchStats">[docs]</a>    <span class="k">def</span> <span class="nf">getFamaFrenchStats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataType</span><span class="p">,</span> <span class="n">dataFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detailed summary statistics tables of portfolio returns (which may include factor returns),</span>
<span class="sd">        number of firms in each portfolio, or `average` anomaly portfolio characteristics</span>
<span class="sd">        at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        dataType : str</span>
<span class="sd">            Dataset type to construct. Possible choices are:</span>

<span class="sd">                * ``Returns``</span>
<span class="sd">                * ``Factors``</span>
<span class="sd">                * ``NumFirms``</span>
<span class="sd">                * ``Characs``</span>
<span class="sd">        dataFreq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start: datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end: datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        pDim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``idList``.</span>
<span class="sd">            For example, if ``idList = [&#39;ME&#39;, &#39;BM&#39;]`` and ``dim = [5, 5]``, then the portfolio sorting strategy</span>
<span class="sd">            is characterized by a bivariate quintile sort on both `size` and `book-to-market`.</span>
<span class="sd">        pRetType : str, [optional]</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        None</span>

<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Currently, this method **only** prints out a table w/ detailed summary statistics. Future versions of the package will</span>
<span class="sd">        provide more in-depth statistical analysis and their outputs.</span>

<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Portfolios require anomaly characteristics from the last fiscal year.</span>
<span class="sd">        To get non-missing observations starting on date ``dt_start``, we construct portfolios using a startdate that is two/three years prior to ``dt_start``.</span>
<span class="sd">        We then slice the resulting pandas.DataFrames starting w/ ``dt_start``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Factors&#39;</span><span class="p">:</span>
            <span class="n">factorsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFFfactors</span><span class="p">(</span><span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">factorsTable</span> <span class="o">=</span> <span class="n">factorsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** Summary Statistics: Fama-French Factors ***********************************&#39;</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_statsTable</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">dataFreq</span><span class="p">,</span> <span class="n">factorsTable</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="s1">&#39;Characs&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dataType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="s1">&#39;Characs&#39;</span><span class="p">]:</span>
                <span class="n">pDim</span><span class="p">,</span> <span class="n">pRetType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pDim</span><span class="p">,</span> <span class="n">pRetType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;Returns&#39;</span><span class="p">:</span>
                <span class="n">returnsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolioReturns</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">pDim</span><span class="p">,</span> <span class="n">pRetType</span><span class="p">)</span>
                <span class="n">returnsTable</span> <span class="o">=</span> <span class="n">returnsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** Summary Statistics: Portfolio Returns ***********************************&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;          *********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_statsTable</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">dataFreq</span><span class="p">,</span> <span class="n">returnsTable</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">:</span>
                <span class="n">firmsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumFirms</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">pDim</span><span class="p">)</span>
                <span class="n">firmsTable</span> <span class="o">=</span> <span class="n">firmsTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** Summary Statistics: Number of Firms ***********************************&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;          *********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_statsTable</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">dataFreq</span><span class="p">,</span> <span class="n">firmsTable</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">characsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCharacs</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">pDim</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** Summary Statistics: Firm Characteristics ***********************************&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;          *********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ************************** (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;) ***************************&#39;</span><span class="p">)</span>
                    <span class="n">characsTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">characsTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_statsTable</span><span class="p">(</span><span class="n">dataType</span><span class="p">,</span> <span class="n">dataFreq</span><span class="p">,</span> <span class="n">characsTable</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dataType</span><span class="se">\&#39;</span><span class="s1"> is not one of </span><span class="se">\&#39;</span><span class="s1">Returns</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Factors</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">NumFirms</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">Characs</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="FamaFrench.kfLibrary"><a class="viewcode-back" href="../../kflibrary/generated/famafrench.FamaFrench.kfLibrary.html#famafrench.FamaFrench.kfLibrary">[docs]</a>    <span class="k">def</span> <span class="nf">kfLibrary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kfType</span><span class="p">,</span> <span class="n">kfFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">printkfName</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generalized routine used to query datasets from Ken French&#39;s online library</span>
<span class="sd">        at a given frequency and for a given sample period. See subroutines for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        kfType : str</span>
<span class="sd">            Dataset type to query. Possible choices are:</span>

<span class="sd">                * ``Returns``</span>
<span class="sd">                * ``Factors``</span>
<span class="sd">                * ``NumFirms``</span>
<span class="sd">                * ``Characs``</span>
<span class="sd">        kfFreq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        kfDim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>
<span class="sd">        kfRetType : str, [optional]</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>
<span class="sd">        printkfName : bool</span>
<span class="sd">            Flag for choosing whether to print or not print the specific name of Ken French&#39;s data filename.</span>


<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfkf : pandas.DataFrame</span>
<span class="sd">            Cleaned dataset queried from Ken French&#39;s online library containing Fama-French-style factors,</span>
<span class="sd">            portfolio returns, number of firms in each portfolio, or `average` anomaly portfolio characteristics</span>
<span class="sd">            observed at frequency ``kfFreq`` over sample period from ``dt_start`` to ``dt_end``</span>
<span class="sd">            for a given portfolio sorting strategy.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">capitalize_nth</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

        <span class="c1"># Map &#39;kfFreq&#39; to appropriate string in the online library file names.</span>
        <span class="k">if</span> <span class="n">kfType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;Factors&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="s1">&#39;Characs&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                <span class="n">freq_kf</span> <span class="o">=</span> <span class="s1">&#39;_daily&#39;</span>
            <span class="k">elif</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                <span class="n">freq_kf</span> <span class="o">=</span> <span class="s1">&#39;_weekly&#39;</span>
            <span class="k">elif</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">]:</span>
                <span class="n">freq_kf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ken French library: </span><span class="se">\&#39;</span><span class="s1">kfFreq</span><span class="se">\&#39;</span><span class="s1"> is not a standard type.</span><span class="se">\n</span><span class="s1"> &#39;</span>
                                 <span class="s1">&#39;Please specify one of the following: </span><span class="se">\&#39;</span><span class="s1">D</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">W</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">M</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">A</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Ken French library: </span><span class="se">\&#39;</span><span class="s1">kfType</span><span class="se">\&#39;</span><span class="s1"> is not one of </span><span class="se">\&#39;</span><span class="s1">Returns</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Factors</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">NumFirms</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">Characs</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;Factors&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span> <span class="s1">&#39;RMW&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;F-F_Research_Data_Factors&#39;</span> <span class="o">+</span> <span class="n">freq_kf</span>
                <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                    <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;F-F_Research_Data_5_Factors_2x3&#39;</span> <span class="o">+</span> <span class="n">freq_kf</span>
                <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                    <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>

            <span class="k">if</span> <span class="s1">&#39;MKT-RF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">]</span>
                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;MKT-RF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;MOM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="c1"># Need try-except block since pandas-datareader.web has had issues in the past</span>
                <span class="c1"># pulling certain datasets from Ken French&#39;s online data library.</span>
                <span class="c1"># TODO: Verify if this issue has been resolved by pandas-datareader (see github)</span>
                <span class="kn">from</span> <span class="nn">dateutil.parser._parser</span> <span class="kn">import</span> <span class="n">ParserError</span>
                <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;F-F_Momentum_Factor&#39;</span> <span class="o">+</span> <span class="n">freq_kf</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ParserError</span><span class="p">):</span>
                    <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_kfpriorfactors_directly</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="n">kfFreq</span><span class="p">,</span> <span class="s1">&#39;MOM&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>

            <span class="k">if</span> <span class="s1">&#39;ST_Rev&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="c1"># Need try-except block since pandas-datareader.web has had issues in the past</span>
                <span class="c1"># pulling certain datasets from Ken French&#39;s online data library.</span>
                <span class="c1"># TODO: Verify if this issue has been resolved by pandas-datareader (see github)</span>
                <span class="kn">from</span> <span class="nn">dateutil.parser._parser</span> <span class="kn">import</span> <span class="n">ParserError</span>
                <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;F-F_ST_Reversal_Factor&#39;</span> <span class="o">+</span> <span class="n">freq_kf</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ST_Rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ST_Rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ParserError</span><span class="p">):</span>
                    <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ST_Rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_kfpriorfactors_directly</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="n">kfFreq</span><span class="p">,</span> <span class="s1">&#39;ST_Rev&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>

            <span class="k">if</span> <span class="s1">&#39;LT_Rev&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="c1"># Need try-except block since pandas-datareader.web has had issues in the past</span>
                <span class="c1"># pulling certain datasets from Ken French&#39;s online data library.</span>
                <span class="c1"># TODO: Verify if this issue has been resolved by pandas-datareader (see github)</span>
                <span class="kn">from</span> <span class="nn">dateutil.parser._parser</span> <span class="kn">import</span> <span class="n">ParserError</span>
                <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;F-F_LT_Reversal_Factor&#39;</span> <span class="o">+</span> <span class="n">freq_kf</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;LT_Rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;LT_Rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">ParserError</span><span class="p">):</span>
                    <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;LT_Rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_kfpriorfactors_directly</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="n">kfFreq</span><span class="p">,</span> <span class="s1">&#39;LT_Rev&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>

            <span class="k">if</span> <span class="s1">&#39;MKT-RF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">:</span>
                <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[[</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">factorsId</span><span class="p">]</span>

            <span class="c1"># Adjust index if frequency is daily or weekly.</span>
            <span class="k">if</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                    <span class="c1"># NOTE: Ken French&#39;s weekly datasets provide incorrect dates for some weeks prior to 1953.</span>
                    <span class="c1">#       Specifically, some weeks end on a Saturday, instead of the correct trading weekday.</span>
                    <span class="c1">#       An adjustment is made to correct for the error, assuming the only mistake is in the</span>
                    <span class="c1">#       the weekly dates provided by Ken French and not how the daily returns are cumulated</span>
                    <span class="c1">#       for the aforementioned weeks.</span>
                    <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday_name</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]),</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

                    <span class="c1"># NYSE trading day holiday calendar</span>
                    <span class="n">nyse_holidays</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nyse_cal</span><span class="o">.</span><span class="n">holidays</span><span class="p">()</span><span class="o">.</span><span class="n">holidays</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">])</span>
                    <span class="n">nyse_holidays</span> <span class="o">=</span> <span class="n">nyse_holidays</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">nyse_holidays</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">&gt;=</span> <span class="n">nyse_holidays</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)][</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nyse_holidays</span><span class="p">),</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
            <span class="n">dfkf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:</span><span class="n">dt_end</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">dfkf</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;Returns&#39;</span><span class="p">:</span>
                <span class="n">kfDim</span><span class="p">,</span> <span class="n">kfRetType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kfDim</span><span class="p">,</span> <span class="n">kfRetType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kfDim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Ken French library: Need # of elements in </span><span class="se">\&#39;</span><span class="s1">kfDim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;BM&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;Portfolios_Formed_on_BE-ME&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;PRIOR_2_12&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_Prior_12_2&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;PRIOR_1_1&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_Prior_1_0&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;PRIOR_13_60&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_Prior_60_13&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;EP&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;Portfolios_Formed_on_E-P&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;CFP&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;Portfolios_Formed_on_CF-P&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;DP&#39;</span><span class="p">]:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;Portfolios_Formed_on_D-P&#39;</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kfDataset</span> <span class="o">=</span> <span class="s1">&#39;Portfolios_Formed_on_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 30&#39;</span><span class="p">,</span> <span class="s1">&#39;Med 40&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 30&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                        <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;PRIOR&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">):</span>
                            <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo PRIOR&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;PRIOR &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pnum</span><span class="p">)</span> <span class="k">for</span> <span class="n">pnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Hi PRIOR&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Lo 10&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 5&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 6&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 7&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 8&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec 9&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 10&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">kfDim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type.&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">,</span> <span class="s1">&#39;BM&#39;</span><span class="p">]):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">freq_kf</span>
                            <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Dataset does not exist in Ken French</span><span class="se">\&#39;</span><span class="s1">s online library.&#39;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">,</span> <span class="s1">&#39;BM&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;BM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BM&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;BEME&#39;</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;PRIOR&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">):</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;PRIOR&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                            <span class="n">j_month</span><span class="p">,</span> <span class="n">k_month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s1">&#39;Prior_&#39;</span> <span class="o">+</span> <span class="n">k_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">j_month</span> <span class="o">==</span> <span class="s1">&#39;Prior_1_1&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Prior_1_0&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Prior_&#39;</span> <span class="o">+</span> <span class="n">k_month</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">j_month</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">freq_kf</span>
                                <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                                <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Dataset does not exist in Ken French</span><span class="se">\&#39;</span><span class="s1">s online library.&#39;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;BM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BM&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;BEME&#39;</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
                                        <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">freq_kf</span>
                            <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">kfDataset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">kfDim</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_Portfolios_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
                                            <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                            <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kfDim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">capitalize_nth</span><span class="p">(</span><span class="n">freq_kf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">dfkf_dict</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">kfDataset</span><span class="p">,</span> <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">RemoteDataError</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Dataset does not exist in Ken French</span><span class="se">\&#39;</span><span class="s1">s online library.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Dataset does not exist in Ken French</span><span class="se">\&#39;</span><span class="s1">s online library.&#39;</span><span class="p">)</span>

                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;Returns&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">kfRetType</span> <span class="o">==</span> <span class="s1">&#39;vw&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">kfRetType</span> <span class="o">==</span> <span class="s1">&#39;vw&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># % --&gt; decimals</span>

                <span class="k">elif</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># print(&#39;Dataset does not exist in Ken French\&#39;s online library.&#39;)</span>
                            <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># print(&#39;Dataset does not exist in Ken French\&#39;s online library.&#39;)</span>
                        <span class="k">pass</span>

                <span class="k">elif</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;Characs&#39;</span><span class="p">:</span>
                    <span class="n">re_prior</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;PRIOR_&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;[0-9]+&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;[0-9]+&#39;</span><span class="p">)</span>
                    <span class="n">prior_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re_prior</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">prior_list</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                    <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                    <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="c1"># if kfFreq in [&#39;M&#39;, &#39;Q&#39;, &#39;A&#39;]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                            <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;ME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;BM&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="s1">&#39;BM&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                            <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                            <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;BM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;BM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;OP&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="s1">&#39;OP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                            <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                            <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;OP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">):</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;OP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                            <span class="k">elif</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">):</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;OP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;OP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;INV&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="s1">&#39;INV&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                            <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                            <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;INV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">):</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;INV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                            <span class="k">elif</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">):</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;INV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;INV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;EP&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="s1">&#39;EP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">:</span>
                                                <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                                <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;EP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;EP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;CFP&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="s1">&#39;CFP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">:</span>
                                                <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                                <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                                <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;CFP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;CFP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;DP&#39;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                        <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;DP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                    <span class="k">pass</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prior_list</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                        <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                        <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                        <span class="n">dfkf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                        <span class="n">dfkf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;BETA&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                                        <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                        <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                        <span class="n">dfkf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">any_in</span><span class="p">([</span><span class="s1">&#39;AC&#39;</span><span class="p">,</span> <span class="s1">&#39;NI&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;AC&#39;</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;AC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;NI&#39;</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;NI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="s1">&#39;BETA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span> <span class="ow">and</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;BETA&#39;</span><span class="p">:</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="s1">&#39;BETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;VAR&#39;</span><span class="p">,</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsIdtmp</span><span class="p">:</span>
                                            <span class="c1"># Remove strange white space in front of potential column &#39;Med 40&#39;:</span>
                                            <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                                            <span class="n">dfkf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">cols_idx</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">dfkf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf_dict</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.99</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                <span class="k">if</span> <span class="n">printkfName</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ken French</span><span class="se">\&#39;</span><span class="s1">s dataset filename: &#39;</span> <span class="o">+</span> <span class="n">kfDataset</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">kfRetType</span> <span class="o">==</span> <span class="s1">&#39;Characs&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dfkf</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dfkf</span><span class="p">:</span>
                        <span class="c1"># Adjust index if frequency is daily or weekly</span>
                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                                <span class="c1"># NOTE: Ken French&#39;s weekly datasets provide incorrect dates for some weeks prior to 1953.</span>
                                <span class="c1">#       Specifically, some weeks end on a Saturday, instead of the correct trading weekday.</span>
                                <span class="c1">#       An adjustment is made to correct for the error, assuming the only mistake is in the</span>
                                <span class="c1">#       the weekly dates provided by Ken French and not how the daily returns are cumulated</span>
                                <span class="c1">#       for the aforementioned weeks.</span>
                                <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday_name</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]),</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                                <span class="c1"># NYSE trading day holiday calendar</span>
                                <span class="n">nyse_holidays</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nyse_cal</span><span class="o">.</span><span class="n">holidays</span><span class="p">()</span><span class="o">.</span><span class="n">holidays</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">])</span>
                                <span class="n">nyse_holidays</span> <span class="o">=</span> <span class="n">nyse_holidays</span><span class="p">[(</span><span class="n">dt_start</span> <span class="o">&lt;=</span> <span class="n">nyse_holidays</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">&gt;=</span> <span class="n">nyse_holidays</span><span class="p">[</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)][</span><span class="s1">&#39;nyse_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nyse_holidays</span><span class="p">),</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                            <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfkf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:</span><span class="n">dt_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Adjust index if frequency is daily or weekly</span>
                    <span class="k">if</span> <span class="n">kfFreq</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">kfFreq</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                            <span class="c1"># See most recent NOTE.</span>
                            <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday_name</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Saturday&#39;</span><span class="p">,</span> <span class="s1">&#39;Sunday&#39;</span><span class="p">]),</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
                    <span class="n">dfkf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">dfkf</span> <span class="o">=</span> <span class="n">dfkf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:</span><span class="n">dt_end</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">dfkf</span></div>

<div class="viewcode-block" id="FamaFrench.getkfPortfolioReturns"><a class="viewcode-back" href="../../kflibrary/generated/famafrench.FamaFrench.getkfPortfolioReturns.html#famafrench.FamaFrench.getkfPortfolioReturns">[docs]</a>    <span class="k">def</span> <span class="nf">getkfPortfolioReturns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query portfolio returns from Ken French&#39;s online library at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        dim : list, int</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>
<span class="sd">        retType : str</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>


<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        kfportRetTable: pandas.DataFrame</span>
<span class="sd">            Cleaned dataset queried from Ken French&#39;s online library containing portfolio returns</span>
<span class="sd">            observed at frequency ``freq`` over sample period from ``dt_start`` to ``dt_end``</span>
<span class="sd">            for a given portfolio sorting strategy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">retType</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Need # of elements in </span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kfportRetTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfLibrary</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">retType</span><span class="p">,</span> <span class="n">printkfName</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Remove days landing on Saturday or Sunday which can be found in Ken French&#39;s online datasets.</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                    <span class="n">kfportRetTable</span> <span class="o">=</span> <span class="n">kfportRetTable</span><span class="p">[(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">kfportRetTable</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
                <span class="k">return</span> <span class="n">kfportRetTable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">retType</span><span class="se">\&#39;</span><span class="s1"> is not a string w/ weighting scheme for portfolio returns.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="FamaFrench.getkfNumFirms"><a class="viewcode-back" href="../../kflibrary/generated/famafrench.FamaFrench.getkfNumFirms.html#famafrench.FamaFrench.getkfNumFirms">[docs]</a>    <span class="k">def</span> <span class="nf">getkfNumFirms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query number of firms in each portfolio from Ken French&#39;s online data library</span>
<span class="sd">        at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        dim : list, int</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>


<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        kfNFirmsTable: pandas.DataFrame</span>
<span class="sd">            Cleaned dataset queried from Ken French&#39;s online library containing number of firms in each</span>
<span class="sd">            portfolio observed at frequency ``freq`` over sample period from ``dt_start`` to ``dt_end``</span>
<span class="sd">            for a given portfolio sorting strategy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Need # of elements in </span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kfNFirmsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfLibrary</span><span class="p">(</span><span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">printkfName</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Remove days landing on Saturday or Sunday which can be found in Ken French&#39;s online datasets.</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                    <span class="n">kfNFirmsTable</span> <span class="o">=</span> <span class="n">kfNFirmsTable</span><span class="p">[(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">kfNFirmsTable</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
                <span class="k">return</span> <span class="n">kfNFirmsTable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="FamaFrench.getkfCharacs"><a class="viewcode-back" href="../../kflibrary/generated/famafrench.FamaFrench.getkfCharacs.html#famafrench.FamaFrench.getkfCharacs">[docs]</a>    <span class="k">def</span> <span class="nf">getkfCharacs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query `average` anomaly portfolio characteristics from Ken French&#39;s online library</span>
<span class="sd">        at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        dim : list, int</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        kfAvgCharacsTable: pandas.DataFrame</span>
<span class="sd">            Cleaned dataset queried from Ken French&#39;s online library containing `average` portfolio characteristics</span>
<span class="sd">            observed at frequency ``freq`` over sample period from ``dt_start`` to ``dt_end``</span>
<span class="sd">            for a given portfolio sorting strategy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;.</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Need # of elements in </span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> to match the # of elements in </span><span class="se">\&#39;</span><span class="s1">sortCharacsId </span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kfAvgCharacsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfLibrary</span><span class="p">(</span><span class="s1">&#39;Characs&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">printkfName</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Remove days landing on Saturday or Sunday which can be found in Ken French&#39;s online datasets.</span>
                <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                        <span class="n">kfAvgCharacsTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">kfAvgCharacsTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">kfAvgCharacsTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
                <span class="k">return</span> <span class="n">kfAvgCharacsTable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">dim</span><span class="se">\&#39;</span><span class="s1"> is not a list w/ the dimensions for each sort.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FamaFrench.getkfFFfactors"><a class="viewcode-back" href="../../kflibrary/generated/famafrench.FamaFrench.getkfFFfactors.html#famafrench.FamaFrench.getkfFFfactors">[docs]</a>    <span class="k">def</span> <span class="nf">getkfFFfactors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query Fama-French-style factors from Ken French&#39;s online library</span>
<span class="sd">        at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        freq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start : datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end : datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        kfffFactorsTable : pandas.DataFrame</span>
<span class="sd">            Cleaned dataset queried from Ken French&#39;s online library containing Fama-French-style factors</span>
<span class="sd">            observed at frequency ``freq`` over sample period from ``dt_start`` to ``dt_end``</span>
<span class="sd">            for a given portfolio sorting strategy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="n">kfffFactorsTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kfLibrary</span><span class="p">(</span><span class="s1">&#39;Factors&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">printkfName</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Remove days landing on Saturday or Sunday which can be found in Ken French&#39;s online datasets.</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
            <span class="n">kfffFactorsTable</span> <span class="o">=</span> <span class="n">kfffFactorsTable</span><span class="p">[(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">kfffFactorsTable</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">weekday</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">kfffFactorsTable</span></div>


<div class="viewcode-block" id="FamaFrench.comparePortfolios"><a class="viewcode-back" href="../../statistics-diagnostics/generated/famafrench.FamaFrench.comparePortfolios.html#famafrench.FamaFrench.comparePortfolios">[docs]</a>    <span class="nd">@utils</span><span class="o">.</span><span class="n">timing</span>
    <span class="k">def</span> <span class="nf">comparePortfolios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kfType</span><span class="p">,</span> <span class="n">kfFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generalized routine used to compare datasets constructed from `wrds-cloud` queries</span>
<span class="sd">        to their equivalents made publicly available on</span>
<span class="sd">        `Ken French&#39;s online library &lt;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html&gt;`_</span>
<span class="sd">        at a given frequency and for a given sample period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ___________</span>
<span class="sd">        kfType : str</span>
<span class="sd">            Dataset type to query. Possible choices are:</span>

<span class="sd">                * ``Returns``</span>
<span class="sd">                * ``Factors``</span>
<span class="sd">                * ``NumFirms``</span>
<span class="sd">                * ``Characs``</span>
<span class="sd">        kfFreq : str</span>
<span class="sd">            Observation frequency of the portfolios. Possible choices are:</span>

<span class="sd">                * ``D`` : daily</span>
<span class="sd">                * ``W`` : weekly</span>
<span class="sd">                * ``M`` : monthly</span>
<span class="sd">                * ``Q`` : quarterly (3-months)</span>
<span class="sd">                * ``A`` : annual</span>
<span class="sd">        dt_start: datetime.date</span>
<span class="sd">            Starting date for the dataset queried or locally retrieved.</span>
<span class="sd">        dt_end: datetime.date</span>
<span class="sd">            Ending date for the dataset queried or locally retrieved.</span>
<span class="sd">        kfDim : list, int, [optional]</span>
<span class="sd">            Dimensions for sorting on each element in the list ``self.sortCharacsId``.</span>
<span class="sd">        kfRetType : str, [optional]</span>
<span class="sd">            Weighting-scheme for portfolios. Possible choices are:</span>

<span class="sd">                * ``vw`` : value-weights</span>
<span class="sd">                * ``ew`` : equal-weights</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        dfcorrTable : `pandas.DataFrame` or `list`, `pandas.DataFrame` if ``len(kfDim) == 3``</span>
<span class="sd">            Table w/ `Pearson correlations` between `wrds-cloud` constructed and Ken French online library portfolio variables</span>
<span class="sd">            at a given frequency and over a given sample period.</span>
<span class="sd">        dfmeanTable :` pandas.DataFrame` or `list`, `pandas.DataFrame` if ``len(kfDim) == 3``</span>
<span class="sd">            Table w/ `mean statistics` for `wrds-cloud` constructed and Ken French online library portfolio variables</span>
<span class="sd">            at a given frequency and over a given sample period.</span>
<span class="sd">        dfstdevTable : `pandas.DataFrame` or `list`, `pandas.DataFrame` if ``len(kfDim) == 3``</span>
<span class="sd">            Table w/ `standard deviation` statistics for `wrds-cloud` constructed and Ken French online library portfolio variables</span>
<span class="sd">            at a given frequency and over a given sample period.</span>

<span class="sd">        Note</span>
<span class="sd">        ______</span>
<span class="sd">        The routine is &quot;wrapped&quot; w/ the user-defined function ``timing()`` from module ``famafrench.utils.py``.</span>
<span class="sd">        This wrapper times (in seconds) how long the routine takes to complete.</span>

<span class="sd">        Note</span>
<span class="sd">        _____</span>
<span class="sd">        Portfolios require anomaly characteristics from the last fiscal year.</span>
<span class="sd">        To get non-missing observations starting on date ``dt_start``, we construct portfolios using a startdate that is two/three years prior to ``dt_start``.</span>
<span class="sd">        We then slice the resulting pandas.DataFrames starting w/ ``dt_start``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if &#39;dt_start&#39; and/or &#39;dt_end&#39; are trading dates:</span>
        <span class="c1"># If they are, leave as is, else, get the trading date after &#39;dt_start&#39; and/or the trading date before &#39;dt_end&#39;.</span>
        <span class="n">check_start</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_start</span><span class="p">)</span>
        <span class="n">check_end</span> <span class="o">=</span> <span class="n">nyse_cal</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">dt_end</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_start</span> <span class="o">+</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_end</span> <span class="o">-</span> <span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Factor&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span>
            <span class="k">if</span> <span class="n">dType</span> <span class="o">==</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;Factors&#39;</span><span class="p">:</span>
            <span class="n">portTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFFfactors</span><span class="p">(</span><span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">)</span>
            <span class="n">kfportTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkfFFfactors</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">)</span>
            <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mi">100</span>

            <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
            <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
            <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
            <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">dfcorrTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">c</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">portTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">kfportTable</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">portTable</span><span class="o">.</span><span class="n">columns</span><span class="p">)}],</span> <span class="n">columns</span><span class="o">=</span><span class="n">portTable</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;corr:&#39;</span><span class="p">])</span>
            <span class="n">dfmeanTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">portTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">formatting</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfportTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                         <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">portTable</span><span class="o">.</span><span class="n">columns</span><span class="p">)}],</span> <span class="n">columns</span><span class="o">=</span><span class="n">portTable</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;[wrds, kflib]:&#39;</span><span class="p">])</span>
            <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">portTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">formatting</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfportTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">portTable</span><span class="o">.</span><span class="n">columns</span><span class="p">)}],</span> <span class="n">columns</span><span class="o">=</span><span class="n">portTable</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;[wrds, kflib]:&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** Factor Returns:&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;***********************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fama-French factors: Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fama-French factors: Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fama-French factors: Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span>

        <span class="k">elif</span> <span class="n">kfType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">,</span> <span class="s1">&#39;Characs&#39;</span><span class="p">]:</span>
            <span class="n">kfDim</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;Returns&#39;</span><span class="p">:</span>
                <span class="n">kfRetType</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">portTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPortfolioReturns</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">,</span> <span class="n">kfRetType</span><span class="p">)</span>
                <span class="n">kfportTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkfPortfolioReturns</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">,</span> <span class="n">kfRetType</span><span class="p">)</span>
                <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="k">elif</span> <span class="n">kfType</span> <span class="o">==</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">:</span>
                <span class="n">portTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumFirms</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                <span class="n">kfportTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkfNumFirms</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">portTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCharacs</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_start</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                    <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span> <span class="p">]</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_start</span><span class="p">:]</span>
                <span class="n">kfportTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkfCharacs</span><span class="p">(</span><span class="n">kfFreq</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>


            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kfDim</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="c1"># Univariate sort</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kfDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># (i) 30-70 sorts, (ii) quintiles, (iii) deciles</span>
                    <span class="k">if</span> <span class="n">kfDim</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">]]:</span>
                        <span class="c1"># Here, we use the fact that the order of the column labels in &#39;portTable&#39; is consistent w/ the</span>
                        <span class="c1"># order of the column lables in &#39;kfportTable&#39;. If this changes in the future, then this part of the</span>
                        <span class="c1"># code should change accordingly.</span>
                        <span class="k">if</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0-30&#39;</span><span class="p">,</span> <span class="s1">&#39;30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;70-100&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                            <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0-20&#39;</span><span class="p">,</span> <span class="s1">&#39;20-40&#39;</span><span class="p">,</span> <span class="s1">&#39;40-60&#39;</span><span class="p">,</span> <span class="s1">&#39;60-80&#39;</span><span class="p">,</span> <span class="s1">&#39;80-100&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span>
                            <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0-10&#39;</span><span class="p">,</span> <span class="s1">&#39;10-20&#39;</span><span class="p">,</span> <span class="s1">&#39;20-30&#39;</span><span class="p">,</span> <span class="s1">&#39;30-40&#39;</span><span class="p">,</span> <span class="s1">&#39;40-50&#39;</span><span class="p">,</span> <span class="s1">&#39;50-60&#39;</span><span class="p">,</span> <span class="s1">&#39;60-70&#39;</span><span class="p">,</span> <span class="s1">&#39;70-80&#39;</span><span class="p">,</span> <span class="s1">&#39;80-90&#39;</span><span class="p">,</span> <span class="s1">&#39;90-100&#39;</span><span class="p">]</span>

                        <span class="k">def</span> <span class="nf">univariateSortTable</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="n">pTable</span><span class="p">,</span> <span class="n">kfpTable</span><span class="p">,</span> <span class="n">pSorts</span><span class="p">,</span> <span class="n">pDim</span><span class="p">):</span>
                            <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span> <span class="o">+</span> <span class="n">value1</span> <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span>
                                        <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">,</span> <span class="n">pSorts</span><span class="p">)]</span>
                            <span class="n">kfpTable</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols_idx</span>
                            <span class="n">corrTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">c</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">)}],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;corr:&#39;</span><span class="p">])</span>
                            <span class="n">meanTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">)}],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;[wrds, kflib]:&#39;</span><span class="p">])</span>
                            <span class="n">stdevTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">)}],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;[wrds, kflib]:&#39;</span><span class="p">])</span>
                            <span class="k">return</span> <span class="n">corrTable</span><span class="p">,</span> <span class="n">meanTable</span><span class="p">,</span> <span class="n">stdevTable</span>

                        <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">kfType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
                                    <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
                                    <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                                    <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                                    <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="n">univariateSortTable</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="n">portTable</span><span class="p">,</span> <span class="n">kfportTable</span><span class="p">,</span> <span class="n">pbuckets</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *************************&#39;</span><span class="p">,</span> <span class="n">kfType</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;**************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">):</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   *******************************&#39;</span><span class="p">,</span> <span class="n">kfType</span> <span class="o">+</span> <span class="s1">&#39; *******************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ******************************* NOT AVAILABLE *****************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
                                    <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
                                    <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][</span><span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                                    <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                                    <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">univariateSortTable</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">kfportTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">pbuckets</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ************************* (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">charac</span> <span class="o">+</span> <span class="s1">&#39;):&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;***************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">):</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ************************** (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">charac</span> <span class="o">+</span> <span class="s1">&#39;) ***************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ******************************* NOT AVAILABLE *****************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                        <span class="k">return</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">kfDim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type&#39;</span><span class="p">)</span>
                <span class="c1"># Bivariate sort</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kfDim</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]]:</span>
                        <span class="c1"># (i) median splits x 30-70 sorts</span>
                        <span class="k">if</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                            <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;0-50&#39;</span><span class="p">,</span> <span class="s1">&#39;50-100&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;0-30&#39;</span><span class="p">,</span> <span class="s1">&#39;30-70&#39;</span><span class="p">,</span> <span class="s1">&#39;70-100&#39;</span><span class="p">]]</span>

                            <span class="k">def</span> <span class="nf">bivariateSortTable</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="n">pTable</span><span class="p">,</span> <span class="n">kfpTable</span><span class="p">,</span> <span class="n">pSorts</span><span class="p">,</span> <span class="n">pDim</span><span class="p">):</span>
                                <span class="n">rows_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span> <span class="o">+</span> <span class="n">value1</span> <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                                <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id2</span> <span class="o">+</span> <span class="n">value2</span> <span class="k">for</span> <span class="n">id2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">corrTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span>
                                <span class="n">meanTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span>
                                <span class="n">stdevTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span>

                                <span class="k">def</span> <span class="nf">rowLabelReplace</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">row_id</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">row_id</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                        <span class="n">row_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50&#39;</span><span class="p">)</span>
                                        <span class="n">row_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="s1">&#39;prior&#39;</span> <span class="ow">in</span> <span class="n">row_id</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                        <span class="n">row_id_tmp</span> <span class="o">=</span> <span class="s1">&#39;prior&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">row_id_tmp</span> <span class="o">=</span> <span class="n">row_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">row_id_tmp</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">row_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-50&#39;</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">)</span>
                                    <span class="n">row_idx</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">row_id_tmp</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">row_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;50-100&#39;</span><span class="p">,</span> <span class="n">row_idx</span><span class="p">)</span>
                                    <span class="n">row_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;lo&#39;</span> <span class="o">+</span> <span class="n">row_id_tmp</span><span class="p">,</span> <span class="n">row_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-50&#39;</span><span class="p">)</span>
                                    <span class="n">row_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row_idx</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;hi&#39;</span> <span class="o">+</span> <span class="n">row_id_tmp</span><span class="p">,</span> <span class="n">row_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;50-100&#39;</span><span class="p">)</span>
                                    <span class="k">return</span> <span class="n">row_idx</span>

                                <span class="k">def</span> <span class="nf">colLabelReplace</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="n">col_id</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="s1">&#39;prior&#39;</span> <span class="ow">in</span> <span class="n">col_id</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                        <span class="n">col_id_tmp</span> <span class="o">=</span> <span class="s1">&#39;prior&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">col_id_tmp</span> <span class="o">=</span> <span class="n">col_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                    <span class="n">col_idx</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">col_id_tmp</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">col_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;30-70&#39;</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">)</span>
                                    <span class="n">col_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;lo&#39;</span> <span class="o">+</span> <span class="n">col_id_tmp</span><span class="p">,</span> <span class="n">col_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-30&#39;</span><span class="p">)</span>
                                    <span class="n">col_idx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">col_idx</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;hi&#39;</span> <span class="o">+</span> <span class="n">col_id_tmp</span><span class="p">,</span> <span class="n">col_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;70-100&#39;</span><span class="p">)</span>
                                    <span class="k">return</span> <span class="n">col_idx</span>

                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">kfpTable</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                                    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                                    <span class="n">row</span> <span class="o">=</span> <span class="n">rowLabelReplace</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">col</span> <span class="o">=</span> <span class="n">colLabelReplace</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">corrTable</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
                                        <span class="n">meanTable</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                                                  <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                        <span class="n">stdevTable</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                                                   <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Portfolio </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> is not found in </span><span class="se">\&#39;</span><span class="s1">portTable</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
                                        <span class="k">continue</span>
                                <span class="k">return</span> <span class="n">corrTable</span><span class="p">,</span> <span class="n">meanTable</span><span class="p">,</span> <span class="n">stdevTable</span>

                        <span class="c1"># (ii) quintile sorts x quintile sorts, (iii) decile sorts x decile sorts.</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
                                <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;0-20&#39;</span><span class="p">,</span> <span class="s1">&#39;20-40&#39;</span><span class="p">,</span> <span class="s1">&#39;40-60&#39;</span><span class="p">,</span> <span class="s1">&#39;60-80&#39;</span><span class="p">,</span> <span class="s1">&#39;80-100&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;0-10&#39;</span><span class="p">,</span> <span class="s1">&#39;10-20&#39;</span><span class="p">,</span> <span class="s1">&#39;20-30&#39;</span><span class="p">,</span> <span class="s1">&#39;30-40&#39;</span><span class="p">,</span> <span class="s1">&#39;40-50&#39;</span><span class="p">,</span> <span class="s1">&#39;50-60&#39;</span><span class="p">,</span> <span class="s1">&#39;60-70&#39;</span><span class="p">,</span> <span class="s1">&#39;70-80&#39;</span><span class="p">,</span> <span class="s1">&#39;80-90&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;90-100&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span>

                            <span class="k">def</span> <span class="nf">bivariateSortTable</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="n">pTable</span><span class="p">,</span> <span class="n">kfpTable</span><span class="p">,</span> <span class="n">pSorts</span><span class="p">,</span> <span class="n">pDim</span><span class="p">):</span>
                                <span class="n">rows_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span> <span class="o">+</span> <span class="n">value1</span> <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                                <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id2</span> <span class="o">+</span> <span class="n">value2</span> <span class="k">for</span> <span class="n">id2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                <span class="n">corrTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span>
                                <span class="n">meanTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span>
                                <span class="n">stdevTable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span>

                                <span class="k">def</span> <span class="nf">labelReplace</span><span class="p">(</span><span class="n">pDim_sort</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">,</span> <span class="n">id_df</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">pDim_sort</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">id_df</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                            <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-20&#39;</span><span class="p">)</span>
                                            <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="s1">&#39;me80-100&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="s1">&#39;prior&#39;</span> <span class="ow">in</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                            <span class="n">id_df_tmp</span> <span class="o">=</span> <span class="s1">&#39;prior&#39;</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">id_df_tmp</span> <span class="o">=</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-20&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;20-40&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;3&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;40-60&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;4&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;60-80&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;80-100&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;lo&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-20&#39;</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;hi&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;80-100&#39;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">id_df</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                            <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-10&#39;</span><span class="p">)</span>
                                            <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="s1">&#39;me90-100&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="s1">&#39;prior&#39;</span> <span class="ow">in</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                            <span class="n">id_df_tmp</span> <span class="o">=</span> <span class="s1">&#39;prior&#39;</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">id_df_tmp</span> <span class="o">=</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;10&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;90-100&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-10&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;10-20&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;3&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;20-30&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;4&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;30-40&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;5&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;40-50&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;6&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;50-60&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;7&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;60-70&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;8&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;70-80&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span> <span class="o">+</span> <span class="s1">&#39;9&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;80-90&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;lo&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-10&#39;</span><span class="p">)</span>
                                        <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;hi&#39;</span> <span class="o">+</span> <span class="n">id_df_tmp</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;90-100&#39;</span><span class="p">)</span>
                                    <span class="k">return</span> <span class="n">idx_df</span>

                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">kfpTable</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                                    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                                    <span class="n">row</span> <span class="o">=</span> <span class="n">labelReplace</span><span class="p">(</span><span class="n">pDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">col</span> <span class="o">=</span> <span class="n">labelReplace</span><span class="p">(</span><span class="n">pDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">corrTable</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
                                        <span class="n">meanTable</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                                                  <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                        <span class="n">stdevTable</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                                                   <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Portfolio </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> is not found in </span><span class="se">\&#39;</span><span class="s1">portTable</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
                                        <span class="k">continue</span>
                                <span class="k">return</span> <span class="n">corrTable</span><span class="p">,</span> <span class="n">meanTable</span><span class="p">,</span> <span class="n">stdevTable</span>

                        <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">kfType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
                                    <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
                                    <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                                    <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                                    <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="n">bivariateSortTable</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="n">portTable</span><span class="p">,</span> <span class="n">kfportTable</span><span class="p">,</span> <span class="n">pbuckets</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *************************&#39;</span><span class="p">,</span> <span class="n">kfType</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;**************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">):</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   *******************************&#39;</span><span class="p">,</span> <span class="n">kfType</span> <span class="o">+</span> <span class="s1">&#39; *******************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ******************************* NOT AVAILABLE *****************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
                                    <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
                                    <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][</span><span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                                    <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                                    <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">bivariateSortTable</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">kfportTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">pbuckets</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ************************* (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">charac</span> <span class="o">+</span> <span class="s1">&#39;):&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;***************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">):</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ************************* (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">charac</span> <span class="o">+</span> <span class="s1">&#39;) ***************************&#39;</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ******************************* NOT AVAILABLE *****************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>
                        <span class="k">return</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">kfDim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type&#39;</span><span class="p">)</span>
            <span class="c1"># Trivariate sort</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kfDim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># (i) median splits x quartile sorts x quartile sorts</span>
                <span class="k">if</span> <span class="n">kfDim</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                    <span class="n">pbuckets</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;0-50&#39;</span><span class="p">,</span> <span class="s1">&#39;50-100&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;0-25&#39;</span><span class="p">,</span> <span class="s1">&#39;25-50&#39;</span><span class="p">,</span> <span class="s1">&#39;50-75&#39;</span><span class="p">,</span> <span class="s1">&#39;75-100&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;0-25&#39;</span><span class="p">,</span> <span class="s1">&#39;25-50&#39;</span><span class="p">,</span> <span class="s1">&#39;50-75&#39;</span><span class="p">,</span> <span class="s1">&#39;75-100&#39;</span><span class="p">]]</span>

                    <span class="k">def</span> <span class="nf">trivariateSortTable</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="n">pTable</span><span class="p">,</span> <span class="n">kfpTable</span><span class="p">,</span> <span class="n">pSorts</span><span class="p">,</span> <span class="n">pDim</span><span class="p">):</span>
                        <span class="n">level0_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id1</span> <span class="o">+</span> <span class="n">value1</span> <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">value1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="n">rows_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id2</span> <span class="o">+</span> <span class="n">value2</span> <span class="k">for</span> <span class="n">id2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">cols_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">id3</span> <span class="o">+</span> <span class="n">value3</span> <span class="k">for</span> <span class="n">id3</span><span class="p">,</span> <span class="n">value3</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">2</span><span class="p">]]))</span> <span class="o">*</span> <span class="n">pDim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pSorts</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
                        <span class="n">corrTable</span> <span class="o">=</span> <span class="p">{</span><span class="n">level0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">level0_idx</span><span class="p">)}</span>
                        <span class="n">meanTable</span> <span class="o">=</span> <span class="p">{</span><span class="n">level0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">level0_idx</span><span class="p">)}</span>
                        <span class="n">stdevTable</span> <span class="o">=</span> <span class="p">{</span><span class="n">level0</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rows_idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">level0_idx</span><span class="p">)}</span>

                        <span class="k">def</span> <span class="nf">labelReplace</span><span class="p">(</span><span class="n">pDim_sort</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">,</span> <span class="n">id_df</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">pDim_sort</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">id_df</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                    <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-50&#39;</span><span class="p">)</span>
                                    <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="s1">&#39;me50-100&#39;</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-50&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;50-100&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;lo&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-50&#39;</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;hi&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;50-100&#39;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">idx_df</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">id_df</span> <span class="o">==</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span>
                                    <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;me0-25&#39;</span><span class="p">)</span>
                                    <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="s1">&#39;me75-100&#39;</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-25&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;25-50&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;3&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;50-75&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;4&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;75-100&#39;</span><span class="p">,</span> <span class="n">idx_df</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;lo&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;0-25&#39;</span><span class="p">)</span>
                                <span class="n">idx_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)(</span><span class="s1">&#39;hi&#39;</span> <span class="o">+</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">id_df</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;75-100&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">idx_df</span>

                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">kfpTable</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                            <span class="n">level0</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">level0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                <span class="n">level0</span> <span class="o">=</span> <span class="n">level0</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s1">&#39;var&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RESVAR&#39;</span><span class="p">:</span>
                                <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;resvar&#39;</span><span class="p">)</span>
                            <span class="n">level0</span> <span class="o">=</span> <span class="n">labelReplace</span><span class="p">(</span><span class="n">pDim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">level0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">labelReplace</span><span class="p">(</span><span class="n">pDim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="n">labelReplace</span><span class="p">(</span><span class="n">pDim</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">corrTable</span><span class="p">[</span><span class="n">level0</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
                                <span class="n">meanTable</span><span class="p">[</span><span class="n">level0</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                                                  <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                                <span class="n">stdevTable</span><span class="p">[</span><span class="n">level0</span><span class="p">]</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">pTable</span><span class="p">[</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                                                   <span class="n">formatting</span><span class="p">(</span><span class="n">dType</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">kfpTable</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Portfolio </span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1"> is not found in </span><span class="se">\&#39;</span><span class="s1">portTable</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
                                <span class="k">continue</span>
                        <span class="c1"># NOTE: Unlike the first two cases w/ len(kfDim)==1 or ==2,</span>
                        <span class="c1">#       here &#39;dfcorrTable&#39;, &#39;dfmeanTable&#39;, and &#39;dfstdevTable&#39; will be lists of dataframes</span>
                        <span class="k">return</span> <span class="n">corrTable</span><span class="p">,</span> <span class="n">meanTable</span><span class="p">,</span> <span class="n">stdevTable</span>

                    <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">kfType</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;NumFirms&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
                                <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
                                <span class="n">portTable</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                                <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                                <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span> <span class="o">=</span> <span class="n">trivariateSortTable</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="n">portTable</span><span class="p">,</span> <span class="n">kfportTable</span><span class="p">,</span> <span class="n">pbuckets</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ***********************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *************************&#39;</span><span class="p">,</span> <span class="n">kfType</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;**************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="p">{</span><span class="nb">print</span><span class="p">(</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">level0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfcorrTable</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="p">{</span><span class="nb">print</span><span class="p">(</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">level0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfmeanTable</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="p">{</span><span class="nb">print</span><span class="p">(</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">level0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfstdevTable</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   *******************************&#39;</span><span class="p">,</span> <span class="n">kfType</span> <span class="o">+</span> <span class="s1">&#39; *******************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ******************************* NOT AVAILABLE *****************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">charac</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mainCharacsId</span><span class="p">)):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Restrict index in &#39;portTable&#39; to coincide w/ that of &#39;kfportTable&#39;.</span>
                                <span class="c1"># Get &#39;min&#39; and &#39;max&#39; date:</span>
                                <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][</span><span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kfportTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                                <span class="n">min_date</span><span class="p">,</span> <span class="n">max_date</span> <span class="o">=</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                                <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span> <span class="o">=</span> <span class="n">trivariateSortTable</span><span class="p">(</span><span class="n">kfType</span><span class="p">,</span> <span class="n">portTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">kfportTable</span><span class="p">[</span><span class="n">charac</span><span class="p">],</span> <span class="n">pbuckets</span><span class="p">,</span> <span class="n">kfDim</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ************************* (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">charac</span> <span class="o">+</span> <span class="s1">&#39;):&#39;</span><span class="p">,</span> <span class="n">min_date</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">max_date</span><span class="p">,</span> <span class="s1">&#39;***************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="p">{</span><span class="nb">print</span><span class="p">(</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][</span><span class="n">level0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span>
                                 <span class="nb">list</span><span class="p">(</span><span class="n">dfcorrTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="p">{</span><span class="nb">print</span><span class="p">(</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][</span><span class="n">level0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span>
                                 <span class="nb">list</span><span class="p">(</span><span class="n">dfmeanTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Std Deviation matrix:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="p">{</span><span class="nb">print</span><span class="p">(</span><span class="n">level0</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">][</span><span class="n">level0</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">level0</span> <span class="ow">in</span>
                                 <span class="nb">list</span><span class="p">(</span><span class="n">dfstdevTable</span><span class="p">[</span><span class="n">charac</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">UnboundLocalError</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*********************************** &#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortCharacsId</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="s1">&#39; x &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kfDim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) ************************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    *********************** Observation frequency: &#39;</span> <span class="o">+</span> <span class="n">kfFreq</span> <span class="o">+</span> <span class="s1">&#39; ************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ************************* (Characteristic: &#39;</span> <span class="o">+</span> <span class="n">charac</span> <span class="o">+</span> <span class="s1">&#39;) ***************************&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   ******************************* NOT AVAILABLE *****************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">continue</span>
                    <span class="k">return</span> <span class="n">dfcorrTable</span><span class="p">,</span> <span class="n">dfmeanTable</span><span class="p">,</span> <span class="n">dfstdevTable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">kfDim</span><span class="se">\&#39;</span><span class="s1"> is not a standard type&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">kfDim</span><span class="se">\&#39;</span><span class="s1"> is not of standard length: should be 1, 2, or 3.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">kfType</span><span class="se">\&#39;</span><span class="s1"> is not one of </span><span class="se">\&#39;</span><span class="s1">Returns</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">Factors</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="s1">NumFirms</span><span class="se">\&#39;</span><span class="s1">, or </span><span class="se">\&#39;</span><span class="s1">Characs</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Christian Jauregui

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>